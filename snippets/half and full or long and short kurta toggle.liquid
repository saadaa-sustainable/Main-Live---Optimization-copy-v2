{% comment %} {%- comment -%}
  Normalize product title:
{%- endcomment -%}
{% assign normalized_title = product.title | downcase | replace: '
', ' ' | replace: '  ', ' ' | replace: '  ', ' ' %}

{%- comment -%}
  Detect product type (more tolerant)
{%- endcomment -%}
{% assign is_shirt = false %}
{% assign is_full_sleeve = false %}
{% assign is_half_sleeve = false %}
{% assign is_kurta = false %}
{% assign is_short_kurta = false %}
{% assign is_long_kurta = false %}
{% assign is_pant = false %}
{% assign is_straight_pant = false %}
{% assign is_wide_leg_pant = false %}

{% comment %} /* Shirt detection */ {% endcomment %}
{% if normalized_title contains 'shirt' %}
  {% assign is_shirt = true %}
{% endif %}
{% if normalized_title contains 'full sleeve' %}
  {% assign is_full_sleeve = true %}
{% endif %}
{% if normalized_title contains 'short sleeve' or normalized_title contains 'half sleeve' %}
  {% assign is_half_sleeve = true %}
{% endif %}

{% comment %} /* Kurtas */ {% endcomment %}
{% if normalized_title contains 'short kurta' %}
  {% assign is_kurta = true %}{% assign is_short_kurta = true %}
{% endif %}
{% if normalized_title contains 'long kurta' %}
  {% assign is_kurta = true %}{% assign is_long_kurta = true %}
{% endif %}

{% comment %} /* Pants */ {% endcomment %}
{% if normalized_title contains 'straight pant' %}
  {% assign is_pant = true %}{% assign is_straight_pant = true %}
{% endif %}
{% if normalized_title contains 'wide leg pant' or normalized_title contains 'wide-leg pant' %}
  {% assign is_pant = true %}{% assign is_wide_leg_pant = true %}
{% endif %}

{%- comment -%}
  Collar detection (Women 100% linen shirt / notch collar shirt)
{%- endcomment -%}
{% assign is_regular_collar = false %}
{% assign is_notch_collar = false %}

{%- comment -%} Notch collar if explicitly mentioned {%- endcomment -%}
{% if normalized_title contains 'notch collar' and normalized_title contains 'shirt' %}
  {% assign is_notch_collar = true %}
{% endif %}

{%- comment -%} Otherwise, any shirt (that isn't notch) is "regular collar" {%- endcomment -%}
{% if normalized_title contains 'shirt' and is_notch_collar == false %}
  {% assign is_regular_collar = true %}
{% endif %}

{%- comment -%}
  Product reference metafields
{%- endcomment -%}
{% assign full_sleeve_product = product.metafields.custom.full_sleeve_toggle_link1.value %}
{% assign half_sleeve_product = product.metafields.custom.half_sleeve_toggle_link1.value %}
{% assign short_kurta_product = product.metafields.custom.short_kurta_toggle_link1.value %}
{% assign long_kurta_product = product.metafields.custom.long_kurta_toggle_link1.value %}
{% assign straight_pant_product = product.metafields.custom.straight_pant_toggle_product.value %}
{% assign wide_leg_pant_product = product.metafields.custom.wide_leg_pant_toggle_product.value %}

{%- comment -%} Length metafields (Product references) {%- endcomment -%}
{% assign short_length_product     = product.metafields.custom.short_length.value %}
{% assign mid_thigh_length_product = product.metafields.custom.mid_thigh_length.value %}

{%- comment -%} Fit metafields (Product references) {%- endcomment -%}
{% assign regular_fit_product  = product.metafields.custom.regular_fit_product_toggle.value %}
{% assign straight_fit_product = product.metafields.custom.straight_fit_product_toggle.value %}

{%- comment -%}
  Collar metafields
{%- endcomment -%}
{% assign regular_collar_product = product.metafields.custom.regular_collar_product_toggles.value %}
{% assign notch_collar_product = product.metafields.custom.notch_collar_product_toggles.value %}

{%- comment -%}
  Draft check
{%- endcomment -%}
{% assign is_draft = false %}
{% if product.status and product.status == 'draft' %}{% assign is_draft = true %}{% endif %}

{% assign full_sleeve_is_draft = false %}
{% if full_sleeve_product and full_sleeve_product.status == 'draft' %}{% assign full_sleeve_is_draft = true %}{% endif %}

{% assign half_sleeve_is_draft = false %}
{% if half_sleeve_product and half_sleeve_product.status == 'draft' %}{% assign half_sleeve_is_draft = true %}{% endif %}

{% assign short_kurta_is_draft = false %}
{% if short_kurta_product and short_kurta_product.status == 'draft' %}{% assign short_kurta_is_draft = true %}{% endif %}

{% assign long_kurta_is_draft = false %}
{% if long_kurta_product and long_kurta_product.status == 'draft' %}{% assign long_kurta_is_draft = true %}{% endif %}

{% assign straight_pant_is_draft = false %}
{% if straight_pant_product and straight_pant_product.status == 'draft' %}{% assign straight_pant_is_draft = true %}{% endif %}

{% assign wide_leg_pant_is_draft = false %}
{% if wide_leg_pant_product and wide_leg_pant_product.status == 'draft' %}{% assign wide_leg_pant_is_draft = true %}{% endif %}

{%- comment -%} Length draft flags {%- endcomment -%}
{% assign short_length_is_draft = false %}
{% if short_length_product and short_length_product.status == 'draft' %}{% assign short_length_is_draft = true %}{% endif %}

{% assign mid_thigh_length_is_draft = false %}
{% if mid_thigh_length_product and mid_thigh_length_product.status == 'draft' %}{% assign mid_thigh_length_is_draft = true %}{% endif %}

{%- comment -%} Fit draft flags {%- endcomment -%}
{% assign regular_fit_is_draft = false %}
{% if regular_fit_product and regular_fit_product.status == 'draft' %}{% assign regular_fit_is_draft = true %}{% endif %}

{% assign straight_fit_is_draft = false %}
{% if straight_fit_product and straight_fit_product.status == 'draft' %}{% assign straight_fit_is_draft = true %}{% endif %}

{%- comment -%}
  Collar draft flags
{%- endcomment -%}
{% assign regular_collar_is_draft = false %}
{% if regular_collar_product and regular_collar_product.status == 'draft' %}{% assign regular_collar_is_draft = true %}{% endif %}

{% assign notch_collar_is_draft = false %}
{% if notch_collar_product and notch_collar_product.status == 'draft' %}{% assign notch_collar_is_draft = true %}{% endif %}

{%- comment -%}
  Compute “valid target exists” flags (avoid parentheses in IFs)
{%- endcomment -%}
{% assign has_full_valid = false %}
{% if full_sleeve_product and full_sleeve_is_draft == false %}
  {% assign has_full_valid = true %}
{% endif %}

{% assign has_half_valid = false %}
{% if half_sleeve_product and half_sleeve_is_draft == false %}
  {% assign has_half_valid = true %}
{% endif %}

{% assign has_regular_collar_valid = false %}
{% if regular_collar_product and regular_collar_is_draft == false %}
  {% assign has_regular_collar_valid = true %}
{% endif %}

{% assign has_notch_collar_valid = false %}
{% if notch_collar_product and notch_collar_is_draft == false %}
  {% assign has_notch_collar_valid = true %}
{% endif %}

{%- comment -%} Length valid flags {%- endcomment -%}
{% assign has_short_length_valid = false %}
{% if short_length_product and short_length_is_draft == false %}
  {% assign has_short_length_valid = true %}
{% endif %}

{% assign has_mid_thigh_length_valid = false %}
{% if mid_thigh_length_product and mid_thigh_length_is_draft == false %}
  {% assign has_mid_thigh_length_valid = true %}
{% endif %}

{%- comment -%} Fit valid flags {%- endcomment -%}
{% assign has_regular_fit_valid = false %}
{% if regular_fit_product and regular_fit_is_draft == false %}
  {% assign has_regular_fit_valid = true %}
{% endif %}

{% assign has_straight_fit_valid = false %}
{% if straight_fit_product and straight_fit_is_draft == false %}
  {% assign has_straight_fit_valid = true %}
{% endif %}

{%- comment -%}
  Show toggles (shirt shows if at least one side exists)
{%- endcomment -%}
{% assign show_shirt_toggle = false %}
{% assign show_kurta_toggle = false %}
{% assign show_pant_toggle = false %}
{% assign show_collar_toggle = false %}
{% assign show_length_toggle = false %}
{% assign show_fit_toggle = false %}

{% if is_shirt and is_draft == false %}
  {% if has_full_valid or has_half_valid %}
    {% assign show_shirt_toggle = true %}
  {% endif %}
{% endif %}

{% if is_kurta
      and short_kurta_product and short_kurta_is_draft == false
      and long_kurta_product and long_kurta_is_draft == false
      and is_draft == false %}
  {% assign show_kurta_toggle = true %}
{% endif %}

{% if is_pant
      and straight_pant_product and straight_pant_is_draft == false
      and wide_leg_pant_product and wide_leg_pant_is_draft == false
      and is_draft == false %}
  {% assign show_pant_toggle = true %}
{% endif %}

{%- comment -%}
  Collar toggle visibility (no parentheses)
{%- endcomment -%}
{% assign show_collar_toggle = false %}
{% if is_draft == false %}
  {%- comment -%} If it's a shirt at all, we are OK to show collar row {%- endcomment -%}
  {% assign collar_title_ok = false %}
  {% if is_shirt %}
    {% assign collar_title_ok = true %}
  {% endif %}

  {% assign collar_links_ok = false %}
  {% if has_regular_collar_valid or has_notch_collar_valid %}
    {% assign collar_links_ok = true %}
  {% endif %}

  {% if collar_title_ok and collar_links_ok %}
    {% assign show_collar_toggle = true %}
  {% endif %}
{% endif %}

{%- comment -%} Length toggle visibility {%- endcomment -%}
{% if is_draft == false %}
  {% if has_short_length_valid or has_mid_thigh_length_valid %}
    {% assign show_length_toggle = true %}
  {% endif %}
{% endif %}

{%- comment -%} Fit toggle visibility {%- endcomment -%}
{% if is_draft == false %}
  {% if has_regular_fit_valid or has_straight_fit_valid %}
    {% assign show_fit_toggle = true %}
  {% endif %}
{% endif %}

{%- comment -%}
  Decide label for the second sleeve toggle:
  If the linked product OR the current product mentions "half sleeve", use "Half Sleeve".
  Otherwise use "Short Sleeve".
{%- endcomment -%}
{% assign short_label = 'Short Sleeve' %}
{% if normalized_title contains 'half sleeve' %}
  {% assign short_label = 'Half Sleeve' %}
{% elsif half_sleeve_product and half_sleeve_product.title %}
  {% assign half_title = half_sleeve_product.title | downcase %}
  {% if half_title contains 'half sleeve' %}
    {% assign short_label = 'Half Sleeve' %}
  {% endif %}
{% endif %}

{% if show_shirt_toggle or show_kurta_toggle or show_pant_toggle or show_collar_toggle or show_length_toggle or show_fit_toggle %}
<style>
  .toggle-container { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
  .toggle-row { margin-top:14px; }
  .toggle-btn {
    padding:5px 20px; border:1px solid #ccc; border-radius:5px; cursor:pointer;
    user-select:none; background:#fff; color:#000; transition:all .3s ease;
  }
  .toggle-btn.active { background:#000; color:#fff; border-color:#000; }
  .toggle-btn.disabled { opacity:.5; pointer-events:none; }
  @media (min-width:786px){ .toggle-btn { padding:3px 40px; font-size:16px; } }
</style>

<div>
  {% if show_shirt_toggle %}
    <div class="toggle-row">
      <label>Sleeve :</label>
      <div class="toggle-container">
        <button type="button" id="btnFullSleeve"
          class="toggle-btn {% unless full_sleeve_product %}disabled{% endunless %} {% if is_full_sleeve %}active{% endif %}">
          Full Sleeve
        </button>
        <button type="button" id="btnShortSleeve"
          class="toggle-btn {% unless half_sleeve_product %}disabled{% endunless %} {% if is_half_sleeve %}active{% endif %}">
          {{ short_label }}
        </button>
      </div>
    </div>
  {% endif %}

  {% if show_kurta_toggle %}
    <div class="toggle-row">
      <label>Kurta :</label>
      <div class="toggle-container">
        <button type="button" id="btnShortKurta" class="toggle-btn">Short Kurta</button>
        <button type="button" id="btnLongKurta"  class="toggle-btn">Long Kurta</button>
      </div>
    </div>
  {% endif %}

  {% if show_pant_toggle %}
    <div class="toggle-row">
      <label>Pant :</label>
      <div class="toggle-container">
        <button type="button" id="btnStraightPant" class="toggle-btn">Straight Pant</button>
        <button type="button" id="btnWideLegPant"  class="toggle-btn">Wide Leg Pant</button>
      </div>
    </div>
  {% endif %}

  {% if show_collar_toggle %}
    <div class="toggle-row">
      <label>Product Type :</label>
      <div class="toggle-container">
        <button type="button" id="btnRegularCollar"
          class="toggle-btn {% unless regular_collar_product %}disabled{% endunless %} {% if is_regular_collar %}active{% endif %}">
          Regular Collar
        </button>
        <button type="button" id="btnNotchCollar"
          class="toggle-btn {% unless notch_collar_product %}disabled{% endunless %} {% if is_notch_collar %}active{% endif %}">
          Notch Collar
        </button>
      </div>
    </div>
  {% endif %}

  {% if show_length_toggle %}
    <div class="toggle-row">
      <label>Length :</label>
      <div class="toggle-container">
        <button type="button" id="btnShortLength"
          class="toggle-btn {% unless short_length_product %}disabled{% endunless %} {% if short_length_product and short_length_product.id == product.id %}active{% endif %}">
          Short Length
        </button>
        <button type="button" id="btnMidThighLength"
          class="toggle-btn {% unless mid_thigh_length_product %}disabled{% endunless %} {% if mid_thigh_length_product and mid_thigh_length_product.id == product.id %}active{% endif %}">
          Mid Thigh Length
        </button>
      </div>
    </div>
  {% endif %}

  {% if show_fit_toggle %}
    <div class="toggle-row">
      <label>Fit :</label>
      <div class="toggle-container">
        <button type="button" id="btnRegularFit"
          class="toggle-btn {% unless regular_fit_product %}disabled{% endunless %} {% if regular_fit_product and regular_fit_product.id == product.id %}active{% endif %}">
          Regular Fit
        </button>
        <button type="button" id="btnStraightFit"
          class="toggle-btn {% unless straight_fit_product %}disabled{% endunless %} {% if straight_fit_product and straight_fit_product.id == product.id %}active{% endif %}">
          Straight Fit
        </button>
      </div>
    </div>
  {% endif %}
</div>

<script>
{% raw %}
  function normalizeTitle(str){ return str.toLowerCase().replace(/\n/g,' ').replace(/  +/g,' ').trim(); }

  const productTitleRaw = "{% endraw %}{{ product.title | escape }}{% raw %}";
  const productTitle    = normalizeTitle(productTitleRaw);

  const fullSleeveLink   = "{% endraw %}{% if full_sleeve_product %}{{ full_sleeve_product.url }}{% endif %}{% raw %}";
  const shortSleeveLink  = "{% endraw %}{% if half_sleeve_product %}{{ half_sleeve_product.url }}{% endif %}{% raw %}"; // maps to half_sleeve metafield
  const shortKurtaLink   = "{% endraw %}{% if short_kurta_product %}{{ short_kurta_product.url }}{% endif %}{% raw %}";
  const longKurtaLink    = "{% endraw %}{% if long_kurta_product %}{{ long_kurta_product.url }}{% endif %}{% raw %}";
  const straightPantLink = "{% endraw %}{% if straight_pant_product %}{{ straight_pant_product.url }}{% endif %}{% raw %}";
  const wideLegPantLink  = "{% endraw %}{% if wide_leg_pant_product %}{{ wide_leg_pant_product.url }}{% endif %}{% raw %}";

  // Collar links
  const regularCollarLink = "{% endraw %}{% if regular_collar_product %}{{ regular_collar_product.url }}{% endif %}{% raw %}";
  const notchCollarLink   = "{% endraw %}{% if notch_collar_product %}{{ notch_collar_product.url }}{% endif %}{% raw %}";

  // Length links
  const shortLengthLink    = "{% endraw %}{% if short_length_product %}{{ short_length_product.url }}{% endif %}{% raw %}";
  const midThighLengthLink = "{% endraw %}{% if mid_thigh_length_product %}{{ mid_thigh_length_product.url }}{% endif %}{% raw %}";

  // Fit links
  const regularFitLink  = "{% endraw %}{% if regular_fit_product %}{{ regular_fit_product.url }}{% endif %}{% raw %}";
  const straightFitLink = "{% endraw %}{% if straight_fit_product %}{{ straight_fit_product.url }}{% endif %}{% raw %}";

  function setActiveToggle(type){
    var btnFull     = document.getElementById('btnFullSleeve');
    var btnShortSlv = document.getElementById('btnShortSleeve');
    var btnShort    = document.getElementById('btnShortKurta');
    var btnLong     = document.getElementById('btnLongKurta');
    var btnStraight = document.getElementById('btnStraightPant');
    var btnWide     = document.getElementById('btnWideLegPant');
    var btnRegCol   = document.getElementById('btnRegularCollar');
    var btnNotchCol = document.getElementById('btnNotchCollar');

    if(type==='full' && btnFull && btnShortSlv){ btnFull.classList.add('active'); btnShortSlv.classList.remove('active'); }
    else if(type==='shortsleeve' && btnFull && btnShortSlv){ btnShortSlv.classList.add('active'); btnFull.classList.remove('active'); }
    else if(type==='short' && btnShort && btnLong){ btnShort.classList.add('active'); btnLong.classList.remove('active'); }
    else if(type==='long' && btnShort && btnLong){ btnLong.classList.add('active'); btnShort.classList.remove('active'); }
    else if(type==='straight' && btnStraight && btnWide){ btnStraight.classList.add('active'); btnWide.classList.remove('active'); }
    else if(type==='wide' && btnStraight && btnWide){ btnWide.classList.add('active'); btnStraight.classList.remove('active'); }
    else if(type==='regularcollar' && btnRegCol && btnNotchCol){ btnRegCol.classList.add('active'); btnNotchCol.classList.remove('active'); }
    else if(type==='notchcollar' && btnRegCol && btnNotchCol){ btnNotchCol.classList.add('active'); btnRegCol.classList.remove('active'); }

    // Length toggles
    else if(type==='shortlength'){
      var a=document.getElementById('btnShortLength'), b=document.getElementById('btnMidThighLength');
      if(a&&b){ a.classList.add('active'); b.classList.remove('active'); }
    }
    else if(type==='midthighlength'){
      var a=document.getElementById('btnShortLength'), b=document.getElementById('btnMidThighLength');
      if(a&&b){ b.classList.add('active'); a.classList.remove('active'); }
    }

    // Fit toggles
    else if(type==='regularfit'){
      var a=document.getElementById('btnRegularFit'), b=document.getElementById('btnStraightFit');
      if(a&&b){ a.classList.add('active'); b.classList.remove('active'); }
    }
    else if(type==='straightfit'){
      var a=document.getElementById('btnRegularFit'), b=document.getElementById('btnStraightFit');
      if(a&&b){ b.classList.add('active'); a.classList.remove('active'); }
    }
  }

  // --- Robust URL-based activation helper ---
  function samePath(urlA, urlB){
    if(!urlA || !urlB) return false;
    try{
      const a = new URL(urlA, location.origin).pathname.replace(/\/+$/,'');
      const b = new URL(urlB, location.origin).pathname.replace(/\/+$/,'');
      return a === b;
    }catch(e){ return false; }
  }

  // If current page *is* one of the target links, set active immediately (Length)
  (function activateLengthByURL(){
    const here = location.pathname.replace(/\/+$/,'');
    if (samePath(here, shortLengthLink)) {
      setActiveToggle('shortlength');
    } else if (samePath(here, midThighLengthLink)) {
      setActiveToggle('midthighlength');
    }
  })();

  // If current page *is* one of the target links, set active immediately (Fit)
  (function activateFitByURL(){
    const here = location.pathname.replace(/\/+$/,'');
    if (samePath(here, regularFitLink)) {
      setActiveToggle('regularfit');
    } else if (samePath(here, straightFitLink)) {
      setActiveToggle('straightfit');
    }
  })();

  function updateToggleBasedOnTitle(){
    const t = productTitle;
    const isShirt = t.includes('shirt');
    const hasFull  = t.includes('full sleeve') || t.includes('full-sleeve') || t.includes('100% linen shirt');
    const hasShort = t.includes('short sleeve') || t.includes('short-sleeve') || t.includes('half sleeve') || t.includes('half-sleeve');

    if(isShirt && hasFull){ setActiveToggle('full'); }
    else if(isShirt && hasShort){ setActiveToggle('shortsleeve'); }
    else if(t.includes('short kurta')){ setActiveToggle('short'); }
    else if(t.includes('long kurta')){ setActiveToggle('long'); }
    else if(t.includes('straight pant')){ setActiveToggle('straight'); }
    else if(t.includes('wide leg pant') || t.includes('wide-leg pant')){ setActiveToggle('wide'); }

    // Collar active state (robust)
    if (t.includes('shirt') && t.includes('notch collar')) {
      setActiveToggle('notchcollar');
    } else if (t.includes('shirt')) {
      // any shirt without "notch collar" is regular collar
      setActiveToggle('regularcollar');
    }

    // Length active state
    if (t.includes('mid thigh length') || t.includes('mid-thigh length')) {
      setActiveToggle('midthighlength');
    } else if (t.includes('short length')) {
      setActiveToggle('shortlength');
    }

    // Fit active state (fallback to title keywords)
    if (t.includes('straight fit')) {
      setActiveToggle('straightfit');
    } else if (t.includes('regular fit')) {
      setActiveToggle('regularfit');
    }
  }

  document.addEventListener('DOMContentLoaded', updateToggleBasedOnTitle);
  window.addEventListener('load', updateToggleBasedOnTitle);

  // Shirt click handlers
  var btnFullSleeve  = document.getElementById('btnFullSleeve');
  var btnShortSleeve = document.getElementById('btnShortSleeve');

  if(btnFullSleeve){
    btnFullSleeve.addEventListener('click', function(){
      if(fullSleeveLink && fullSleeveLink.trim()!==''){
        if(!(productTitle.includes('full sleeve') || productTitle.includes('full-sleeve') || productTitle.includes('100% linen shirt'))){
          window.location.href = fullSleeveLink;
        }
        setActiveToggle('full');
      }
    });
  }

  if(btnShortSleeve){
    btnShortSleeve.addEventListener('click', function(){
      if(shortSleeveLink && shortSleeveLink.trim()!==''){
        if(!(productTitle.includes('short sleeve') || productTitle.includes('short-sleeve') || productTitle.includes('half sleeve') || productTitle.includes('half-sleeve'))){
          window.location.href = shortSleeveLink;
        }
        setActiveToggle('shortsleeve');
      }
    });
  }

  // Kurta handlers
  if(document.getElementById('btnShortKurta')){
    document.getElementById('btnShortKurta').addEventListener('click', function(){
      if(shortKurtaLink && shortKurtaLink.trim()!==''){
        if(!productTitle.includes('short kurta')){ window.location.href = shortKurtaLink; }
        setActiveToggle('short');
      }
    });
  }
  if(document.getElementById('btnLongKurta')){
    document.getElementById('btnLongKurta').addEventListener('click', function(){
      if(longKurtaLink && longKurtaLink.trim()!==''){
        if(!productTitle.includes('long kurta')){ window.location.href = longKurtaLink; }
        setActiveToggle('long');
      }
    });
  }

  // Pant handlers
  if(document.getElementById('btnStraightPant')){
    document.getElementById('btnStraightPant').addEventListener('click', function(){
      if(straightPantLink && straightPantLink.trim()!==''){
        if(!productTitle.includes('straight pant')){ window.location.href = straightPantLink; }
        setActiveToggle('straight');
      }
    });
  }
  if(document.getElementById('btnWideLegPant')){
    document.getElementById('btnWideLegPant').addEventListener('click', function(){
      if(wideLegPantLink && wideLegPantLink.trim()!==''){
        if(!(productTitle.includes('wide leg pant') || productTitle.includes('wide-leg pant'))){
          window.location.href = wideLegPantLink;
        }
        setActiveToggle('wide');
      }
    });
  }

  // Collar handlers
  var btnRegularCollar = document.getElementById('btnRegularCollar');
  var btnNotchCollar   = document.getElementById('btnNotchCollar');

  if (btnRegularCollar){
    btnRegularCollar.addEventListener('click', function(){
      if (regularCollarLink && productTitle.includes('notch collar')) {
        window.location.href = regularCollarLink;
      }
      setActiveToggle('regularcollar');
    });
  }
  if (btnNotchCollar){
    btnNotchCollar.addEventListener('click', function(){
      if (notchCollarLink && !productTitle.includes('notch collar')) {
        window.location.href = notchCollarLink;
      }
      setActiveToggle('notchcollar');
    });
  }

  // Length handlers
  var btnShortLength    = document.getElementById('btnShortLength');
  var btnMidThighLength = document.getElementById('btnMidThighLength');

  if (btnShortLength){
    btnShortLength.addEventListener('click', function(){
      if (shortLengthLink && shortLengthLink.trim() !== ''){
        if (!(productTitle.includes('short length'))) {
          window.location.href = shortLengthLink;
        }
        setActiveToggle('shortlength');
      }
    });
  }

  if (btnMidThighLength){
    btnMidThighLength.addEventListener('click', function(){
      if (midThighLengthLink && midThighLengthLink.trim() !== ''){
        if (!(productTitle.includes('mid thigh length') || productTitle.includes('mid-thigh length'))) {
          window.location.href = midThighLengthLink;
        }
        setActiveToggle('midthighlength');
      }
    });
  }

  // Fit handlers
  var btnRegularFit  = document.getElementById('btnRegularFit');
  var btnStraightFit = document.getElementById('btnStraightFit');

  if (btnRegularFit){
    btnRegularFit.addEventListener('click', function(){
      if (regularFitLink && regularFitLink.trim() !== ''){
        if (!(productTitle.includes('regular fit'))) {
          window.location.href = regularFitLink;
        }
        setActiveToggle('regularfit');
      }
    });
  }

  if (btnStraightFit){
    btnStraightFit.addEventListener('click', function(){
      if (straightFitLink && straightFitLink.trim() !== ''){
        if (!(productTitle.includes('straight fit'))) {
          window.location.href = straightFitLink;
        }
        setActiveToggle('straightfit');
      }
    });
  }

  // Handle bfcache back/forward navigation
  window.addEventListener('pageshow', function(e){ if(e.persisted){ updateToggleBasedOnTitle(); }});
{% endraw %}
</script>
{% endif %} {% endcomment %}


{% comment %} NEW CODE  {% endcomment %}

{%- comment -%}
  Normalize product title:
{%- endcomment -%}
{% assign normalized_title = product.title | downcase | replace: '
', ' ' | replace: '  ', ' ' | replace: '  ', ' ' %}

{%- comment -%}
  Detect product type (more tolerant)
{%- endcomment -%}
{% assign is_shirt = false %}
{% assign is_full_sleeve = false %}
{% assign is_half_sleeve = false %}
{% assign is_kurta = false %}
{% assign is_short_kurta = false %}
{% assign is_long_kurta = false %}
{% assign is_pant = false %}
{% assign is_straight_pant = false %}
{% assign is_wide_leg_pant = false %}

{% comment %} /* Shirt detection */ {% endcomment %}
{% if normalized_title contains 'shirt' %}
  {% assign is_shirt = true %}
{% endif %}
{% if normalized_title contains 'full sleeve' %}
  {% assign is_full_sleeve = true %}
{% endif %}
{% if normalized_title contains 'short sleeve' or normalized_title contains 'half sleeve' %}
  {% assign is_half_sleeve = true %}
{% endif %}

{% comment %} /* Kurtas */ {% endcomment %}
{% if normalized_title contains 'short kurta' %}
  {% assign is_kurta = true %}{% assign is_short_kurta = true %}
{% endif %}
{% if normalized_title contains 'long kurta' %}
  {% assign is_kurta = true %}{% assign is_long_kurta = true %}
{% endif %}

{% comment %} /* Pants */ {% endcomment %}
{% if normalized_title contains 'straight pant' %}
  {% assign is_pant = true %}{% assign is_straight_pant = true %}
{% endif %}
{% if normalized_title contains 'wide leg pant' or normalized_title contains 'wide-leg pant' %}
  {% assign is_pant = true %}{% assign is_wide_leg_pant = true %}
{% endif %}

{%- comment -%}
  Collar detection (Women 100% linen shirt / notch collar shirt)
{%- endcomment -%}
{% assign is_regular_collar = false %}
{% assign is_notch_collar = false %}

{%- comment -%} Notch collar if explicitly mentioned {%- endcomment -%}
{% if normalized_title contains 'notch collar' and normalized_title contains 'shirt' %}
  {% assign is_notch_collar = true %}
{% endif %}

{%- comment -%} Otherwise, any shirt (that isn't notch) is "regular collar" {%- endcomment -%}
{% if normalized_title contains 'shirt' and is_notch_collar == false %}
  {% assign is_regular_collar = true %}
{% endif %}

{%- comment -%}
  Product reference metafields
{%- endcomment -%}
{% assign full_sleeve_product = product.metafields.custom.full_sleeve_toggle_link1.value %}
{% assign half_sleeve_product = product.metafields.custom.half_sleeve_toggle_link1.value %}
{% assign short_kurta_product = product.metafields.custom.short_kurta_toggle_link1.value %}
{% assign long_kurta_product = product.metafields.custom.long_kurta_toggle_link1.value %}
{% assign straight_pant_product = product.metafields.custom.straight_pant_toggle_product.value %}
{% assign wide_leg_pant_product = product.metafields.custom.wide_leg_pant_toggle_product.value %}

{%- comment -%} Length metafields (Product references) {%- endcomment -%}
{% assign short_length_product     = product.metafields.custom.short_length.value %}
{% assign mid_thigh_length_product = product.metafields.custom.mid_thigh_length.value %}

{%- comment -%} Fit metafields (Product references) {%- endcomment -%}
{% assign regular_fit_product  = product.metafields.custom.regular_fit_product_toggle.value %}
{% assign straight_fit_product = product.metafields.custom.straight_fit_product_toggle.value %}

{%- comment -%}
  Collar metafields
{%- endcomment -%}
{% assign regular_collar_product = product.metafields.custom.regular_collar_product_toggles.value %}
{% assign notch_collar_product = product.metafields.custom.notch_collar_product_toggles.value %}

{%- comment -%}
  Lea / Fabric metafields (NEW)
{%- endcomment -%}
{% assign lea40_product = product.metafields.custom.lea40_toggle_product.value %}
{% assign lea44_product = product.metafields.custom.lea44_toggle_product.value %}

{%- comment -%}
  Draft check
{%- endcomment -%}
{% assign is_draft = false %}
{% if product.status and product.status == 'draft' %}{% assign is_draft = true %}{% endif %}

{% assign full_sleeve_is_draft = false %}
{% if full_sleeve_product and full_sleeve_product.status == 'draft' %}{% assign full_sleeve_is_draft = true %}{% endif %}

{% assign half_sleeve_is_draft = false %}
{% if half_sleeve_product and half_sleeve_product.status == 'draft' %}{% assign half_sleeve_is_draft = true %}{% endif %}

{% assign short_kurta_is_draft = false %}
{% if short_kurta_product and short_kurta_product.status == 'draft' %}{% assign short_kurta_is_draft = true %}{% endif %}

{% assign long_kurta_is_draft = false %}
{% if long_kurta_product and long_kurta_product.status == 'draft' %}{% assign long_kurta_is_draft = true %}{% endif %}

{% assign straight_pant_is_draft = false %}
{% if straight_pant_product and straight_pant_product.status == 'draft' %}{% assign straight_pant_is_draft = true %}{% endif %}

{% assign wide_leg_pant_is_draft = false %}
{% if wide_leg_pant_product and wide_leg_pant_product.status == 'draft' %}{% assign wide_leg_pant_is_draft = true %}{% endif %}

{%- comment -%} Length draft flags {%- endcomment -%}
{% assign short_length_is_draft = false %}
{% if short_length_product and short_length_product.status == 'draft' %}{% assign short_length_is_draft = true %}{% endif %}

{% assign mid_thigh_length_is_draft = false %}
{% if mid_thigh_length_product and mid_thigh_length_product.status == 'draft' %}{% assign mid_thigh_length_is_draft = true %}{% endif %}

{%- comment -%} Fit draft flags {%- endcomment -%}
{% assign regular_fit_is_draft = false %}
{% if regular_fit_product and regular_fit_product.status == 'draft' %}{% assign regular_fit_is_draft = true %}{% endif %}

{% assign straight_fit_is_draft = false %}
{% if straight_fit_product and straight_fit_product.status == 'draft' %}{% assign straight_fit_is_draft = true %}{% endif %}

{%- comment -%}
  Collar draft flags
{%- endcomment -%}
{% assign regular_collar_is_draft = false %}
{% if regular_collar_product and regular_collar_product.status == 'draft' %}{% assign regular_collar_is_draft = true %}{% endif %}

{% assign notch_collar_is_draft = false %}
{% if notch_collar_product and notch_collar_product.status == 'draft' %}{% assign notch_collar_is_draft = true %}{% endif %}

{%- comment -%}
  Lea draft flags (NEW)
{%- endcomment -%}
{% assign lea40_is_draft = false %}
{% if lea40_product and lea40_product.status == 'draft' %}{% assign lea40_is_draft = true %}{% endif %}

{% assign lea44_is_draft = false %}
{% if lea44_product and lea44_product.status == 'draft' %}{% assign lea44_is_draft = true %}{% endif %}

{%- comment -%}
  Compute “valid target exists” flags (avoid parentheses in IFs)
{%- endcomment -%}
{% assign has_full_valid = false %}
{% if full_sleeve_product and full_sleeve_is_draft == false %}
  {% assign has_full_valid = true %}
{% endif %}

{% assign has_half_valid = false %}
{% if half_sleeve_product and half_sleeve_is_draft == false %}
  {% assign has_half_valid = true %}
{% endif %}

{% assign has_regular_collar_valid = false %}
{% if regular_collar_product and regular_collar_is_draft == false %}
  {% assign has_regular_collar_valid = true %}
{% endif %}

{% assign has_notch_collar_valid = false %}
{% if notch_collar_product and notch_collar_is_draft == false %}
  {% assign has_notch_collar_valid = true %}
{% endif %}

{%- comment -%} Length valid flags {%- endcomment -%}
{% assign has_short_length_valid = false %}
{% if short_length_product and short_length_is_draft == false %}
  {% assign has_short_length_valid = true %}
{% endif %}

{% assign has_mid_thigh_length_valid = false %}
{% if mid_thigh_length_product and mid_thigh_length_is_draft == false %}
  {% assign has_mid_thigh_length_valid = true %}
{% endif %}

{%- comment -%} Fit valid flags {%- endcomment -%}
{% assign has_regular_fit_valid = false %}
{% if regular_fit_product and regular_fit_is_draft == false %}
  {% assign has_regular_fit_valid = true %}
{% endif %}

{% assign has_straight_fit_valid = false %}
{% if straight_fit_product and straight_fit_is_draft == false %}
  {% assign has_straight_fit_valid = true %}
{% endif %}

{%- comment -%}
  Lea valid flags (NEW)
{%- endcomment -%}
{% assign has_lea40_valid = false %}
{% if lea40_product and lea40_is_draft == false %}{% assign has_lea40_valid = true %}{% endif %}

{% assign has_lea44_valid = false %}
{% if lea44_product and lea44_is_draft == false %}{% assign has_lea44_valid = true %}{% endif %}

{%- comment -%}
  Show toggles (shirt shows if at least one side exists)
{%- endcomment -%}
{% assign show_shirt_toggle = false %}
{% assign show_kurta_toggle = false %}
{% assign show_pant_toggle = false %}
{% assign show_collar_toggle = false %}
{% assign show_length_toggle = false %}
{% assign show_fit_toggle = false %}
{% assign show_lea_toggle = false %}

{% if is_shirt and is_draft == false %}
  {% if has_full_valid or has_half_valid %}
    {% assign show_shirt_toggle = true %}
  {% endif %}
{% endif %}

{% if is_kurta
      and short_kurta_product and short_kurta_is_draft == false
      and long_kurta_product and long_kurta_is_draft == false
      and is_draft == false %}
  {% assign show_kurta_toggle = true %}
{% endif %}

{% if is_pant
      and straight_pant_product and straight_pant_is_draft == false
      and wide_leg_pant_product and wide_leg_pant_is_draft == false
      and is_draft == false %}
  {% assign show_pant_toggle = true %}
{% endif %}

{%- comment -%}
  Collar toggle visibility (no parentheses)
{%- endcomment -%}
{% assign show_collar_toggle = false %}
{% if is_draft == false %}
  {%- comment -%} If it's a shirt at all, we are OK to show collar row {%- endcomment -%}
  {% assign collar_title_ok = false %}
  {% if is_shirt %}
    {% assign collar_title_ok = true %}
  {% endif %}

  {% assign collar_links_ok = false %}
  {% if has_regular_collar_valid or has_notch_collar_valid %}
    {% assign collar_links_ok = true %}
  {% endif %}

  {% if collar_title_ok and collar_links_ok %}
    {% assign show_collar_toggle = true %}
  {% endif %}
{% endif %}

{%- comment -%} Length toggle visibility {%- endcomment -%}
{% if is_draft == false %}
  {% if has_short_length_valid or has_mid_thigh_length_valid %}
    {% assign show_length_toggle = true %}
  {% endif %}
{% endif %}

{%- comment -%} Fit toggle visibility {%- endcomment -%}
{% if is_draft == false %}
  {% if has_regular_fit_valid or has_straight_fit_valid %}
    {% assign show_fit_toggle = true %}
  {% endif %}
{% endif %}

{%- comment -%}
  Pure linen shirt family detection (target for Lea toggle) (NEW)
{%- endcomment -%}
{%- comment -%} Pure linen shirt family (no parentheses, broader match) {%- endcomment -%}
{%- comment -%} Pure linen shirt family (robust: matches "100%" + "linen" anywhere) {%- endcomment -%}
{% assign has_100 = false %}
{% if normalized_title contains '100%' %}
  {% assign has_100 = true %}
{% endif %}

{% assign has_linen_word = false %}
{% if normalized_title contains 'linen' %}
  {% assign has_linen_word = true %}
{% endif %}

{% assign mentions_pure_linen = false %}
{% if normalized_title contains 'pure linen' %}
  {% assign mentions_pure_linen = true %}
{% endif %}

{% assign is_pure_linen_shirt_family = false %}
{% if is_shirt and has_100 and has_linen_word %}
  {% assign is_pure_linen_shirt_family = true %}
{% endif %}
{% if is_shirt and mentions_pure_linen %}
  {% assign is_pure_linen_shirt_family = true %}
{% endif %}



{%- comment -%} Lea toggle visibility (show if at least one link exists) {%- endcomment -%}
{% assign has_lea_link = false %}
{% if lea40_product %}{% assign has_lea_link = true %}{% endif %}
{% if lea44_product %}{% assign has_lea_link = true %}{% endif %}

{% if is_pure_linen_shirt_family and is_draft == false and has_lea_link %}
  {% assign show_lea_toggle = true %}
{% endif %}

{%- comment -%}
  Decide label for the second sleeve toggle:
  If the linked product OR the current product mentions "half sleeve", use "Half Sleeve".
  Otherwise use "Short Sleeve".
{%- endcomment -%}
{% assign short_label = 'Short Sleeve' %}
{% if normalized_title contains 'half sleeve' %}
  {% assign short_label = 'Half Sleeve' %}
{% elsif half_sleeve_product and half_sleeve_product.title %}
  {% assign half_title = half_sleeve_product.title | downcase %}
  {% if half_title contains 'half sleeve' %}
    {% assign short_label = 'Half Sleeve' %}
  {% endif %}
{% endif %}

{% if show_shirt_toggle or show_kurta_toggle or show_pant_toggle or show_collar_toggle or show_length_toggle or show_fit_toggle or show_lea_toggle %}
<style>
  .toggle-container { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
  .toggle-row { margin-top:14px; }
  .toggle-btn {
    padding:5px 15px; border:1px solid #ccc; border-radius:5px; cursor:pointer;
    user-select:none; background:#fff; color:#000; transition:all .3s ease;
  }
  .toggle-btn.active { background:#000; color:#fff; border-color:#000; }
  .toggle-btn.disabled { opacity:.5; pointer-events:none; }
  @media (min-width:786px){ .toggle-btn { padding:3px 30px; font-size:16px; } }
</style>

<div>
  {% if show_shirt_toggle %}
    <div class="toggle-row">
      <label>Sleeve :</label>
      <div class="toggle-container">
        <button type="button" id="btnFullSleeve"
          class="toggle-btn {% unless full_sleeve_product %}disabled{% endunless %} {% if is_full_sleeve %}active{% endif %}">
          Full Sleeve
        </button>
        <button type="button" id="btnShortSleeve"
          class="toggle-btn {% unless half_sleeve_product %}disabled{% endunless %} {% if is_half_sleeve %}active{% endif %}">
          {{ short_label }}
        </button>
      </div>
    </div>
  {% endif %}

  {% if show_kurta_toggle %}
    <div class="toggle-row">
      <label>Kurta :</label>
      <div class="toggle-container">
        <button type="button" id="btnShortKurta" class="toggle-btn">Short Kurta</button>
        <button type="button" id="btnLongKurta"  class="toggle-btn">Long Kurta</button>
      </div>
    </div>
  {% endif %}

  {% if show_pant_toggle %}
    <div class="toggle-row">
      <label>Pant :</label>
      <div class="toggle-container">
        <button type="button" id="btnStraightPant" class="toggle-btn">Straight Pant</button>
        <button type="button" id="btnWideLegPant"  class="toggle-btn">Wide Leg Pant</button>
      </div>
    </div>
  {% endif %}

  {% if show_collar_toggle %}
    <div class="toggle-row">
      <label>Product Type :</label>
      <div class="toggle-container">
        <button type="button" id="btnRegularCollar"
          class="toggle-btn {% unless regular_collar_product %}disabled{% endunless %} {% if is_regular_collar %}active{% endif %}">
          Regular Collar
        </button>
        <button type="button" id="btnNotchCollar"
          class="toggle-btn {% unless notch_collar_product %}disabled{% endunless %} {% if is_notch_collar %}active{% endif %}">
          Notch Collar
        </button>
      </div>
    </div>
  {% endif %}

  {% if show_length_toggle %}
    <div class="toggle-row">
      <label>Length :</label>
      <div class="toggle-container">
        <button type="button" id="btnShortLength"
          class="toggle-btn {% unless short_length_product %}disabled{% endunless %} {% if short_length_product and short_length_product.id == product.id %}active{% endif %}">
          Short Length
        </button>
        <button type="button" id="btnMidThighLength"
          class="toggle-btn {% unless mid_thigh_length_product %}disabled{% endunless %} {% if mid_thigh_length_product and mid_thigh_length_product.id == product.id %}active{% endif %}">
          Mid Thigh Length
        </button>
      </div>
    </div>
  {% endif %}

  {% if show_fit_toggle %}
    <div class="toggle-row">
      <label>Fit :</label>
      <div class="toggle-container">
        <button type="button" id="btnRegularFit"
          class="toggle-btn {% unless regular_fit_product %}disabled{% endunless %} {% if regular_fit_product and regular_fit_product.id == product.id %}active{% endif %}">
          Regular Fit
        </button>
        <button type="button" id="btnStraightFit"
          class="toggle-btn {% unless straight_fit_product %}disabled{% endunless %} {% if straight_fit_product and straight_fit_product.id == product.id %}active{% endif %}">
          Straight Fit
        </button>
      </div>
    </div>
  {% endif %}

  {%- comment -%} Lea / Fabric toggle (NEW) {%- endcomment -%}
  {% if show_lea_toggle %}
    <div class="toggle-row">
      <label>Fabric :</label>
      <div class="toggle-container">
        <button type="button" id="btnLea40"
          class="toggle-btn {% unless lea40_product %}disabled{% endunless %}">
          40 Lea Pure Linen
        </button>
        <button type="button" id="btnLea44"
          class="toggle-btn {% unless lea44_product %}disabled{% endunless %}">
          44 Lea Pure Linen
        </button>
      </div>
    </div>
  {% endif %}
</div>

<script>
{% raw %}
  function normalizeTitle(str){ return str.toLowerCase().replace(/\n/g,' ').replace(/  +/g,' ').trim(); }

  const productTitleRaw = "{% endraw %}{{ product.title | escape }}{% raw %}";
  const productTitle    = normalizeTitle(productTitleRaw);

  const fullSleeveLink   = "{% endraw %}{% if full_sleeve_product %}{{ full_sleeve_product.url }}{% endif %}{% raw %}";
  const shortSleeveLink  = "{% endraw %}{% if half_sleeve_product %}{{ half_sleeve_product.url }}{% endif %}{% raw %}"; // maps to half_sleeve metafield
  const shortKurtaLink   = "{% endraw %}{% if short_kurta_product %}{{ short_kurta_product.url }}{% endif %}{% raw %}";
  const longKurtaLink    = "{% endraw %}{% if long_kurta_product %}{{ long_kurta_product.url }}{% endif %}{% raw %}";
  const straightPantLink = "{% endraw %}{% if straight_pant_product %}{{ straight_pant_product.url }}{% endif %}{% raw %}";
  const wideLegPantLink  = "{% endraw %}{% if wide_leg_pant_product %}{{ wide_leg_pant_product.url }}{% endif %}{% raw %}";

  // Collar links
  const regularCollarLink = "{% endraw %}{% if regular_collar_product %}{{ regular_collar_product.url }}{% endif %}{% raw %}";
  const notchCollarLink   = "{% endraw %}{% if notch_collar_product %}{{ notch_collar_product.url }}{% endif %}{% raw %}";

  // Length links
  const shortLengthLink    = "{% endraw %}{% if short_length_product %}{{ short_length_product.url }}{% endif %}{% raw %}";
  const midThighLengthLink = "{% endraw %}{% if mid_thigh_length_product %}{{ mid_thigh_length_product.url }}{% endif %}{% raw %}";

  // Fit links
  const regularFitLink  = "{% endraw %}{% if regular_fit_product %}{{ regular_fit_product.url }}{% endif %}{% raw %}";
  const straightFitLink = "{% endraw %}{% if straight_fit_product %}{{ straight_fit_product.url }}{% endif %}{% raw %}";

  // Lea links (NEW)
  const lea40Link = "{% endraw %}{% if lea40_product %}{{ lea40_product.url }}{% endif %}{% raw %}";
  const lea44Link = "{% endraw %}{% if lea44_product %}{{ lea44_product.url }}{% endif %}{% raw %}";

  function setActiveToggle(type){
    var btnFull     = document.getElementById('btnFullSleeve');
    var btnShortSlv = document.getElementById('btnShortSleeve');
    var btnShort    = document.getElementById('btnShortKurta');
    var btnLong     = document.getElementById('btnLongKurta');
    var btnStraight = document.getElementById('btnStraightPant');
    var btnWide     = document.getElementById('btnWideLegPant');
    var btnRegCol   = document.getElementById('btnRegularCollar');
    var btnNotchCol = document.getElementById('btnNotchCollar');

    if(type==='full' && btnFull && btnShortSlv){ btnFull.classList.add('active'); btnShortSlv.classList.remove('active'); }
    else if(type==='shortsleeve' && btnFull && btnShortSlv){ btnShortSlv.classList.add('active'); btnFull.classList.remove('active'); }
    else if(type==='short' && btnShort && btnLong){ btnShort.classList.add('active'); btnLong.classList.remove('active'); }
    else if(type==='long' && btnShort && btnLong){ btnLong.classList.add('active'); btnShort.classList.remove('active'); }
    else if(type==='straight' && btnStraight && btnWide){ btnStraight.classList.add('active'); btnWide.classList.remove('active'); }
    else if(type==='wide' && btnStraight && btnWide){ btnWide.classList.add('active'); btnStraight.classList.remove('active'); }
    else if(type==='regularcollar' && btnRegCol && btnNotchCol){ btnRegCol.classList.add('active'); btnNotchCol.classList.remove('active'); }
    else if(type==='notchcollar' && btnRegCol && btnNotchCol){ btnNotchCol.classList.add('active'); btnRegCol.classList.remove('active'); }

    // Length toggles
    else if(type==='shortlength'){
      var a=document.getElementById('btnShortLength'), b=document.getElementById('btnMidThighLength');
      if(a&&b){ a.classList.add('active'); b.classList.remove('active'); }
    }
    else if(type==='midthighlength'){
      var a=document.getElementById('btnShortLength'), b=document.getElementById('btnMidThighLength');
      if(a&&b){ b.classList.add('active'); a.classList.remove('active'); }
    }

    // Fit toggles
    else if(type==='regularfit'){
      var a=document.getElementById('btnRegularFit'), b=document.getElementById('btnStraightFit');
      if(a&&b){ a.classList.add('active'); b.classList.remove('active'); }
    }
    else if(type==='straightfit'){
      var a=document.getElementById('btnRegularFit'), b=document.getElementById('btnStraightFit');
      if(a&&b){ b.classList.add('active'); a.classList.remove('active'); }
    }

    // Lea toggles (NEW)
    else if(type==='lea40'){
      var a=document.getElementById('btnLea40'), b=document.getElementById('btnLea44');
      if(a&&b){ a.classList.add('active'); b.classList.remove('active'); }
    }
    else if(type==='lea44'){
      var a=document.getElementById('btnLea40'), b=document.getElementById('btnLea44');
      if(a&&b){ b.classList.add('active'); a.classList.remove('active'); }
    }
  }

  // --- Robust URL-based activation helper ---
  function samePath(urlA, urlB){
    if(!urlA || !urlB) return false;
    try{
      const a = new URL(urlA, location.origin).pathname.replace(/\/+$/,'');
      const b = new URL(urlB, location.origin).pathname.replace(/\/+$/,'');
      return a === b;
    }catch(e){ return false; }
  }

  // If current page *is* one of the target links, set active immediately (Length)
  (function activateLengthByURL(){
    const here = location.pathname.replace(/\/+$/,'');
    if (samePath(here, shortLengthLink)) {
      setActiveToggle('shortlength');
    } else if (samePath(here, midThighLengthLink)) {
      setActiveToggle('midthighlength');
    }
  })();

  // If current page *is* one of the target links, set active immediately (Fit)
  (function activateFitByURL(){
    const here = location.pathname.replace(/\/+$/,'');
    if (samePath(here, regularFitLink)) {
      setActiveToggle('regularfit');
    } else if (samePath(here, straightFitLink)) {
      setActiveToggle('straightfit');
    }
  })();

  // If current page *is* one of the Lea links, set active immediately (NEW)
  (function activateLeaByURL(){
    const here = location.pathname.replace(/\/+$/,'');
    if (samePath(here, lea40Link)) { setActiveToggle('lea40'); }
    else if (samePath(here, lea44Link)) { setActiveToggle('lea44'); }
  })();

  function updateToggleBasedOnTitle(){
    const t = productTitle;
    const isShirt = t.includes('shirt');
    const hasFull  = t.includes('full sleeve') || t.includes('full-sleeve') || t.includes('100% linen shirt');
    const hasShort = t.includes('short sleeve') || t.includes('short-sleeve') || t.includes('half sleeve') || t.includes('half-sleeve');

    if(isShirt && hasFull){ setActiveToggle('full'); }
    else if(isShirt && hasShort){ setActiveToggle('shortsleeve'); }
    else if(t.includes('short kurta')){ setActiveToggle('short'); }
    else if(t.includes('long kurta')){ setActiveToggle('long'); }
    else if(t.includes('straight pant')){ setActiveToggle('straight'); }
    else if(t.includes('wide leg pant') || t.includes('wide-leg pant')){ setActiveToggle('wide'); }

    // Collar active state (robust)
    if (t.includes('shirt') && t.includes('notch collar')) {
      setActiveToggle('notchcollar');
    } else if (t.includes('shirt')) {
      // any shirt without "notch collar" is regular collar
      setActiveToggle('regularcollar');
    }

    // Length active state
    if (t.includes('mid thigh length') || t.includes('mid-thigh length')) {
      setActiveToggle('midthighlength');
    } else if (t.includes('short length')) {
      setActiveToggle('shortlength');
    }

    // Fit active state (fallback to title keywords)
    if (t.includes('straight fit')) {
      setActiveToggle('straightfit');
    } else if (t.includes('regular fit')) {
      setActiveToggle('regularfit');
    }

    // Lea active state is handled via URL/links; titles don't contain "40/44 Lea".
  }

  document.addEventListener('DOMContentLoaded', updateToggleBasedOnTitle);
  window.addEventListener('load', updateToggleBasedOnTitle);

  // Shirt click handlers
  var btnFullSleeve  = document.getElementById('btnFullSleeve');
  var btnShortSleeve = document.getElementById('btnShortSleeve');

  if(btnFullSleeve){
    btnFullSleeve.addEventListener('click', function(){
      if(fullSleeveLink && fullSleeveLink.trim()!==''){
        if(!(productTitle.includes('full sleeve') || productTitle.includes('full-sleeve') || productTitle.includes('100% linen shirt'))){
          window.location.href = fullSleeveLink;
        }
        setActiveToggle('full');
      }
    });
  }

  if(btnShortSleeve){
    btnShortSleeve.addEventListener('click', function(){
      if(shortSleeveLink && shortSleeveLink.trim()!==''){
        if(!(productTitle.includes('short sleeve') || productTitle.includes('short-sleeve') || productTitle.includes('half sleeve') || productTitle.includes('half-sleeve'))){
          window.location.href = shortSleeveLink;
        }
        setActiveToggle('shortsleeve');
      }
    });
  }

  // Kurta handlers
  if(document.getElementById('btnShortKurta')){
    document.getElementById('btnShortKurta').addEventListener('click', function(){
      if(shortKurtaLink && shortKurtaLink.trim()!==''){
        if(!productTitle.includes('short kurta')){ window.location.href = shortKurtaLink; }
        setActiveToggle('short');
      }
    });
  }
  if(document.getElementById('btnLongKurta')){
    document.getElementById('btnLongKurta').addEventListener('click', function(){
      if(longKurtaLink && longKurtaLink.trim()!==''){
        if(!productTitle.includes('long kurta')){ window.location.href = longKurtaLink; }
        setActiveToggle('long');
      }
    });
  }

  // Pant handlers
  if(document.getElementById('btnStraightPant')){
    document.getElementById('btnStraightPant').addEventListener('click', function(){
      if(straightPantLink && straightPantLink.trim()!==''){
        if(!productTitle.includes('straight pant')){ window.location.href = straightPantLink; }
        setActiveToggle('straight');
      }
    });
  }
  if(document.getElementById('btnWideLegPant')){
    document.getElementById('btnWideLegPant').addEventListener('click', function(){
      if(wideLegPantLink && wideLegPantLink.trim()!==''){
        if(!(productTitle.includes('wide leg pant') || productTitle.includes('wide-leg pant'))){
          window.location.href = wideLegPantLink;
        }
        setActiveToggle('wide');
      }
    });
  }

  // Collar handlers
  var btnRegularCollar = document.getElementById('btnRegularCollar');
  var btnNotchCollar   = document.getElementById('btnNotchCollar');

  if (btnRegularCollar){
    btnRegularCollar.addEventListener('click', function(){
      if (regularCollarLink && productTitle.includes('notch collar')) {
        window.location.href = regularCollarLink;
      }
      setActiveToggle('regularcollar');
    });
  }
  if (btnNotchCollar){
    btnNotchCollar.addEventListener('click', function(){
      if (notchCollarLink && !productTitle.includes('notch collar')) {
        window.location.href = notchCollarLink;
      }
      setActiveToggle('notchcollar');
    });
  }

  // Length handlers
  var btnShortLength    = document.getElementById('btnShortLength');
  var btnMidThighLength = document.getElementById('btnMidThighLength');

  if (btnShortLength){
    btnShortLength.addEventListener('click', function(){
      if (shortLengthLink && shortLengthLink.trim() !== ''){
        if (!(productTitle.includes('short length'))) {
          window.location.href = shortLengthLink;
        }
        setActiveToggle('shortlength');
      }
    });
  }

  if (btnMidThighLength){
    btnMidThighLength.addEventListener('click', function(){
      if (midThighLengthLink && midThighLengthLink.trim() !== ''){
        if (!(productTitle.includes('mid thigh length') || productTitle.includes('mid-thigh length'))) {
          window.location.href = midThighLengthLink;
        }
        setActiveToggle('midthighlength');
      }
    });
  }

  // Fit handlers
  var btnRegularFit  = document.getElementById('btnRegularFit');
  var btnStraightFit = document.getElementById('btnStraightFit');

  if (btnRegularFit){
    btnRegularFit.addEventListener('click', function(){
      if (regularFitLink && regularFitLink.trim() !== ''){
        if (!(productTitle.includes('regular fit'))) {
          window.location.href = regularFitLink;
        }
        setActiveToggle('regularfit');
      }
    });
  }

  if (btnStraightFit){
    btnStraightFit.addEventListener('click', function(){
      if (straightFitLink && straightFitLink.trim() !== ''){
        if (!(productTitle.includes('straight fit'))) {
          window.location.href = straightFitLink;
        }
        setActiveToggle('straightfit');
      }
    });
  }

  // Lea handlers (NEW)
  var btnLea40 = document.getElementById('btnLea40');
  var btnLea44 = document.getElementById('btnLea44');

  if (btnLea40){
    btnLea40.addEventListener('click', function(){
      if (lea40Link && lea40Link.trim()!==''){
        if(!samePath(location.pathname, lea40Link)){ window.location.href = lea40Link; }
        setActiveToggle('lea40');
      }
    });
  }

  if (btnLea44){
    btnLea44.addEventListener('click', function(){
      if (lea44Link && lea44Link.trim()!==''){
        if(!samePath(location.pathname, lea44Link)){ window.location.href = lea44Link; }
        setActiveToggle('lea44');
      }
    });
  }

  // Handle bfcache back/forward navigation
  window.addEventListener('pageshow', function(e){ if(e.persisted){ updateToggleBasedOnTitle(); }});
{% endraw %}
</script>
{% endif %}

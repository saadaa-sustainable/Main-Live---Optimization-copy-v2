{%- liquid
  case context
    when 'card' or 'line_item'
      assign base_text_class = ''

      if settings.product_card_text_font == 'heading'
        assign base_text_class = 'h5 '
      endif

      assign regular_price_classes = base_text_class | append: 'text-subdued'
      assign on_sale_price_classes = base_text_class | append: 'text-on-sale'
      assign compare_at_price_classes = base_text_class | append: 'text-subdued line-through'
      assign unit_price_classes = base_text_class | append: 'text-subdued'

    when 'product'
      assign regular_price_classes = base_text_class | append: 'h4 text-subdued'
      assign on_sale_price_classes = base_text_class | append: 'h4 text-on-sale'
      assign compare_at_price_classes = base_text_class | append: 'h5 text-subdued line-through'
      assign unit_price_classes = base_text_class | append: 'h6 text-subdued'
  endcase
-%}

{%- comment -%} Custom price mapping logic (applied where product available) {%- endcomment -%}
{%- assign product_mappings = "
WOMEN|AIRY LINEN FLARED DRESS|359900|179900;
WOMEN|AIRY LINEN PANT|239900|119900;
WOMEN|AIRY-LINEN SHIRT|239900|119900;
WOMEN|AIRY LINEN STRAIGHT PANT|239900|119900;
WOMEN|AIRY LINEN WIDE LEG PANT|259800|129900;
WOMEN|COTTON PANT|159900|79900;
WOMEN|COTTON TOP|199900|99900;
WOMEN|AIRY LINEN LONG KURTA|199900|99900;
WOMEN|AIRY LINEN PANT|169900|89900;
WOMEN|AIRY-LINEN SHORTS|139900|59900;
WOMEN|AIRY LINEN SHORT KURTA|159900|79900;
WOMEN|PALAZZO|159900|79900;
WOMEN|VISCOSE PLEATED TOP|259900|129900;
WOMEN|V-NECK SLEEVELESS TOP|159900|79900;
WOMEN|FORMAL PANT|399900|149900;
WOMEN|STRAIGHT FIT FORMAL PANTS|299900|159900;
WOMEN|4-WAY STRETCHABLE PANT|299900|149900;
UNISEX|TOTE BAG|99900|49900;
WOMEN|VISCOSE PALAZZO|159900|79900;
WOMEN|WIDE LEG PANTS|399900|199900;
MEN|COTTON PANT|179800|89900;
MEN|AIRY LINEN LONG KURTA|259900|129900;
MEN|AIRY LINEN SHORT KURTA|199900|99900;
MEN|LINEN HALF SLEEVE SHIRT|439900|219900;
MEN|100% LINEN SHIRT|499900|249900;
MEN|FORMAL SHIRT|299900|149900;
MEN|PURE LINEN FULL SLEEVE|499800|249900;
MEN|PURE LINEN SHORT SLEEVE|439800|219900;
WOMEN|PURE LINEN SHIRT|499800|249900;
WOMEN|PURE LINEN NOTCH COLLAR SHIRT|439800|219900
" | split: ";" -%}

{%- assign display_price_cents = 0 -%}
{%- assign display_compare_cents = 0 -%}
{%- assign matched_mrp = 0 -%}
{%- assign matched_selling_price = 0 -%}
{%- assign current_product = blank -%}
{%- if product != blank -%}
  {%- assign current_product = product -%}
{%- elsif variant != blank and variant.product != blank -%}
  {%- assign current_product = variant.product -%}
{%- elsif line_item != blank and line_item.product != blank -%}
  {%- assign current_product = line_item.product -%}
{%- endif -%}
{%- if current_product != blank -%}
  {%- assign variant_for_mapping = current_product.selected_or_first_available_variant | default: variant | default: line_item.variant -%}
  {%- assign normalized_title = current_product.title | upcase -%}
  {%- assign title_padded = ' ' | append: normalized_title | append: ' ' -%}
  {%- assign detected_category = '' -%}
  {%- if title_padded contains ' MEN ' or title_padded contains ' MENS ' or title_padded contains " MEN'S " -%}
    {%- assign detected_category = 'MEN' -%}
  {%- elsif title_padded contains ' WOMEN ' or title_padded contains " WOMEN'S " -%}
    {%- assign detected_category = 'WOMEN' -%}
  {%- endif -%}

  {%- for mapping in product_mappings -%}
    {%- assign parts = mapping | strip | split: "|" -%}
    {%- if parts.size == 4 -%}
      {%- assign map_cat  = parts[0] | strip | upcase -%}
      {%- assign map_name = parts[1] | strip -%}
      {%- assign map_mrp  = parts[2] | strip | times: 1 -%}
      {%- assign map_sell = parts[3] | strip | times: 1 -%}
      {%- assign normalized_map_name = map_name | upcase -%}

      {%- assign cat_ok = false -%}
      {%- if map_cat == 'UNISEX' -%}
        {%- assign cat_ok = true -%}
      {%- elsif detected_category != '' and map_cat == detected_category -%}
        {%- assign cat_ok = true -%}
      {%- endif -%}

      {%- if cat_ok and normalized_title contains normalized_map_name and variant_for_mapping.price == map_sell and map_sell > 0 -%}
        {%- assign matched_mrp = map_mrp -%}
        {%- assign matched_selling_price = map_sell -%}
        {%- break -%}
      {%- endif -%}
    {%- elsif parts.size == 3 -%}
      {%- comment -%} Legacy rows without category (kept for safety) {%- endcomment -%}
      {%- assign map_name = parts[0] | strip -%}
      {%- assign map_mrp  = parts[1] | strip | times: 1 -%}
      {%- assign map_sell = parts[2] | strip | times: 1 -%}
      {%- assign normalized_map_name = map_name | upcase -%}
      {%- if normalized_title contains normalized_map_name and variant_for_mapping.price == map_sell and map_sell > 0 -%}
        {%- assign matched_mrp = map_mrp -%}
        {%- assign matched_selling_price = map_sell -%}
        {%- break -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}

  {%- assign base_price_num = variant_for_mapping.price | default: line_item.final_price | default: 0 -%}
  {%- assign base_compare_num = variant_for_mapping.compare_at_price | default: line_item.original_price | default: 0 -%}
  {%- if matched_selling_price > 0 and matched_mrp > 0 -%}
    {%- assign display_price_cents = matched_selling_price -%}
    {%- assign display_compare_cents = matched_mrp -%}
  {%- elsif base_compare_num > base_price_num -%}
    {%- assign display_price_cents = base_price_num -%}
    {%- assign display_compare_cents = base_compare_num -%}
  {%- else -%}
    {%- assign display_price_cents = base_price_num -%}
    {%- assign display_compare_cents = 0 -%}
  {%- endif -%}
{%- endif -%}

<price-list {% if form_id %}role="region" aria-live="polite"{% endif %} class="price-list {% if context == 'product' %}price-list--product{% endif %}">
  {%- if variant != blank -%}
    {%- comment -%} VARIANT CASE: Apply mapping if available, render conditional with MRP label {%- endcomment -%}
    {%- assign base_price_num = variant.price -%}
    {%- assign compare_to_show_num = variant.compare_at_price | default: base_price_num | times: 2 -%}
    {%- if display_price_cents > 0 -%}
      {%- assign base_price_num = display_price_cents -%}
      {%- if display_compare_cents > 0 -%}
        {%- assign compare_to_show_num = display_compare_cents -%}
      {%- endif -%}
    {%- endif -%}
    {%- assign is_on_sale = compare_to_show_num > base_price_num -%}
    <sale-price {% if form_id %}form="{{ form_id }}"{% endif %} class="{% if is_on_sale %}{{ on_sale_price_classes }}{% else %}{{ regular_price_classes }}{% endif %}">
      <span class="sr-only">{{ 'product.price.sale_price' | t }}</span>
      {{ base_price_num | money_without_trailing_zeros }}
    </sale-price>
    {%- if is_on_sale -%}
      <compare-at-price {% if form_id %}form="{{ form_id }}"{% endif %} class="{{ compare_at_price_classes }}">
        MRP
        <span class="sr-only">{{ 'product.price.regular_price' | t }}</span>
        <span class="c-price">{{ compare_to_show_num | money_without_trailing_zeros }}</span>
      </compare-at-price>
    {%- endif -%}

  {%- elsif line_item != blank -%}
    {%- comment -%} LINE ITEM CASE: Apply mapping if available, keep conditional {%- endcomment -%}
    {%- assign base_price_num = line_item.final_price -%}
    {%- assign compare_to_show_num = line_item.original_price -%}
    {%- if display_price_cents > 0 -%}
      {%- assign base_price_num = display_price_cents -%}
      {%- if display_compare_cents > 0 -%}
        {%- assign compare_to_show_num = display_compare_cents -%}
      {%- else -%}
        {%- assign compare_to_show_num = 0 -%}
      {%- endif -%}
    {%- endif -%}
    {%- assign is_on_sale = compare_to_show_num > base_price_num -%}
    <sale-price class="{% if is_on_sale %}{{ on_sale_price_classes }}{% else %}{{ regular_price_classes }}{% endif %}">
      <span class="sr-only">{{ 'product.price.sale_price' | t }}</span>
      {{- base_price_num | money_without_trailing_zeros -}}
    </sale-price>
    {%- if is_on_sale -%}
      <compare-at-price class="{{ compare_at_price_classes }}">
        <span class="sr-only">{{ 'product.price.regular_price' | t }}</span>
        {{- compare_to_show_num | money_without_trailing_zeros -}}
      </compare-at-price>
    {%- endif -%}

  {%- elsif product != blank -%}
    {%- comment -%} PRODUCT CASE (cards): Use custom div structure to match template exactly {%- endcomment -%}
    {%- liquid
      if product.price_varies and settings.product_price_strategy != 'from_price'
        assign variant = product.variants | sort: 'price' | last | default: product.selected_or_first_available_variant
      else
        assign variant = product.variants | sort: 'price' | first | default: product.selected_or_first_available_variant
      endif
      assign base_price_num = variant.price
      assign compare_to_show_num = variant.compare_at_price | default: 0
      if display_price_cents > 0
        assign base_price_num = display_price_cents
        assign compare_to_show_num = display_compare_cents | default: 0
      endif
      assign variant_price = base_price_num | money_without_trailing_zeros
      assign variant_compare_at_price = compare_to_show_num | money_without_trailing_zeros
      assign is_on_sale = compare_to_show_num > base_price_num
    -%}
    <div class="product-prices">
      {%- if compare_to_show_num > 0 and is_on_sale -%}
        <span class="selling-price">{{ variant_price }}</span>
        <span class="compare-at-price-wrap">MRP <span class="compare-at-price">{{ variant_compare_at_price }}</span></span>
      {%- else -%}
        <sale-price {% if form_id %}form="{{ product_form_id }}"{% endif %} class=" h4 {% if is_on_sale %}{{ on_sale_price_classes }}{% else %}{{ regular_price_classes }}{% endif %}" style="font-size: 20px;">
          <span class="sr-only">{{ 'product.price.sale_price' | t }}</span>
          {{ variant_price }}
        </sale-price>
        {%- if is_on_sale -%}
          <compare-at-price class="{{ compare_at_price_classes }}" id="compare-at-price">
            MRP
            <span class="sr-only">{{ 'product.price.regular_price' | t }}</span>
            <span class="c-price">{{ variant_compare_at_price }}</span>
          </compare-at-price>
        {%- endif -%}
      {%- endif -%}
    </div>
    {%- if product.price_varies and settings.product_price_strategy == 'from_price' -%}
      {%- comment -%} Adjust for 'from' pricing if needed, but keep simple for now {%- endcomment -%}
      {%- if is_on_sale == false -%}
        <sale-price class="{{ regular_price_classes }}">
          <span class="sr-only">{{ 'product.price.sale_price' | t }}</span>
          {{- 'product.price.from_price_html' | t: price_min: variant_price -}}
        </sale-price>
      {%- endif -%}
    {%- endif -%}

  {%- else -%}
    {%- comment -%} PLACEHOLDER CASE: Unchanged {%- endcomment -%}
    <sale-price class="{{ regular_price_classes }}">
      <span class="sr-only">{{ 'product.price.sale_price' | t }}</span>
      {{- 4999 | money -}}
    </sale-price>
  {%- endif -%}

  {%- unless hide_unit_price -%}
    {%- assign unit_price_item = variant | default: line_item | default: product.selected_or_first_available_variant -%}
    {%- if unit_price_item.unit_price or form_id != blank -%}
      <unit-price {% if form_id %}form="{{ form_id }}"{% endif %} {% unless unit_price_item.unit_price %}hidden{% endunless %} class="{{ unit_price_classes }}">
        {%- assign unit_price_measurement = unit_price_item.unit_price_measurement -%}
        {%- if unit_price_measurement.reference_value != 1 -%}
          {%- assign reference_value = unit_price_measurement.reference_value -%}
        {%- endif -%}
        ({{ unit_price_item.unit_price | money }}/{{ reference_value }}{{ unit_price_measurement.reference_unit }})
      </unit-price>
    {%- endif -%}
  {%- endunless -%}
</price-list>

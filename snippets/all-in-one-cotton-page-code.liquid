<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cotton — Pants / Pick Any 2 & 4 / Curated / Mix & Match</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --sticky-offset: 120px; }

    /* ——— Top toggles: scrollable carousel (no arrows) ——— */
    .toggle-wrap{
      position: sticky; top: 76px; z-index: 2; background:#f6f3f1;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .toggle-row {
      display: flex; gap: .8rem; padding: 12px; transition: box-shadow .15s;
      overflow-x: auto; overscroll-behavior-x: contain; -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      scrollbar-width: none; /* Firefox */
      margin-left: 10px;
    }
    .toggle-row::-webkit-scrollbar { display: none; } /* WebKit */

    .toggle-btn {
      background: #fff; color: #222; border: none; outline: none; border-radius: 8px;
      font-size: 12px; font-weight: 600; padding: 6px 14px; cursor: pointer;
      transition: background-color .22s cubic-bezier(.44,1.34,.38,1.11),
                  color .22s cubic-bezier(.44,1.34,.38,1.11),
                  transform .23s cubic-bezier(.44,1.34,.38,1.11),
                  box-shadow .22s cubic-bezier(.44,1.34,.38,1.11);
      white-space: nowrap; scroll-snap-align: start; flex: 0 0 auto;
    }
    .toggle-btn.active { background: #000; color: #fff; transform: scale(1.06); box-shadow: 0 1px 4px rgba(195,106,78,0.13); }
    @media (min-width: 701px){ .toggle-btn { font-size: 16px; padding: 8px 18px; } 
.toggle-row {
    justify-content: center;
}
}

    /* ——— Section headings ——— */
    .banner-row { scroll-margin-top: calc(var(--sticky-offset) + 10px); }
    .banner-text{
      display:block; width: 100%; background:#f6f3f1; color:#222;
      padding: 12px 16px; font-size: 18px; font-weight:700; letter-spacing:.2px;
    }
    @media (max-width:700px){ .banner-text{ font-size:20px; padding: 8px 14px; }

}

    /* ——— Grid ——— */
    .pc-page { background:#f6f3f1; }
    .pc-grid-section { padding: 0 0 2rem 0; }
    .pc-grid-outer { position: relative; top:7px; }
    .pc-grid {
      display: grid;
       grid-template-columns: repeat(0, 1fr);
      gap: 8px; margin: 0 10px;
    }


    #pick_any_2\&4{
        display: grid; grid-template-columns: repeat(0, 1fr);
    }
    @media (min-width: 701px) { .pc-grid { grid-template-columns: repeat(6, 1fr); gap: 12px; } }

    /* —— Mobile 2-row horizontal carousel for marked sections —— */
    @media (max-width: 700px){
      .pc-grid.carousel-2line{
        /* turn the grid into horizontal flow with two rows */
        grid-auto-flow: column;
        grid-template-rows: repeat(2, auto);
        grid-auto-columns: calc(40% - 6px); /* ~two items per column in view */
        overflow-x: auto; overflow-y: hidden;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 8px;
      }
      .pc-grid.carousel-2line > .pc-grid-link{
        scroll-snap-align: start;
      }



      #pick_any_2\&4{
     grid-template-columns: repeat(2, 1fr);
    }
    }

    .pc-grid-item {
       overflow: hidden; display: flex; flex-direction: column;
      cursor: pointer;
    }
   
.pc-grid-item {
  transition: transform .2s; /* was including box-shadow */
}
    .pc-product-image-wrapper { position: relative; width:100%; overflow:hidden; height:auto; }
    .pc-product-image-wrapper img { display:block; width:100%; height:auto; }

    /* —— SAVE pill —— */
    .pc-save-pill{
      position: absolute; left: 6px; top: 5px; z-index: 1;
      background:#209020; color:#fff; padding: 0px 5px; border-radius:4px;
      font-size: 8px; font-weight:800; letter-spacing:.3px; text-transform:uppercase;
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
    }

    a.pc-grid-link { text-decoration:none; color: inherit; display:block; }

    .grid-loading { display:flex;align-items:center;justify-content:center;font-size:14px;color:#ba8367; padding:2.7em 0; font-weight:500; }
    .pc-grid-empty { padding:2em;text-align:center;color:#b08065;font-size:13px; }

    /* ——— Product Title + Price ——— */
    .pc-product-title {
      padding: 8px 10px 6px;
      font-size: 11px;
      line-height: 1.3;
      color: #000;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 2.6em;
    }
    .pc-price-row {
      display: flex; align-items: center; gap: 6px;
      padding: 0px 10px 10px; background: transparent;
      justify-content: center;
    }
    .pc-price { font-size: 13px; font-weight: 700; color: #000; }
    .pc-compare { font-size: 12px; color: red; text-decoration: line-through; }

    @media (min-width: 701px){
      .pc-product-title{ font-size:15px; letter-spacing:.5px; }
      .pc-price{ font-size: 15px; }
      .pc-compare{ font-size: 13px; }
    }

    body { background:#f6f3f1; }
    
  </style>
</head>
<body class="pc-page">
  <!-- TOP TOGGLES (scrollable) -->
  <div class="toggle-wrap" id="sticky-toggle-row">
    <div class="toggle-row" id="toggle-track">
      <button class="toggle-btn active" data-target="cotton-pant">Cotton Pant</button>
      <button class="toggle-btn" data-target="pick-combo">Pick any 2 &amp; 4</button>
      <button class="toggle-btn" data-target="curated">Curated</button>
      <button class="toggle-btn" data-target="mixmatch">Mix &amp; Match</button>
    </div>
  </div>

  <!-- SECTIONS -->
  <main id="cotton-page">
    <!-- Cotton Pant (2-line carousel on mobile) -->
    <div class="banner-row" id="cotton-pant-banner"><span class="banner-text">Cotton Pant</span></div>
    <div class="pc-grid-section">
      <div class="pc-grid-outer" data-key="cotton-pant" data-2line="true">
        <div class="pc-grid"><div class="grid-loading">Loading…</div></div>
      </div>
    </div>

    <!-- Pick any 2 & 4 (stays normal grid) -->
    <div class="banner-row" id="pick-combo-banner"><span class="banner-text">Pick any 2 &amp; 4</span></div>
    <div class="pc-grid-section">
      <div class="pc-grid-outer" data-key="pick-combo">
        <div class="pc-grid" id="pick_any_2&4"><div class="grid-loading">Loading…</div></div>
      </div>
    </div>

    <!-- Curated (2-line carousel on mobile) -->
    <div class="banner-row" id="curated-banner"><span class="banner-text">Curated</span></div>
    <div class="pc-grid-section">
      <div class="pc-grid-outer" data-key="curated" data-2line="true">
        <div class="pc-grid"><div class="grid-loading">Loading…</div></div>
      </div>
    </div>

    <!-- Mix & Match (2-line carousel on mobile) -->
    <div class="banner-row" id="mixmatch-banner"><span class="banner-text">Mix &amp; Match</span></div>
    <div class="pc-grid-section">
      <div class="pc-grid-outer" data-key="mixmatch" data-2line="true">
        <div class="pc-grid"><div class="grid-loading">Loading…</div></div>
      </div>
    </div>
  </main>

<script>
  // Shopify API settings
  const SHOP_DOMAIN = "saadaa-design.myshopify.com";
  const STOREFRONT_ACCESS_TOKEN = "388bd37219d8ab7daee1c58a23c03cc8";

  // Tag map
  const tagMap = {
    "cotton-pant": "SDCP",
    "pick-combo":  ["pick any 2 cotton pant combo", "pick any 4 cotton pant combo"],
    "curated":     "pack of 2 cotton pant",
    "mixmatch":    "cotton mix match"
  };

  const inr = new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 });

  function escapeHtml(str = "") {
    return String(str)
      .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }

  function computeStickyOffset(){
    const stickyToggle = document.getElementById('sticky-toggle-row');
    const stickyH = stickyToggle ? stickyToggle.getBoundingClientRect().height : 0;
    const candidates = document.querySelectorAll('header, .site-header, .shopify-section-header-sticky, .announcement-bar');
    let topFixed = 0;
    candidates.forEach(el => {
      const cs = getComputedStyle(el);
      if ((cs.position === 'fixed' || cs.position === 'sticky')) {
        const rect = el.getBoundingClientRect();
        if (rect.top <= 1) topFixed += rect.height;
      }
    });
    const total = Math.round(stickyH + topFixed + 12);
    document.documentElement.style.setProperty('--sticky-offset', total + 'px');
  }

  async function fetchProductsBySingleTag(tag) {
    const query = `
    {
      products(first: 30, query: "tag:'${tag}'") {
        edges {
          node {
            id
            title
            handle
            publishedAt
            images(first: 1) { edges { node { url altText } } }
            variants(first: 50) {
              edges {
                node {
                  price { amount currencyCode }
                  compareAtPrice { amount currencyCode }
                }
              }
            }
          }
        }
      }
    }`;
    const response = await fetch(`https://${SHOP_DOMAIN}/api/2023-10/graphql.json`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Shopify-Storefront-Access-Token": STOREFRONT_ACCESS_TOKEN
      },
      body: JSON.stringify({ query })
    });
    const json = await response.json();
    if (!json.data || !json.data.products) return [];
    return json.data.products.edges.map(e => e.node).filter(p => p.publishedAt);
  }

  async function fetchProductsByTags(tagOrTags){
    const tags = Array.isArray(tagOrTags) ? tagOrTags : [tagOrTags];
    const all = [];
    for (const t of tags) {
      try {
        const items = await fetchProductsBySingleTag(t);
        all.push(...items);
      } catch(e){ }
    }
    const seen = new Set();
    const deduped = [];
    for (const p of all) {
      const k = p.handle || p.id;
      if (!seen.has(k)) { seen.add(k); deduped.push(p); }
    }
    return deduped;
  }

  function getMinPriceInfo(prod){
    let minPrice = Infinity, compareAtForMin = 0, currency = 'INR';
    for (const edge of (prod.variants?.edges || [])) {
      const v = edge?.node;
      const price = parseFloat(v?.price?.amount || '0');
      const cmp   = parseFloat(v?.compareAtPrice?.amount || '0');
      if (price < minPrice) { minPrice = price; compareAtForMin = cmp; currency = v?.price?.currencyCode || currency; }
    }
    if (!isFinite(minPrice)) minPrice = 0;
    return { price: minPrice, compareAt: compareAtForMin, currency };
  }

  function getSavingInfo(prod){
    let maxSave = 0; let currency = 'INR';
    const edges = prod.variants?.edges || [];
    for (const v of edges) {
      const price = parseFloat(v?.node?.price?.amount || '0');
      const compare = parseFloat(v?.node?.compareAtPrice?.amount || '0');
      const diff = compare - price;
      if (diff > maxSave) { maxSave = diff; currency = v?.node?.price?.currencyCode || currency; }
    }
    return { amount: maxSave, currency };
  }

  // ⬇️ UPDATED: allow forcing a slashed price = 2 × base price for a section
  function priceHTML(prod, { forceDoubleCompare = false } = {}){
    const { price, compareAt } = getMinPriceInfo(prod);
    const priceRounded = Math.round(price);
    const priceStr = `₹${inr.format(priceRounded)}`;

    let showCompare = false;
    let compareToShow = compareAt;

    if (forceDoubleCompare) {
      // Always show slashed price as exactly 2× base price (display only)
      compareToShow = price * 2;
      showCompare = compareToShow > price + 0.5;
    } else {
      // Normal behavior: only show if Shopify compare-at is meaningful
      showCompare = compareAt > price + 0.5;
    }

    if (showCompare) {
      const cmpStr = `₹${inr.format(Math.round(compareToShow))}`;
      return `<div class="pc-price-row"><span class="pc-price">${priceStr}</span><span class="pc-compare">${cmpStr}</span></div>`;
    }
    return `<div class="pc-price-row"><span class="pc-price">${priceStr}</span></div>`;
  }

  // ⬇️ UPDATED: pass the option down per-section
  function buildGridHTML(products, { forceDoubleCompare = false } = {}) {
    if (!products.length) return `<div class="pc-grid-empty">No products found.</div>`;
    return products.map(prod => {
      const imgUrl = prod.images?.edges?.[0]?.node?.url || "";
      const title  = escapeHtml(prod.title || "");
      const saving = getSavingInfo(prod);
      const showPill = saving.amount > 0.5;
      const rupees = inr.format(Math.round(saving.amount));
      return `
        <a class="pc-grid-link" href="/products/${prod.handle}">
          <div class="pc-grid-item">
            <div class="pc-product-image-wrapper">
              ${showPill ? `<span class="pc-save-pill">SAVE ₹${rupees}</span>` : ``}
              <img src="${imgUrl}" alt="${title}" loading="lazy" />
            </div>
            <div class="pc-product-title">${title}</div>
            ${priceHTML(prod, { forceDoubleCompare })}
          </div>
        </a>
      `;
    }).join("");
  }

  async function loadOneGrid(outer){
    const key = outer.getAttribute('data-key');
    const tagOrTags = tagMap[key];
    const grid = outer.querySelector('.pc-grid');
    grid.innerHTML = `<div class="grid-loading">Loading…</div>`;
    if (!tagOrTags) { grid.innerHTML = `<div class="pc-grid-empty">No tag set.</div>`; return; }
    try {
      const products = await fetchProductsByTags(tagOrTags);
      // ⬇️ Force fake slashed price only for the Cotton Pant section
      const html = buildGridHTML(products, { forceDoubleCompare: key === 'cotton-pant' });
      grid.innerHTML = html;
      // apply mobile 2-line carousel if marked
      applyMobileCarousels();
    } catch (e) {
      grid.innerHTML = `<div class="pc-grid-empty">Error loading products.</div>`;
    }
  }

  async function loadAllGrids(){
    const outers = document.querySelectorAll('.pc-grid-outer');
    for (const outer of outers) { loadOneGrid(outer); }
  }

  // Apply/Remove 2-line carousel class on mobile for marked sections
  function applyMobileCarousels(){
    const isMobile = window.innerWidth <= 700;
    document.querySelectorAll('.pc-grid-outer').forEach(outer => {
      const wantsTwoLine = outer.dataset['2line'] === 'true'; // data-2line="true"
      const grid = outer.querySelector('.pc-grid');
      if (!grid) return;
      if (isMobile && wantsTwoLine) grid.classList.add('carousel-2line');
      else grid.classList.remove('carousel-2line');
    });
  }

  // Scroll + active state
  function getStickyOffsetPx(){
    const v = getComputedStyle(document.documentElement).getPropertyValue('--sticky-offset') || '0';
    return parseInt(v, 10) || 0;
  }

  function scrollToSection(key){
    const el = document.getElementById(`${key}-banner`);
    if (!el) return;
    const headerOffset = getStickyOffsetPx();
    const rect = el.getBoundingClientRect();
    const absoluteTop = rect.top + window.pageYOffset;
    window.scrollTo({ top: Math.max(absoluteTop - headerOffset, 0), behavior: 'smooth' });
  }

  function setActiveToggle(key){
    document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    const btn = document.querySelector(`.toggle-btn[data-target="${key}"]`);
    if (btn) btn.classList.add('active');
  }

  let manualLockUntil = 0;
  function nowMs(){ return (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now(); }

  function updateActiveFromScroll(){
    if (nowMs() < manualLockUntil) return;
    const keys = ["cotton-pant","pick-combo","curated","mixmatch"];
    const offset = getStickyOffsetPx();
    const heads = keys.map(k => document.getElementById(`${k}-banner`)).filter(Boolean);
    if (!heads.length) return;
    const hysteresis = 6;
    const firstBelowIdx = heads.findIndex(h => (h.getBoundingClientRect().top - offset) > hysteresis);
    let currentIdx;
    if (firstBelowIdx === -1) currentIdx = heads.length - 1;
    else if (firstBelowIdx === 0) currentIdx = 0;
    else currentIdx = firstBelowIdx - 1;
    const key = heads[currentIdx].id.replace('-banner','');
    setActiveToggle(key);
  }

  document.addEventListener("DOMContentLoaded", () => {
    computeStickyOffset();
    loadAllGrids();
    updateActiveFromScroll();
    applyMobileCarousels();

    document.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const key = btn.dataset.target;
        manualLockUntil = nowMs() + 800;
        setActiveToggle(key);
        scrollToSection(key);
        setTimeout(updateActiveFromScroll, 850);
      });
    });

    window.addEventListener('scroll', updateActiveFromScroll, { passive: true });
    window.addEventListener('resize', () => {
      computeStickyOffset();
      applyMobileCarousels();
      updateActiveFromScroll();
    });
  });
</script>
</body>
</html>

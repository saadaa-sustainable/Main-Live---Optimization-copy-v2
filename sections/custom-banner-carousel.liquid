{%- style -%}
  /* --- STYLES --- */
  .bannerC-{{ section.id }} {
    width: 100%;
    max-width: {{ section.settings.container_width }}px;
    margin: 0 auto;
    padding: 0 0 16px;
    font-family: Helvetica, Arial, sans-serif;
  }

  .bannerC__viewport {
    overflow: hidden;
    border-radius: {{ section.settings.border_radius }}px;
  }

  .bannerC__track {
    display: flex;
    transition: transform 0.6s ease-in-out;
    will-change: transform;
  }

  .bannerC__slide {
    min-width: 100%;
    display: block;
    line-height: 0;
    padding: 10px;
    box-sizing: border-box;
  }

  .bannerC__slide img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: cover;
  }

  .bannerC__dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
  }

  .bannerC__dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #d6d6d6;
    border: none;
    cursor: pointer;
    padding: 0;
    transition: background 0.3s;
  }

  .bannerC__dot.is-active {
    background: #222;
  }
{%- endstyle -%}

<div class="bannerC bannerC-{{ section.id }}" aria-label="Banner carousel">
  <div class="bannerC__viewport">
    <div class="bannerC__track" id="bannerTrack-{{ section.id }}">
      
      {%- for block in section.blocks -%}
        <a class="bannerC__slide" href="{{ block.settings.link }}" {{ block.shopify_attributes }}>
          {%- if block.settings.image != blank -%}
            <img
              src="{{ block.settings.image | image_url: width: 1500 }}"
              alt="{{ block.settings.image.alt | escape }}"
              loading="lazy"
              width="{{ block.settings.image.width }}"
              height="{{ block.settings.image.height }}"
            />
          {%- else -%}
            {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' }}
          {%- endif -%}
        </a>
      {%- endfor -%}

    </div>
  </div>

  <div class="bannerC__dots" id="bannerDots-{{ section.id }}" aria-label="Carousel pagination"></div>
</div>

<script>
  (function () {
    const track = document.getElementById("bannerTrack-{{ section.id }}");
    const dotsWrap = document.getElementById("bannerDots-{{ section.id }}");
    const originalSlides = Array.from(track.querySelectorAll(".bannerC__slide"));
    const totalOriginal = originalSlides.length;

    if (totalOriginal === 0) return;

    // 1. CLONE FIRST SLIDE
    const firstClone = originalSlides[0].cloneNode(true);
    firstClone.setAttribute("aria-hidden", "true");
    track.appendChild(firstClone);

    let index = 0;
    let timer = null;
    const INTERVAL_MS = {{ section.settings.autoplay_speed | times: 1000 }}; 
    let isTransitioning = false; 

    // 2. BUILD DOTS
    originalSlides.forEach((_, i) => {
      const dot = document.createElement("button");
      dot.type = "button";
      dot.className = "bannerC__dot" + (i === 0 ? " is-active" : "");
      dot.setAttribute("aria-label", `Go to slide ${i + 1}`);
      dot.addEventListener("click", () => {
        if (isTransitioning) return;
        goTo(i);
        restart();
      });
      dotsWrap.appendChild(dot);
    });

    function setActiveDot(i) {
      const dots = dotsWrap.querySelectorAll(".bannerC__dot");
      const targetIndex = i % totalOriginal;
      dots.forEach((d, di) => d.classList.toggle("is-active", di === targetIndex));
    }

    function slideTo(idx, withTransition = true) {
      isTransitioning = true;
      track.style.transition = withTransition ? "transform 0.6s ease-in-out" : "none";
      track.style.transform = `translateX(-${idx * 100}%)`;
    }

    function goTo(i) {
      index = i;
      slideTo(index);
      setActiveDot(index);
    }

    function next() {
      if (isTransitioning) return;
      index++;
      slideTo(index);
      setActiveDot(index);
    }

    track.addEventListener("transitionend", () => {
      isTransitioning = false;
      if (index === totalOriginal) {
        track.style.transition = "none";
        index = 0;
        track.style.transform = `translateX(0)`;
        void track.offsetWidth; 
      }
    });

    function start() {
      if ({{ section.settings.autoplay }}) {
        stop();
        timer = setInterval(next, INTERVAL_MS);
      }
    }

    function stop() {
      if (timer) clearInterval(timer);
      timer = null;
    }

    function restart() { start(); }

    const wrapper = track.closest(".bannerC");
    wrapper.addEventListener("mouseenter", stop);
    wrapper.addEventListener("mouseleave", start);

    /* SWIPE SUPPORT */
    let startX = 0, currentX = 0, isDraggingPointer = false;
    const SWIPE_THRESHOLD = 60;

    function onDragStart(x) {
      if (isTransitioning) return;
      startX = x;
      isDraggingPointer = true;
      stop();
      track.style.transition = "none";
    }

    function onDragMove(x) {
      if (!isDraggingPointer) return;
      currentX = x;
      const delta = currentX - startX;
      track.style.transform = `translateX(calc(-${index * 100}% + ${delta}px))`;
    }

    function onDragEnd() {
      if (!isDraggingPointer) return;
      isDraggingPointer = false;
      const delta = currentX - startX;
      track.style.transition = "transform 0.6s ease-in-out";

      if (Math.abs(delta) > SWIPE_THRESHOLD) {
        if (delta < 0) next();
        else goTo(Math.max(index - 1, 0));
      } else {
        slideTo(index);
      }
      restart();
    }

    track.addEventListener("touchstart", e => onDragStart(e.touches[0].clientX), { passive: true });
    track.addEventListener("touchmove", e => onDragMove(e.touches[0].clientX), { passive: true });
    track.addEventListener("touchend", onDragEnd);
    track.addEventListener("mousedown", e => { e.preventDefault(); onDragStart(e.clientX); });
    window.addEventListener("mousemove", e => onDragMove(e.clientX));
    window.addEventListener("mouseup", onDragEnd);

    start();
  })();
</script>

{% schema %}
{
  "name": "Custom Banner Carousel",
  "settings": [
    {
      "type": "range",
      "id": "container_width",
      "min": 800,
      "max": 1600,
      "step": 20,
      "unit": "px",
      "label": "Max Container Width",
      "default": 980
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Corner Roundness",
      "default": 10
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable Autoplay",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 1,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Autoplay Speed",
      "default": 3
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Banner Image"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Slide Link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Banner Carousel",
      "blocks": [
        { "type": "slide" },
        { "type": "slide" }
      ]
    }
  ]
}
{% endschema %}
{% schema %}
{
  "name": "Valentine Specific",
  "settings": [
    {
      "type": "header",
      "content": "Section Configuration"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#FFF5F7"
    }
  ],
  "blocks": [
    {
      "type": "category",
      "name": "Category / Roundel",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Roundel Image"
        },
        {
          "type": "text",
          "id": "label_line_1",
          "label": "Roundel Label Line 1",
          "default": "Women"
        },
        {
          "type": "text",
          "id": "label_line_2",
          "label": "Roundel Label Line 2",
          "default": "Topwear"
        },
        {
          "type": "text",
          "id": "banner_title",
          "label": "Section Banner Title",
          "default": "Women Topwear"
        },
        {
          "type": "textarea",
          "id": "tags",
          "label": "Product Tags (Comma Separated)",
          "info": "Enter tags (e.g., 'SDCP, SDCSP'). The logic will find the product with the HIGHEST INVENTORY for each tag.",
          "default": "SDCP, SDCSP"
        },
        {
          "type": "checkbox",
          "id": "show_all",
          "label": "Show multiple products per tag",
          "info": "If checked, shows ALL products found (up to 10) for these tags. If unchecked, shows only the single highest inventory item per tag.",
          "default": false
        },
        {
          "type": "text",
          "id": "badge_text",
          "label": "Offer Badge Text",
          "default": "Use Code - B2G10"
        },
        {
          "type": "header",
          "content": "Title Display Options"
        },
        {
          "type": "checkbox",
          "id": "show_gender",
          "label": "Show Gender in Title (e.g., 'Women')",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "show_color",
          "label": "Show Color in Title (e.g., 'Sky Blue')",
          "default": false
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Valentine Specific",
      "blocks": [
        { 
          "type": "category", 
          "settings": { 
            "label_line_1": "Behtar", 
            "label_line_2": "Linen", 
            "banner_title": "Behtar Linen Collection" 
          } 
        },
        { 
          "type": "category", 
          "settings": { 
            "label_line_1": "Women", 
            "label_line_2": "Topwear" 
          } 
        }
      ]
    }
  ]
}
{% endschema %}

{% style %}
  /* ——— Scoped Variables ——— */
  #shopify-section-{{ section.id }} {
    --val-bg-color: {{ section.settings.bg_color }};
    --sticky-offset: 120px;
  }

  /* 1. Global Backgrounds */
  #shopify-section-{{ section.id }} .pc-grid-section, 
  #shopify-section-{{ section.id }} .banner-text, 
  #shopify-section-{{ section.id }} #sticky-roundels {
    background-color: var(--val-bg-color) !important;
  }

  /* ——— Offer strip ABOVE image ——— */
  .pc-offer-strip {
    display:block; width:100%; position:relative;
    padding:4px 8px; text-align:center; font-size:7px; font-weight:600;
    letter-spacing:.4px; text-transform:uppercase; color:#fff !important;
    background: linear-gradient(135deg, #FF8FA3 0%, #FF4D6D 100%) !important;
    border: none !important;
    box-shadow: 0 4px 14px rgba(0,0,0,.12);
    overflow:hidden; isolation:isolate;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }

  .pc-offer-strip::after {
    content:""; position:absolute; top:0; bottom:0; left:-130%; width:120%;
    background: linear-gradient(115deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0) 32%, rgba(255,255,255,.65) 48%, rgba(255,255,255,0) 64%, rgba(255,255,255,0) 100%);
    transform:skewX(-20deg); animation:badgeShine 2.2s linear infinite; pointer-events:none; opacity: 0.3;
  }
  @keyframes badgeShine { 0% { left:-130%; } 100% { left:130%; } }
  @media (min-width:701px){ .pc-offer-strip{ font-size:12px; padding:8px 12px; } }

  /* ——— ROUNDels (sticky) ——— */
  #sticky-roundels {
    position: sticky; top: 73px; z-index: 10;
    padding: 10px 0; 
    border-bottom: 1px solid rgba(255, 182, 193, 0.4) !important;
    box-shadow: 0 4px 20px rgba(227, 24, 55, 0.05);
    transition: top 0.3s ease;
  }
  
  .roundel-row {
    display:flex; gap:10px; align-items:center; justify-content:center;
    overflow-x:auto; -webkit-overflow-scrolling:touch; padding: 2px 10px;
    scroll-snap-type:x mandatory;
  }
  .roundel-row::-webkit-scrollbar{ display:none; }

  .category-item {
    display:flex; flex-direction:column; align-items:center; cursor:pointer;
    flex:0 0 auto; scroll-snap-align:center; text-decoration:none; color:inherit;
  }
  
  .category-image-wrapper {
    position:relative; display:inline-block; padding:2px;
    border:2px solid transparent; border-radius:50%; transition:all 0.2s;
  }
  .category-image {
    width: 88px; height: 88px; object-fit:cover; border-radius:50%; display:block;
  }
  
  /* The Checkmark Badge */
  .category-check {
    display:none; position:absolute; bottom:4px; right: 1px;
    width: 16px; height: 16px;
    background:#FF4D6D !important; border-radius:50%; padding:2px; border:2px solid #fff !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  .category-label {
    margin-top:.45rem; font-size:.8rem;
    color:#8C6A70 !important; /* Muted earthy pink */
    font-weight:500 !important;
    text-align:center; line-height:1.15;
    display:flex; flex-direction:column; align-items:center;
    min-height:2.4em; white-space:normal;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .category-label .label-line{ display:block; }

  /* Active State */
  .roundel-row input[type="radio"]{ display:none; }
  .roundel-row input[type="radio"]:checked + .category-image-wrapper {
    border-color: #FF4D6D !important; /* Soft Valentine Red */
    box-shadow: 0 0 0 4px rgba(255, 77, 109, 0.1);
  }
  .roundel-row input[type="radio"]:checked + .category-image-wrapper .category-check { display:block; }
  .roundel-row input[type="radio"]:checked ~ .category-label { 
    color: #C9184A !important; 
    font-weight: 700 !important; 
  }

  @media (max-width:700px){
    .roundel-row{ justify-content:flex-start; }
    .category-image{ width:16vw; height:16vw; }
    .category-label{ font-size:.58rem; }
  }

  /* ——— Category Heading ——— */
  .banner-row { scroll-margin-top: calc(var(--sticky-offset) + 8px); }
  .banner-text {
    display:block; width:100%; color:#590D22 !important;
    padding: 6px 14px; font-size:22px; font-weight:700; letter-spacing:.2px;
    text-align: center; font-family: 'Georgia', serif; font-style: italic;
    background: transparent !important;
  }
  .banner-text::after {
    content: "♥"; display: block; font-size: 14px; color: #FFB3C1; font-style: normal;
  }
  @media (min-width:701px){ .banner-text{ font-size:24px; padding:14px 16px; } }

  /* ——— Card ——— */
  .pc-grid-section { padding:0 0 2rem 0; }
  .pc-grid-outer { position:relative; top:7px; }

  .pc-carousel { position:relative; }
  .pc-carousel-track {
    display:flex; gap:8px; padding:0 10px; margin:0; overflow-x:auto; -webkit-overflow-scrolling:touch;
    scroll-snap-type:x mandatory; scroll-behavior:smooth; margin-left:14px;
    

  }
  .pc-carousel-track::-webkit-scrollbar { height:6px; }
  .pc-carousel-track::-webkit-scrollbar-thumb { background: rgba(0,0,0,.15); border-radius:4px; }

  /* Centering modifier for few items */
  .pc-carousel-track.is-centered {
    justify-content: center;
  }
  
  /* Fix Equal Height and Full Width */
  .pc-carousel-item { 
    flex:0 0 39%; scroll-snap-align:start; 
    min-width: 145px; 
    display: flex !important; flex-direction: column !important; height: auto !important; 
  }
  @media (min-width:701px){
    .pc-carousel-track{ gap:12px; padding:0 16px; padding-bottom: 40px; }
    .pc-carousel-item{ flex:0 0 15.5%; min-width: 220px; } 
  }

  a.pc-grid-link { 
    text-decoration:none; color:inherit; display:block; 
    display: flex !important; flex-direction: column !important; flex: 1 !important; height: 100% !important;
  }

  .pc-grid-item { 
    overflow: hidden; display: flex; flex-direction: column; cursor: pointer; 
    background: #fff; border-radius: 12px; 
    box-shadow: 0 8px 24px rgba(149, 157, 165, 0.08) !important;
    border: 1px solid #FFE5EC; 
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    margin-bottom: 5px; flex: 1 !important; justify-content: flex-start !important;
    height: 100% !important; 
  }
  .pc-grid-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 28px rgba(255, 77, 109, 0.15) !important;
  }

  .pc-product-image-wrapper { 
    position: relative; width: 100%;
    aspect-ratio: 3 / 4; 
    flex-shrink: 0;
  }
  .pc-product-image-wrapper img { display: block; width: 100%; height: 100%; object-fit: cover; }

  .pc-product-title { 
    padding: 28px 10px 10px; 
    text-align:center; font-size: 10px; line-height: 1.3; color: #444 !important;
    -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; 
    font-weight: 400 !important; font-family: 'Segoe UI', sans-serif;
    flex-grow: 1 !important; margin-bottom: 0 !important;
  }
  @media (min-width:701px){ .pc-product-title{ font-size:15px; letter-spacing:.5px; padding: 50px 10px 10px;} }

  .pc-price-row { 
    display:flex; align-items:baseline; padding:0 10px 12px; gap:8px; justify-content:center; 
    margin-top: auto !important;
  }
  .pc-product-price { padding:0; font-size:12px; line-height:1.2; color:#A4133C !important; font-weight:600 !important; }
  .pc-product-compare { font-size:12px; line-height:1.2; color:#FFB3C1 !important; text-decoration:line-through; font-weight:700; opacity:.95; }
  @media (min-width:701px){ .pc-product-price, .pc-product-compare{ font-size:14px; } }

  /* Arrows */
  .pc-nav-btn {
    position:absolute; top:40%; transform:translateY(-50%); background:#fff; border:1px solid #FFCCD5 !important;
    border-radius:50%; width:40px; height:40px; display:grid; place-items:center; cursor:pointer;
    box-shadow:0 4px 12px rgba(255, 77, 109, 0.15) !important; z-index:2; transition:opacity .18s;
    color: #FF4D6D !important;
  }
  .pc-nav-prev { left:8px; }
  .pc-nav-next { right:8px; }
  
  .pc-nav-btn:hover {
    box-shadow: 0 4px 12px rgba(255, 77, 109, 0.2);
    background: #FFF0F3 !important;
  }
  .pc-nav-btn.is-visible {
    opacity: 1;
    pointer-events: auto;
  }
  .pc-nav-btn.is-hidden { opacity:0; pointer-events:none; }

  @media (max-width:700px){ 
    .pc-nav-btn{ display:none !important; } 
    .pc-carousel-track.is-centered { justify-content: flex-start; } 
  }

  .pc-loading { text-align:center; padding:20px; font-size:12px; color:#b08065; }
{% endstyle %}

<div class="valentine-wrapper">
  
  <div id="sticky-roundels" aria-label="Category roundels">
    <div class="roundel-row" role="tablist">
      {% for block in section.blocks %}
        {% assign cat_id = "cat-" | append: block.id %}
        <label class="category-item" data-cat="{{ cat_id }}" role="tab" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
          <input type="radio" name="val_cat" {% if forloop.first %}checked{% endif %}/>
          <span class="category-image-wrapper">
            {% if block.settings.image != blank %}
              <img class="category-image" src="{{ block.settings.image | image_url: width: 200 }}" loading="lazy">
            {% else %}
              <img class="category-image" src="https://via.placeholder.com/100x100?text=IMG">
            {% endif %}
            <svg class="category-check" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12" />
            </svg>
          </span>
          <span class="category-label">
            <span class="label-line">{{ block.settings.label_line_1 }}</span>
            <span class="label-line">{{ block.settings.label_line_2 }}</span>
          </span>
        </label>
      {% endfor %}
    </div>
  </div>

  {% for block in section.blocks %}
    {% assign cat_id = "cat-" | append: block.id %}
    
    <div class="banner-row" id="{{ cat_id }}-banner">
      <span class="banner-text">{{ block.settings.banner_title }}</span>
    </div>
    
    <div class="pc-grid-section">
      <div class="pc-grid-outer">
        <div class="pc-carousel" id="carousel-{{ cat_id }}">
          
          <button class="pc-nav-btn pc-nav-prev" id="prev-btn-{{ cat_id }}" aria-label="Previous">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
          </button>
          
          <div class="pc-carousel-track" id="track-{{ cat_id }}">
            <div class="pc-loading">Loading {{ block.settings.label_line_1 }}...</div>
          </div>
          
          <button class="pc-nav-btn pc-nav-next" id="next-btn-{{ cat_id }}" aria-label="Next">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </button>
          
        </div>
      </div>
    </div>
  {% endfor %}

</div>

<script>
  (function(){
    const inr = new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 });

    // 1. GATHER DATA
    const categories = [
      {% for block in section.blocks %}
        {
          id: "cat-{{ block.id }}",
          tagsRaw: "{{ block.settings.tags | escape }}",
          badge: "{{ block.settings.badge_text | escape }}",
          showGender: {{ block.settings.show_gender | default: false }},
          showColor: {{ block.settings.show_color | default: false }},
          showAll: {{ block.settings.show_all | default: false }} 
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    // 2. FETCH LOGIC
    async function fetchProductsForCategory(catData) {
      // Parse tags to separate clean tag name from price overrides
      const rawTags = catData.tagsRaw.split(',').map(t => t.trim()).filter(t => t !== '');
      if (rawTags.length === 0) return [];

      // Create objects: { clean: "SDCP", price: 799, compare: 999 }
      const parsedTags = rawTags.map(t => {
        const parts = t.split(':');
        return {
          clean: parts[0].trim(),
          price: parts[1] ? parseFloat(parts[1]) : null,
          compare: parts[2] ? parseFloat(parts[2]) : null
        };
      });

      let queryParts = [];
      parsedTags.forEach((pt, index) => {
        // Query using the Clean Tag Name
        queryParts.push(`
          t${index}: products(first: 10, query: "tag:'${pt.clean}'") {
            edges {
              node {
                title
                handle
                onlineStoreUrl
                totalInventory
                variantName: metafield(namespace: "custom", key: "product_variant_name") { value }
                images(first: 1) { edges { node { url } } }
                variants(first: 25) {
                  edges {
                    node {
                      price { amount }
                      compareAtPrice { amount }
                      quantityAvailable
                    }
                  }
                }
              }
            }
          }
        `);
      });

      const fullQuery = `{ ${queryParts.join('\n')} }`;

      try {
        const response = await fetch("https://saadaa-design.myshopify.com/api/2024-07/graphql.json", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json", 
            "X-Shopify-Storefront-Access-Token": "388bd37219d8ab7daee1c58a23c03cc8" 
          },
          body: JSON.stringify({ query: fullQuery })
        });
        
        const json = await response.json();
        if (json.errors || !json.data) return [];

        let finalProducts = [];
        let usedHandles = new Set();
        let usedColors = new Set(); 

        // Loop through the parsed tags so we have access to the price overrides
        parsedTags.forEach((pt, index) => {
          const aliasKey = `t${index}`;
          const edges = json.data[aliasKey]?.edges || [];
          
          if(edges.length > 0) {
            // Sort by Inventory (High to Low)
            const getVariantStock = (p) => {
              return p.variants.edges.reduce((sum, v) => sum + (v.node.quantityAvailable || 0), 0);
            };

            const candidates = edges.map(e => e.node).sort((a, b) => {
               return getVariantStock(b) - getVariantStock(a);
            });

            // Prepare Override Object
            const overrides = { price: pt.price, compare: pt.compare };

            if (catData.showAll) {
              // ——— SHOW ALL LOGIC ———
              candidates.forEach(c => {
                 if (!usedHandles.has(c.handle)) {
                    usedHandles.add(c.handle);
                    finalProducts.push(normalizeProduct(c, catData, overrides));
                 }
              });

            } else {
              // ——— ONE WINNER LOGIC ———
              let winner = null;
              for (let c of candidates) {
                 const h = c.handle;
                 const col = c.variantName?.value || "Unknown";
                 
                 if (usedHandles.has(h)) continue; 
                 if (usedColors.has(col)) continue; 
                 
                 winner = c; 
                 break;
              }

              if (!winner) {
                 winner = candidates.find(c => !usedHandles.has(c.handle));
              }

              if (winner) {
                 usedHandles.add(winner.handle);
                 if (winner.variantName?.value) {
                   usedColors.add(winner.variantName.value);
                 }
                 finalProducts.push(normalizeProduct(winner, catData, overrides));
              }
            }
          }
        });

        return finalProducts;

      } catch (err) {
        console.error("Fetch error", err);
        return [];
      }
    }

    // UPDATED: Now accepts 'overrides' argument
    function normalizeProduct(p, catData, overrides) {
      const firstVariant = p.variants.edges[0]?.node;
      
      // ——— DYNAMIC TITLE CLEANING ———
      let displayTitle = p.title;
      
      if (!catData.showGender) {
        displayTitle = displayTitle.replace(/^(Women|Men|Women's|Men's)\s+/i, "");
      }
      
      if (!catData.showColor && p.variantName?.value) {
         const re = new RegExp(`\\b${p.variantName.value}\\b`, 'gi');
         displayTitle = displayTitle.replace(re, "");
      }
      
      displayTitle = displayTitle.replace(/\s+/g, ' ').trim();

      // ——— PRICE LOGIC ———
      let finalPrice, finalCompare;

      if (overrides && overrides.price !== null) {
        // Use Manual Overrides from Tag
        finalPrice = overrides.price;
        // If compare is provided in tag, use it. If not, use Price * 2
        finalCompare = overrides.compare !== null ? overrides.compare : (finalPrice * 2);
      } else {
        // Use Shopify Real Data
        const backendPrice = parseFloat(firstVariant?.price?.amount || 0);
        finalPrice = backendPrice;
        finalCompare = backendPrice * 2;
      }
      
      return {
        title: displayTitle,
        link: p.onlineStoreUrl || `https://saadaa.in/products/${p.handle}`,
        image: p.images.edges[0]?.node?.url || "",
        price: finalPrice,
        compare: finalCompare,
        badge: catData.badge
      };
    }

    function buildCardHTML(item) {
      return `
        <a class="pc-grid-link" href="${item.link}">
          <div class="pc-grid-item">
            <div class="pc-product-image-wrapper">
              <div class="pc-offer-strip">${item.badge}</div>
              <img src="${item.image}" alt="${item.title}" loading="lazy" />
            </div>
            <div class="pc-product-title">${item.title}</div>
            <div class="pc-price-row">
              <div class="pc-product-price">₹${inr.format(item.price)}</div>
              <div class="pc-product-compare">₹${inr.format(item.compare)}</div>
            </div>
          </div>
        </a>
      `;
    }

    // 3. INITIALIZATION
    async function initSection() {
      for (const cat of categories) {
        const track = document.getElementById(`track-${cat.id}`);
        if(track) {
          const products = await fetchProductsForCategory(cat);
          if (products.length > 0) {
            // Add centering class if fewer than 5 items
            if(products.length < 5) track.classList.add('is-centered');
            else track.classList.remove('is-centered');

            track.innerHTML = products.map(item => `<div class="pc-carousel-item">${buildCardHTML(item)}</div>`).join('');
          } else {
            track.innerHTML = '<div class="pc-loading">No products found for tags.</div>';
          }
          
          // Init Arrows for this specific track
          initArrows(cat.id);
          updateArrows(cat.id);
        }
      }
      setupStickyNav();
    }

    // ——— ARROW LOGIC (PER CATEGORY) ———
    function updateArrows(catId) {
      const track = document.getElementById(`track-${catId}`);
      const prevBtn = document.getElementById(`prev-btn-${catId}`);
      const nextBtn = document.getElementById(`next-btn-${catId}`);
      
      if(!track || !prevBtn || !nextBtn) return;

      const max = Math.max(0, track.scrollWidth - track.clientWidth);
      
      // Smart Hide Logic
      if (max <= 0) {
         prevBtn.classList.remove('is-visible');
         nextBtn.classList.remove('is-visible');
         return;
      }

      const x = Math.round(track.scrollLeft);
      
      // Left Arrow Visibility
      if (x > 10) prevBtn.classList.add('is-visible'); 
      else prevBtn.classList.remove('is-visible');
      
      // Right Arrow Visibility
      if (x < max - 10) nextBtn.classList.add('is-visible');
      else nextBtn.classList.remove('is-visible');
    }

    function initArrows(catId) {
      const track = document.getElementById(`track-${catId}`);
      const prevBtn = document.getElementById(`prev-btn-${catId}`);
      const nextBtn = document.getElementById(`next-btn-${catId}`);

      if(prevBtn && nextBtn && track) {
        const scrollAmount = () => Math.max(track.clientWidth * 0.9, 320);

        prevBtn.onclick = () => { 
          track.scrollBy({ left: -scrollAmount(), behavior: 'smooth' }); 
          setTimeout(() => updateArrows(catId), 350); 
        };
        nextBtn.onclick = () => { 
          track.scrollBy({ left: scrollAmount(), behavior: 'smooth' }); 
          setTimeout(() => updateArrows(catId), 350); 
        };
        
        track.onscroll = () => updateArrows(catId);
        window.addEventListener('resize', () => updateArrows(catId));
      }
    }

    function setupStickyNav() {
      const roundelItems = document.querySelectorAll('#sticky-roundels .category-item');
      const roundelRow = document.querySelector('.roundel-row');
      let lastActiveCat = null;
      
      function getStickyOffset() {
        const sticky = document.getElementById('sticky-roundels');
        let offset = sticky ? sticky.offsetHeight : 80;
        const header = document.querySelector('.site-header'); 
        
        // Robust check for sticky or fixed headers (common in Shopify)
        if(header) {
           const style = getComputedStyle(header);
           if(style.position === 'sticky' || style.position === 'fixed') {
              offset += header.offsetHeight;
           }
        }
        // Return base offset
        return offset;
      }

      // Click Handler (Manual Selection)
      roundelItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const catId = item.getAttribute('data-cat');
          const target = document.getElementById(`${catId}-banner`);
          
          if(target) {
            // Click destination: Exact top with correct buffer (60px)
            const offset = getStickyOffset() + 75; 
            const elementPosition = target.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - offset;
            
            window.scrollTo({ top: offsetPosition, behavior: "smooth" });
          }
        });
      });

      // Scroll Spy (Automatic Selection & Horizontal Scroll)
      window.addEventListener('scroll', () => {
        let current = categories[0].id; // Default to first
        
        // ——— INCREASED BUFFER FOR EARLIER TRIGGER ———
        // Added +150px so it triggers when the title is well below the sticky header (fully visible)
        const offset = getStickyOffset() + 150; 

        // Loop to find which section is active
        categories.forEach(cat => {
          const section = document.getElementById(`${cat.id}-banner`);
          if(section) {
            const sectionTop = section.offsetTop;
            // Checks if we have scrolled past the point where the section should be active
            if(window.pageYOffset >= sectionTop - offset) { 
              current = cat.id; 
            }
          }
        });

        // Only update if changed
        if(current && current !== lastActiveCat) {
          lastActiveCat = current;

          // 1. Update Radio Buttons
          roundelItems.forEach(r => {
            const isActive = r.getAttribute('data-cat') === current;
            r.setAttribute('aria-selected', isActive);
            r.querySelector('input').checked = isActive;
          });

          // 2. Auto-Scroll Roundel Bar (Center Active Item)
          const activeItem = document.querySelector(`.category-item[data-cat="${current}"]`);
          if(activeItem && roundelRow) {
            const itemLeft = activeItem.offsetLeft;
            const itemWidth = activeItem.offsetWidth;
            const containerWidth = roundelRow.offsetWidth;
            
            // Calculate center position
            const scrollPos = itemLeft - (containerWidth / 2) + (itemWidth / 2);
            
            roundelRow.scrollTo({
              left: scrollPos,
              behavior: 'smooth'
            });
          }
        }
      }, { passive: true });
    }

    initSection();
  })();
</script>
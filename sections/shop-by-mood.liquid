{% schema %}
{
  "name": "Shop By Mood",
  "settings": [
    {
      "type": "text",
      "id": "heading_start",
      "label": "Heading Text (Regular)",
      "default": "SHOP BY"
    },
    {
      "type": "text",
      "id": "heading_bold",
      "label": "Heading Text (Bold)",
      "default": "MOOD"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Sub Heading",
      "default": "Whatever the plan - start here"
    },
    {
      "type": "color",
      "id": "active_color",
      "label": "Active Border Color",
      "default": "#C36A4E"
    }
  ],
  "blocks": [
    {
      "type": "mood",
      "name": "Mood Category",
      "settings": [
        {
          "type": "select",
          "id": "gender",
          "label": "Gender Category",
          "options": [
            { "value": "women", "label": "Women" },
            { "value": "men", "label": "Men" }
          ],
          "default": "women"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Banner Image (With Text)"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Mood Title",
          "info": "Used for the section header below the toggles.",
          "default": "Everyday Wear"
        },
        {
          "type": "textarea",
          "id": "tag",
          "label": "Product Tags (Format: Tag:Count)",
          "info": "E.g: 'SDCP:15, SDCSP'. Add ':Number' to define color count. Default shows 1 product per tag.",
          "default": "SDCP:15, SDCSP"
        },
        {
          "type": "checkbox",
          "id": "show_all",
          "label": "Show multiple products per tag",
          "info": "If checked, shows ALL products found (up to 10) for these tags. If unchecked, shows only the single highest inventory item per tag.",
          "default": false
        },
        {
          "type": "url",
          "id": "link",
          "label": "View All Link"
        },
        {
          "type": "header",
          "content": "Title Display Options"
        },
        {
          "type": "checkbox",
          "id": "show_gender",
          "label": "Show Gender in Title (e.g., 'Women')",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "show_color",
          "label": "Show Color in Title (e.g., 'Sky Blue')",
          "default": false
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Shop By Mood",
      "blocks": [
        { "type": "mood", "settings": { "gender": "women", "title": "Everyday Wear" } },
        { "type": "mood", "settings": { "gender": "men", "title": "Everyday Wear" } }
      ]
    }
  ]
}
{% endschema %}

{% style %}
  #shopify-section-{{ section.id }} {
    --active-border-color: {{ section.settings.active_color }};
  }

  .mood-section-container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 0 20px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  /* ——— HEADER UI ——— */
  .mood-header {
    text-align: center;
    margin-bottom: 20px;
  }
  .mood-main-title {
    font-size: 28px;
    color: #000;
    margin: 0 0 8px 0;
    text-transform: uppercase;
    letter-spacing: 1px;
    line-height: 1.2;
  }
  .mood-main-title span { font-weight: 400; }
  .mood-main-title strong { font-weight: 600; }
  
  .mood-header p {
    font-size: 18px;
    color: #222;
    font-weight: 400;
    margin: 0;
  }

  /* ——— GENDER TOGGLES ——— */
  .gender-toggle-row {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 30px;
  }
  
  .gender-btn {
    border: 1px solid #ddd;
    background: #fff;
    color: #000;
    border-radius: 8px;
    padding: 10px 40px;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-width: 140px;
    transition: all 0.2s ease;
  }
  
  .gender-btn:hover { border-color: #000; }
  
  .gender-btn.is-selected { 
    background: #000; 
    color: #fff; 
    border-color: #000; 
  }

  /* ——— MOOD BANNERS (TOGGLES) ——— */
  .mood-toggles-track {
    display: flex;
    gap: 5px;
    overflow-x: auto;
    padding-bottom: 10px;
    margin-bottom: 10px;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
  }
  .mood-toggles-track::-webkit-scrollbar { display: none; }

  .mood-card {
    position: relative;
    flex: 0 0 200px;
    height: 100px;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.2s ease, border-color 0.2s ease;
    border: 2px solid transparent; 
  }
  
  /* Active State for Banner: Colored Border */
  .mood-card.is-active {
    border-color: var(--active-border-color);
  }

  @media(max-width: 768px) {
    .mood-card { flex: 0 0 180px; height: auto; }
    .mood-main-title { font-size: 24px; }
    .mood-header p { font-size: 18px; }
    .gender-btn { padding: 5px 7px; min-width: 87px; font-size: 12px; }
  }

  .mood-card img {
    width: 100%;
    height: auto;
    object-fit: cover;
    border-radius: 10px;
    padding: 3px;
    padding-bottom:0px
    display: block;
  }

  /* ——— PRODUCT CAROUSEL ——— */
  .product-section-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-top: 10px;
    margin-bottom: 20px;
    padding: 0 5px;
  }

  .current-mood-title { font-size: 22px; font-weight: 500; color: #111; margin: 0; }
  .view-all-link { font-size: 14px; text-decoration: underline; color: #666; cursor: pointer; }

  .product-carousel { 
    position: relative; 
    min-height: 300px; 
  }
  
  .product-track {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding-bottom: 20px;
    scroll-behavior: smooth;
    scrollbar-width: none;
  }
  .product-track::-webkit-scrollbar { display: none; }

  /* ——— ARROW NAVIGATION (DESKTOP ONLY) ——— */
  .mood-nav-btn {
    position: absolute;
    top: 40%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 2;
    transition: all 0.2s ease;
    opacity: 0; /* Hidden by default */
    pointer-events: none;
  }
  .mood-nav-btn:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    background: #f9f9f9;
  }
  .mood-nav-btn.is-visible {
    opacity: 1;
    pointer-events: auto;
  }
  
  .mood-nav-prev { left: -10px; }
  .mood-nav-next { right: -10px; }

  @media(max-width: 768px) {
    .mood-nav-btn { display: none !important; }
  }

  .product-card {
    flex: 0 0 220px;
    display: flex;
    flex-direction: column;
    text-decoration: none;
    color: inherit;
  }
  @media(max-width: 768px) { .product-card { flex: 0 0 170px; } }

  .p-image-wrap {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 10px;
    background-color: #f4f4f4;
    aspect-ratio: 2/3;
  }
  .p-image-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; }

  .p-overlay-text {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    padding: 30px 10px 8px;
    background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 100%);
    color: #fff;
  }
  .p-title { font-size: 13px; margin-bottom: 4px; line-height: 1.3; font-weight: 500; }
  .p-meta { font-size: 10px; opacity: 0.9; text-transform: uppercase; }

  .p-info { padding: 0 4px; }
  .p-colors { font-size: 11px; color: #666; margin-bottom: 4px; }
  .p-price-row { display: flex; gap: 8px; align-items: baseline; }
  .p-price { font-weight: 700; font-size: 15px; color: #111; }
  .p-compare { text-decoration: line-through; color: #ff5a5a; font-size: 13px; font-weight: 500; }
  
  .loading-msg { width: 100%; text-align: center; padding: 40px; color: #666; font-size: 14px; }
{% endstyle %}

<div class="mood-section-container" id="mood-section-{{ section.id }}">
  
  <div class="mood-header">
    <h2 class="mood-main-title">
      <span>{{ section.settings.heading_start }}</span> <strong>{{ section.settings.heading_bold }}</strong>
    </h2>
    {% if section.settings.subheading != blank %}
      <p>{{ section.settings.subheading }}</p>
    {% endif %}
  </div>

  <div class="gender-toggle-row">
    <button class="gender-btn is-selected" id="btn-women-{{ section.id }}" onclick="switchGender('women', '{{ section.id }}')">WOMEN</button>
    <button class="gender-btn" id="btn-men-{{ section.id }}" onclick="switchGender('men', '{{ section.id }}')">MEN</button>
  </div>

  <div class="mood-toggles-track" id="mood-toggles-{{ section.id }}">
    </div>

  <div id="product-display-area-{{ section.id }}">
    <div class="product-section-header">
      <h3 class="current-mood-title" id="active-mood-title-{{ section.id }}">...</h3>
      <a href="#" class="view-all-link" id="view-all-link-{{ section.id }}">view all</a>
    </div>

    <div class="product-carousel">
      <button class="mood-nav-btn mood-nav-prev" id="prev-btn-{{ section.id }}" aria-label="Previous">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
      
      <div class="product-track" id="product-track-{{ section.id }}"></div>
      
      <button class="mood-nav-btn mood-nav-next" id="next-btn-{{ section.id }}" aria-label="Next">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
      </button>
    </div>
  </div>

</div>

<script>
  var shopByMoodData = shopByMoodData || {};

  (function() {
    const sectionId = "{{ section.id }}";
    const inr = new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 });

    const allMoods = [
      {% for block in section.blocks %}
        {
          id: '{{ block.id }}',
          gender: '{{ block.settings.gender }}',
          title: '{{ block.settings.title | escape }}',
          tagsRaw: '{{ block.settings.tag | escape }}', 
          showAll: {{ block.settings.show_all | default: false }},
          showGender: {{ block.settings.show_gender | default: false }},
          showColor: {{ block.settings.show_color | default: false }},
          image: '{% if block.settings.image != blank %}{{ block.settings.image | image_url: width: 400 }}{% else %}https://via.placeholder.com/400x200?text=No+Image{% endif %}',
          link: '{{ block.settings.link }}'
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    shopByMoodData[sectionId] = {
      moods: allMoods,
      cache: {}, 
      currentGender: 'women'
    };

    window.switchGender = function(gender, sId) {
      const data = shopByMoodData[sId];
      data.currentGender = gender;
      document.getElementById(`btn-women-${sId}`).classList.toggle('is-selected', gender === 'women');
      document.getElementById(`btn-men-${sId}`).classList.toggle('is-selected', gender === 'men');
      renderMoodToggles(sId);
    };

    function renderMoodToggles(sId) {
      const data = shopByMoodData[sId];
      const track = document.getElementById(`mood-toggles-${sId}`);
      const visibleMoods = data.moods.filter(m => m.gender === data.currentGender);
      
      if(visibleMoods.length === 0) {
        track.innerHTML = '<div style="padding:20px; color:#999;">No moods found.</div>';
        document.getElementById(`product-track-${sId}`).innerHTML = '';
        updateArrows(sId);
        return;
      }

      track.innerHTML = visibleMoods.map((mood, index) => `
        <div class="mood-card ${index === 0 ? 'is-active' : ''}" 
             data-mood-id="${mood.id}"
             role="button"
             aria-label="${mood.title}"
             onclick="switchMood('${mood.id}', '${sId}')">
          <img src="${mood.image}" alt="${mood.title}">
        </div>
      `).join('');

      switchMood(visibleMoods[0].id, sId);
    }

    window.switchMood = async function(moodId, sId) {
      const data = shopByMoodData[sId];
      const selectedMood = data.moods.find(m => m.id === moodId);
      if(!selectedMood) return;

      const track = document.getElementById(`mood-toggles-${sId}`);
      track.querySelectorAll('.mood-card').forEach(c => c.classList.remove('is-active'));
      const activeCard = track.querySelector(`.mood-card[data-mood-id="${moodId}"]`);
      if(activeCard) activeCard.classList.add('is-active');

      document.getElementById(`active-mood-title-${sId}`).textContent = selectedMood.title;
      const viewAllBtn = document.getElementById(`view-all-link-${sId}`);
      viewAllBtn.href = (selectedMood.link && selectedMood.link !== '') ? selectedMood.link : '#';

      const pTrack = document.getElementById(`product-track-${sId}`);
      
      // Reset scroll position
      pTrack.scrollLeft = 0;

      if(data.cache[selectedMood.id]) {
        renderProducts(data.cache[selectedMood.id], sId);
        return;
      }

      pTrack.innerHTML = '<div class="loading-msg">Loading styles...</div>';
      updateArrows(sId);
      
      const tagsList = [];
      const rawEntries = selectedMood.tagsRaw.split(',');
      
      rawEntries.forEach(entry => {
        const parts = entry.split(':');
        const tagName = parts[0].trim();
        const colorCount = parts[1] ? parts[1].trim() : null;
        if(tagName) {
          tagsList.push({ tag: tagName, count: colorCount });
        }
      });
      
      if(tagsList.length === 0) {
        pTrack.innerHTML = '<div class="loading-msg">No tags configured.</div>';
        return;
      }

      const products = await fetchProductsMulti(tagsList, selectedMood);
      data.cache[selectedMood.id] = products;
      renderProducts(products, sId);
    };

    function renderProducts(products, sId) {
      const pTrack = document.getElementById(`product-track-${sId}`);
      if (!products || products.length === 0) {
        pTrack.innerHTML = '<div class="loading-msg">No products found.</div>';
        updateArrows(sId);
        return;
      }

      pTrack.innerHTML = products.map(item => `
        <a class="product-card" href="${item.link}">
          <div class="p-image-wrap">
            <img src="${item.image}" alt="${item.title}" loading="lazy">
            <div class="p-overlay-text">
              <div class="p-title">${item.title}</div>
              <div class="p-meta">${item.sizeRange}</div>
            </div>
          </div>
          <div class="p-info">
            <div class="p-colors">${item.colorLabel}</div>
            <div class="p-price-row">
              <span class="p-price">₹${inr.format(item.price)}</span>
              <span class="p-compare">₹${inr.format(item.compare)}</span>
            </div>
          </div>
        </a>
      `).join('');

      setTimeout(() => updateArrows(sId), 100);
    }

    // ——— ARROW LOGIC ———
    function updateArrows(sId) {
      const track = document.getElementById(`product-track-${sId}`);
      const prevBtn = document.getElementById(`prev-btn-${sId}`);
      const nextBtn = document.getElementById(`next-btn-${sId}`);
      
      if(!track || !prevBtn || !nextBtn) return;

      const isScrollable = track.scrollWidth > track.clientWidth;
      
      if (!isScrollable) {
        prevBtn.classList.remove('is-visible');
        nextBtn.classList.remove('is-visible');
        return;
      }

      const atStart = track.scrollLeft <= 10;
      const atEnd = track.scrollLeft >= (track.scrollWidth - track.clientWidth - 10);

      prevBtn.classList.toggle('is-visible', !atStart);
      nextBtn.classList.toggle('is-visible', !atEnd);
    }

    function initArrows(sId) {
      const track = document.getElementById(`product-track-${sId}`);
      const prevBtn = document.getElementById(`prev-btn-${sId}`);
      const nextBtn = document.getElementById(`next-btn-${sId}`);

      if(prevBtn && nextBtn && track) {
        prevBtn.onclick = () => {
          track.scrollBy({ left: -300, behavior: 'smooth' });
          setTimeout(() => updateArrows(sId), 350);
        };
        nextBtn.onclick = () => {
          track.scrollBy({ left: 300, behavior: 'smooth' });
          setTimeout(() => updateArrows(sId), 350);
        };
        track.onscroll = () => updateArrows(sId);
        window.addEventListener('resize', () => updateArrows(sId));
      }
    }

    async function fetchProductsMulti(tagObjects, moodData) {
      let queryParts = [];
      tagObjects.forEach((obj, index) => {
        // Query quantityAvailable inside variants to calculate real stock
        queryParts.push(`
          t${index}: products(first: 10, query: "tag:'${obj.tag}'") {
            edges {
              node {
                title
                handle
                onlineStoreUrl
                totalInventory
                variantName: metafield(namespace: "custom", key: "product_variant_name") { value }
                images(first: 1) { edges { node { url } } }
                variants(first: 25) {
                  edges {
                    node {
                      price { amount }
                      compareAtPrice { amount }
                      selectedOptions { name value }
                      quantityAvailable
                    }
                  }
                }
              }
            }
          }
        `);
      });

      const fullQuery = `{ ${queryParts.join('\n')} }`;

      try {
        const response = await fetch("https://saadaa-design.myshopify.com/api/2024-07/graphql.json", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json", 
            "X-Shopify-Storefront-Access-Token": "388bd37219d8ab7daee1c58a23c03cc8" 
          },
          body: JSON.stringify({ query: fullQuery })
        });
        
        const json = await response.json();
        if (json.errors || !json.data) return [];

        let finalProducts = [];
        let usedHandles = new Set();
        let usedColors = new Set(); // Track colors used in THIS mood category

        tagObjects.forEach((obj, index) => {
          const aliasKey = `t${index}`;
          const edges = json.data[aliasKey]?.edges || [];
          
          if(edges.length > 0) {
            
            // Helper: Sum of variant quantities
            const getVariantStock = (p) => {
              return p.variants.edges.reduce((sum, v) => sum + (v.node.quantityAvailable || 0), 0);
            };

            // SORT: Highest Variant Stock first
            const candidates = edges.map(e => e.node).sort((a, b) => {
               return getVariantStock(b) - getVariantStock(a);
            });

            if (moodData.showAll) {
              // ——— MODE: SHOW ALL PRODUCTS ———
              candidates.forEach(c => {
                if (!usedHandles.has(c.handle)) {
                  usedHandles.add(c.handle);
                  finalProducts.push(normalizeProduct(c, obj.count, moodData));
                }
              });

            } else {
              // ——— MODE: ONE PRODUCT PER TAG (Default) ———
              // Logic: Find Unique Handle AND Unique Color
              let winner = null;
              
              for (let c of candidates) {
                 const h = c.handle;
                 const col = c.variantName?.value || "Unknown";
                 
                 if (usedHandles.has(h)) continue; // Always skip exact duplicate products
                 if (usedColors.has(col)) continue; // Skip if this color is already shown
                 
                 winner = c; 
                 break;
              }

              // Fallback: If all available colors are taken, just pick the highest stock unique product
              if (!winner) {
                 winner = candidates.find(c => !usedHandles.has(c.handle));
              }

              if (winner) {
                 usedHandles.add(winner.handle);
                 if (winner.variantName?.value) {
                   usedColors.add(winner.variantName.value);
                 }
                 finalProducts.push(normalizeProduct(winner, obj.count, moodData));
              }
            }
          }
        });

        return finalProducts;

      } catch (err) {
        console.error("Fetch error", err);
        return [];
      }
    }

    function normalizeProduct(p, count, moodData) {
      const variants = p.variants.edges.map(e => e.node);
      const firstVariant = variants[0];
      
      // ——— DYNAMIC TITLE CLEANING ———
      let displayTitle = p.title;
      
      // 1. Remove Gender Words (Unless "Show Gender" is checked)
      if (!moodData.showGender) {
        displayTitle = displayTitle.replace(/^(Women|Men|Women's|Men's)\s+/i, "");
      }
      
      // 2. Remove Color from Metafield (Unless "Show Color" is checked)
      if (!moodData.showColor && p.variantName?.value) {
         const re = new RegExp(`\\b${p.variantName.value}\\b`, 'gi');
         displayTitle = displayTitle.replace(re, "");
      }
      
      displayTitle = displayTitle.replace(/\s+/g, ' ').trim();
      // ——————————————————————————————

      const allSizes = variants.flatMap(v => v.selectedOptions.filter(opt => opt.name.toLowerCase() === 'size').map(opt => opt.value));
      const uniqueSizes = [...new Set(allSizes)];
      let sizeRangeStr = uniqueSizes.length > 1 ? `${uniqueSizes[0]} - ${uniqueSizes[uniqueSizes.length - 1]}` : (uniqueSizes[0] || "");
      const backendPrice = parseFloat(firstVariant?.price?.amount || 0);
      
      let colorText = "Available in multiple colors";
      if(count && count !== '') {
        colorText = `Available in ${count}+ colors`;
      }

      return {
        title: displayTitle,
        link: p.onlineStoreUrl || `https://saadaa.in/products/${p.handle}`,
        image: p.images.edges[0]?.node?.url || "",
        price: backendPrice,
        compare: backendPrice * 2,
        colorLabel: colorText,
        sizeRange: sizeRangeStr
      };
    }

    initArrows(sectionId);
    renderMoodToggles(sectionId);
  })();
</script>
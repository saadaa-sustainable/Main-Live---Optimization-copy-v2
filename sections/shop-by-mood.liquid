{%- comment -%}
SHOP BY MOOD (UPDATED ONLY WITH DESKTOP ARROWS)
- Adds left/right arrows on desktop for the product carousel
- Right arrow visible by default (if scrollable)
- Left arrow appears only after scrolling right
- Right arrow hides at end
NOTE: Nothing else changed.
{%- endcomment -%}

{% schema %}
{
  "name": "Shop By Mood",
  "settings": [
    { "type": "text", "id": "heading_start", "label": "Heading Text (Regular)", "default": "SHOP BY" },
    { "type": "text", "id": "heading_bold", "label": "Heading Text (Bold)", "default": "MOOD" },
    { "type": "text", "id": "subheading", "label": "Sub Heading", "default": "Whatever the plan - start here" }
  ],
  "blocks": [
    {
      "type": "mood",
      "name": "Mood Category",
      "settings": [
        {
          "type": "select",
          "id": "gender",
          "label": "Gender Category",
          "options": [
            { "value": "women", "label": "Women" },
            { "value": "men", "label": "Men" }
          ],
          "default": "women"
        },
        { "type": "image_picker", "id": "image", "label": "Grid Image" },
        { "type": "text", "id": "title", "label": "Mood Title", "default": "Everyday Wear" },
        {
          "type": "textarea",
          "id": "tag",
          "label": "Product Tags",
          "info": "Format: 'TAG:Count, TAG2:Count' (e.g., SDCP:14, SDCSP:6).",
          "default": "SDCP:14"
        },
        { "type": "checkbox", "id": "show_all", "label": "Show multiple products", "default": false },
        { "type": "url", "id": "link", "label": "View All Link" },
        { "type": "checkbox", "id": "show_gender", "label": "Show Gender in Title", "default": false },
        { "type": "checkbox", "id": "show_color", "label": "Show Color in Title", "default": false }
      ]
    }
  ],
  "presets": [{ "name": "Shop By Mood" }]
}
{% endschema %}

{% style %}
  .mood-container-{{ section.id }} {
    max-width: 1200px; margin: 0 auto; padding: 20px; padding-bottom: 15px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  .mood-header { text-align: center; margin-bottom: 20px; }
  .mood-main-title {
    font-size: 22px; color: #000; margin: 0 0 1px 0;
    text-transform: uppercase; letter-spacing: 1px; line-height: 1.2;
  }
  .mood-main-title span { font-weight: 400; }
  .mood-main-title strong { font-weight: 600; }
  .mood-header p { font-size: 14px; color: #222; font-weight: 400; margin: 0; }

  .mood-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-bottom: 20px;
  }
  @media(max-width: 768px) {
    .mood-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
  }

  .mood-grid-item {
    cursor: pointer;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    transition: all 0.2s ease;
  }

  .mood-grid-item.is-active {
    border-color: #000;
    box-shadow: 0 0 0 2px #fff inset;
  }

  .mood-grid-item img {
    width: 100%; height: 100%; display: block;
    object-fit: cover;
  }

  .mood-product-area {
    display: none;
    animation: fadeIn 0.4s ease;
    margin-top: 0px;
    padding-top: 0px;
  }
  .mood-product-area.is-visible { display: block; }
  @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

  .area-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 15px; }
  .area-title { font-size: 20px; font-weight: 500; margin: 0; color: #111; }
  .area-link { font-size: 13px; text-decoration: underline; color: #666; cursor: pointer; }

  .prod-carousel { position: relative; } /* already present - required for arrows */
  .prod-track {
    display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px;
    scroll-behavior: smooth; scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
  }
  .prod-track::-webkit-scrollbar { display: none; }

  .p-card { flex: 0 0 220px; text-decoration: none; color: inherit; display: block; }
  @media(max-width: 768px) { .p-card { flex: 0 0 160px; } }

  .p-img-box { position: relative; border-radius: 8px; overflow: hidden; margin-bottom: 8px; background: #f4f4f4; aspect-ratio: 2/3; }
  .p-img-box img { width: 100%; height: 100%; object-fit: cover; display: block; }

  .p-overlay {
    position: absolute; bottom: 0; left: 0; right: 0;
    padding: 40px 8px 8px;
    background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%);
    color: #fff;
    text-align: left;
  }
  .p-ttl { font-size: 12px; margin-bottom: 8px; line-height: 1.3; }
  .p-meta { font-size: 10px; opacity: 0.9; text-transform: uppercase; }

  .p-info { padding: 0 4px; }
  .p-colors { font-size: 11px; color: #666; margin-bottom: 4px; }
  .p-price-box { display: flex; gap: 6px; align-items: baseline; display:none; }
  .p-price { font-weight: 700; font-size: 14px; color: #111; }
  .p-compare { text-decoration: line-through; color: #ff5a5a; font-size: 12px; font-weight: 500; }

  .loading-msg { text-align: center; padding: 30px; color: #888; font-size: 14px; width: 100%; }

  .mood-progress-wrap { display: flex; justify-content: center; margin-top: 10px; }
  .mood-progress-container {
    width: 220px;
    height: 4px;
    background: rgba(0,0,0,0.10);
    border-radius: 999px;
    overflow: hidden;
  }
  .mood-progress-fill {
    height: 100%;
    width: 12%;
    background: #000;
    border-radius: 999px;
    transition: width 0.12s ease-out;
  }

  /* ——— DESKTOP ARROWS (SHOP BY MOOD) ——— */
  .mood-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 38px;
    height: 38px;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,0.12);
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(6px);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 3;
    box-shadow: 0 4px 14px rgba(0,0,0,0.12);
    transition: opacity .15s ease, transform .15s ease;
    opacity: 0;
    pointer-events: none;
  }
  .mood-nav svg { width: 18px; height: 18px; display: block; }
  .mood-nav.is-visible { opacity: 1; pointer-events: auto; }
  .mood-nav:hover { transform: translateY(-50%) scale(1.03); }
  .mood-nav--left { left: -6px; }
  .mood-nav--right { right: -6px; }

  @media (max-width: 1024px) {
    .mood-nav { display: none !important; }
  }
{% endstyle %}

<div class="mood-container-{{ section.id }}">
  <div class="mood-header">
    <h2 class="mood-main-title">
      <span>{{ section.settings.heading_start }}</span> <strong>{{ section.settings.heading_bold }}</strong>
    </h2>
    {% if section.settings.subheading != blank %}
      <p>{{ section.settings.subheading }}</p>
    {% endif %}
  </div>

  <div class="mood-grid" id="mood-grid-{{ section.id }}"></div>

  <div class="mood-product-area" id="product-area-{{ section.id }}">
    <div class="area-header">
      <h3 class="area-title" id="area-title-{{ section.id }}">Title</h3>
      <a href="#" class="area-link" id="area-link-{{ section.id }}">View All</a>
    </div>

    <div class="prod-carousel">
      <!-- Left Arrow -->
      <button class="mood-nav mood-nav--left" type="button" aria-label="Scroll left" id="mood-left-{{ section.id }}">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <!-- Right Arrow -->
      <button class="mood-nav mood-nav--right" type="button" aria-label="Scroll right" id="mood-right-{{ section.id }}">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M9 6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <div class="prod-track" id="prod-track-{{ section.id }}"></div>

      <!-- Progress Bar -->
      <div class="mood-progress-wrap">
        <div class="mood-progress-container" aria-hidden="true">
          <div class="mood-progress-fill" id="mood-bar-{{ section.id }}"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  (function(){
    const sectionId = "{{ section.id }}";
    const inr = new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 });

    const allBlocks = [
      {% for block in section.blocks %}
        {
          id: "{{ block.id }}",
          gender: "{{ block.settings.gender | downcase }}",
          title: "{{ block.settings.title | escape }}",
          image: "{% if block.settings.image != blank %}{{ block.settings.image | image_url: width: 400 }}{% else %}https://via.placeholder.com/200?text=Mood{% endif %}",
          tagsRaw: "{{ block.settings.tag | escape }}",
          link: "{{ block.settings.link }}",
          showAll: {{ block.settings.show_all | json }},
          showGender: {{ block.settings.show_gender | json }},
          showColor: {{ block.settings.show_color | json }}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    let currentGender = window.currentGlobalGender || 'women';
    let cache = {};

    window.addEventListener('moodGenderChanged', (e) => {
      console.log('ShopByMood Gender Switched to:', e.detail.gender);
      currentGender = e.detail.gender;
      renderGrid();
    });

    function initFillProgressBar(track) {
      const bar = document.getElementById(`mood-bar-${sectionId}`);
      if (!track || !bar) return;

      function update() {
        const maxScroll = track.scrollWidth - track.clientWidth;

        if (maxScroll <= 0) {
          bar.style.width = '12%';
          return;
        }

        const progress = track.scrollLeft / maxScroll;
        const pct = (progress * 100);
        bar.style.width = `${Math.min(100, Math.max(12, pct))}%`;
      }

      if (track._moodProgressBound) {
        requestAnimationFrame(update);
        return;
      }
      track._moodProgressBound = true;

      track.addEventListener('scroll', update, { passive: true });
      window.addEventListener('resize', update);

      setTimeout(update, 60);
    }

    // ——— DESKTOP ARROWS (SHOP BY MOOD) ———
    function initDesktopArrows(track) {
      const leftBtn = document.getElementById(`mood-left-${sectionId}`);
      const rightBtn = document.getElementById(`mood-right-${sectionId}`);
      if (!track || !leftBtn || !rightBtn) return;

      const isDesktop = () => window.matchMedia('(min-width: 1025px)').matches;

      function updateArrows() {
        if (!isDesktop()) {
          leftBtn.classList.remove('is-visible');
          rightBtn.classList.remove('is-visible');
          return;
        }

        const maxScroll = track.scrollWidth - track.clientWidth;
        if (maxScroll <= 2) {
          leftBtn.classList.remove('is-visible');
          rightBtn.classList.remove('is-visible');
          return;
        }

        const atStart = track.scrollLeft <= 2;
        const atEnd = track.scrollLeft >= (maxScroll - 2);

        if (atStart) {
          leftBtn.classList.remove('is-visible');
          rightBtn.classList.add('is-visible');
          return;
        }

        leftBtn.classList.add('is-visible');
        if (atEnd) rightBtn.classList.remove('is-visible');
        else rightBtn.classList.add('is-visible');
      }

      function scrollByStep(dir) {
        const step = Math.round(track.clientWidth * 0.85);
        track.scrollBy({ left: dir * step, behavior: 'smooth' });
      }

      // bind once per section
      if (!track._moodArrowBound) {
        track._moodArrowBound = true;

        leftBtn.addEventListener('click', () => scrollByStep(-1));
        rightBtn.addEventListener('click', () => scrollByStep(1));

        track.addEventListener('scroll', updateArrows, { passive: true });
        window.addEventListener('resize', updateArrows);
      }

      setTimeout(updateArrows, 80);
    }

    function renderGrid() {
      const grid = document.getElementById(`mood-grid-${sectionId}`);
      const productArea = document.getElementById(`product-area-${sectionId}`);
      const track = document.getElementById(`prod-track-${sectionId}`);
      const bar = document.getElementById(`mood-bar-${sectionId}`);

      const visibleBlocks = allBlocks.filter(b => b.gender === currentGender);

      if (visibleBlocks.length === 0) {
        grid.innerHTML =
          '<div style="grid-column:1/-1; text-align:center; color:#999; padding:20px;">No moods found for ' +
          currentGender +
          "</div>";
        productArea.classList.remove("is-visible");
        if (bar) bar.style.width = '12%';
        return;
      }

      grid.innerHTML = visibleBlocks.map((b) => `
        <div class="mood-grid-item" data-block-id="${b.id}" id="grid-item-${b.id}">
          <img src="${b.image}" alt="${b.title}" loading="lazy">
        </div>
      `).join("");

      document.querySelectorAll(`#mood-grid-${sectionId} .mood-grid-item`)
        .forEach((el) => el.classList.remove("is-active"));

      productArea.classList.remove("is-visible");

      if (track) {
        track.innerHTML = '<div class="loading-msg">Select a mood to see styles.</div>';
        track.scrollLeft = 0;
      }
      if (bar) bar.style.width = '12%';
    }

    const gridContainer = document.getElementById(`mood-grid-${sectionId}`);
    if (gridContainer) {
      gridContainer.addEventListener('click', function(e) {
        const item = e.target.closest('.mood-grid-item');
        if (item) {
          const blockId = item.getAttribute('data-block-id');
          loadMoodProducts(blockId);
        }
      });
    }

    async function loadMoodProducts(blockId) {
      const block = allBlocks.find(b => b.id === blockId);
      if(!block) return;

      document.querySelectorAll(`#mood-grid-${sectionId} .mood-grid-item`)
        .forEach(el => el.classList.remove('is-active'));

      const activeItem = document.getElementById(`grid-item-${blockId}`);
      if(activeItem) activeItem.classList.add('is-active');

      const area = document.getElementById(`product-area-${sectionId}`);
      area.classList.add('is-visible');
      document.getElementById(`area-title-${sectionId}`).innerText = block.title;
      document.getElementById(`area-link-${sectionId}`).href = block.link || '#';

      const track = document.getElementById(`prod-track-${sectionId}`);
      const bar = document.getElementById(`mood-bar-${sectionId}`);
      if (track) track.scrollLeft = 0;
      if (bar) bar.style.width = '12%';

      if(cache[blockId]) {
        renderCarousel(cache[blockId], track);
        initFillProgressBar(track);
        initDesktopArrows(track);
        return;
      }

      track.innerHTML = '<div class="loading-msg">Loading styles...</div>';

      const tagEntries = block.tagsRaw.split(',').map(entry => {
        const parts = entry.split(':');
        return { tag: parts[0].trim(), count: parts[1] ? parts[1].trim() : '' };
      }).filter(e => e.tag !== '');

      const products = await fetchProductsMulti(tagEntries, block);
      cache[blockId] = products;
      renderCarousel(products, track);
      initFillProgressBar(track);
      initDesktopArrows(track);
    };

    async function fetchProductsMulti(tagEntries, config) {
      let queryParts = [];

      tagEntries.forEach((entry, idx) => {
        queryParts.push(`
          t${idx}: products(first: 10, query: "tag:'${entry.tag}'") {
            edges {
              node {
                title, handle, onlineStoreUrl, totalInventory
                variantName: metafield(namespace: "custom", key: "product_variant_name") { value }
                images(first: 1) { edges { node { url } } }
                variants(first: 25) {
                  edges { node {
                    price { amount }
                    compareAtPrice { amount }
                    quantityAvailable
                    selectedOptions { name, value }
                  } }
                }
              }
            }
          }
        `);
      });

      const fullQuery = `{ ${queryParts.join('\n')} }`;

      try {
        const res = await fetch(`https://${window.Shopify.shop}/api/2024-07/graphql.json`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Shopify-Storefront-Access-Token": "388bd37219d8ab7daee1c58a23c03cc8"
          },
          body: JSON.stringify({ query: fullQuery })
        });

        const json = await res.json();

        let allProducts = [];
        let usedHandles = new Set();
        let usedColors = new Set();

        tagEntries.forEach((entry, idx) => {
          const edges = json.data[`t${idx}`]?.edges || [];

          const candidates = edges.map(e => e.node).sort((a,b) => {
            const stockA = a.variants.edges.reduce((s,v)=>s+(v.node.quantityAvailable||0),0);
            const stockB = b.variants.edges.reduce((s,v)=>s+(v.node.quantityAvailable||0),0);
            return stockB - stockA;
          });

          if(config.showAll) {
            candidates.forEach(p => {
              if(!usedHandles.has(p.handle)) {
                usedHandles.add(p.handle);
                allProducts.push(normalize(p, config, entry.count));
              }
            });
          } else {
            let winner = null;
            for(let p of candidates) {
              const col = p.variantName?.value || "Unknown";
              if(usedHandles.has(p.handle)) continue;
              if(usedColors.has(col)) continue;
              winner = p; break;
            }
            if(!winner) winner = candidates.find(p => !usedHandles.has(p.handle));

            if(winner) {
              usedHandles.add(winner.handle);
              if(winner.variantName?.value) usedColors.add(winner.variantName.value);
              allProducts.push(normalize(winner, config, entry.count));
            }
          }
        });

        return allProducts;
      } catch(e) {
        console.error(e);
        return [];
      }
    }

    function normalize(p, config, countStr) {
      const v = p.variants.edges[0]?.node;
      let title = p.title;

      if(!config.showGender) title = title.replace(/\b(Women['’]?s?|Men['’]?s?|Unisex['’]?s?|Women|Men|Unisex)\b/gi, "").trim();
      if(!config.showColor && p.variantName?.value) title = title.replace(new RegExp(`\\b${p.variantName.value}\\b`, 'gi'), "");
      title = title.replace(/\s+/g, ' ').trim();

      const sizes = [...new Set(
        p.variants.edges.flatMap(va =>
          va.node.selectedOptions
            .filter(o=>o.name.toLowerCase()==='size')
            .map(o=>o.value)
        )
      )];
      const sizeStr = sizes.length > 1 ? `${sizes[0]} - ${sizes[sizes.length-1]}` : (sizes[0] || '');

      return {
        title: title,
        link: p.onlineStoreUrl || `/products/${p.handle}`,
        image: p.images.edges[0]?.node?.url,
        price: parseFloat(v?.price?.amount || 0),
        compare: parseFloat(v?.price?.amount || 0) * 2,
        size: sizeStr,
        color: p.variantName?.value || '',
        countInfo: countStr
      };
    }

    function renderCarousel(products, track) {
      if(products.length === 0) {
        track.innerHTML = '<div class="loading-msg">No products found.</div>';
        return;
      }

      track.innerHTML = products.map(p => {
        const colorTxt = p.countInfo ? `Available in ${p.countInfo}+ colors` : 'Available in multiple colors';
        return `
          <a href="${p.link}" class="p-card">
            <div class="p-img-box">
              <img src="${p.image}" loading="lazy">
              <div class="p-overlay">
                <div class="p-ttl">${p.title}</div>
                <div class="p-meta">${p.size}</div>
              </div>
            </div>
            <div class="p-info">
              <div class="p-colors">${colorTxt}</div>
              <div class="p-price-box">
                <span class="p-price">₹${inr.format(p.price)}</span>
                <span class="p-compare">₹${inr.format(p.compare)}</span>
              </div>
            </div>
          </a>
        `;
      }).join('');
    }

    renderGrid();
  })();
</script>

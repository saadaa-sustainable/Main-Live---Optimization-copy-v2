{% schema %}
{
  "name": "Category Carousels",
  "settings": [
    {
      "type": "header",
      "content": "Section Configuration"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Section Background",
      "default": "#f6f3f1"
    },
    {
      "type": "color",
      "id": "active_color",
      "label": "Active Roundel Color",
      "default": "#C36A4E"
    }
  ],
  "blocks": [
    {
      "type": "category",
      "name": "Category Block",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Roundel Image"
        },
        {
          "type": "text",
          "id": "label_line_1",
          "label": "Roundel Label Line 1",
          "default": "Women"
        },
        {
          "type": "text",
          "id": "label_line_2",
          "label": "Roundel Label Line 2",
          "default": "Topwear"
        },
        {
          "type": "text",
          "id": "banner_title",
          "label": "Section Banner Title",
          "default": "Women Topwear"
        },
        {
          "type": "textarea",
          "id": "tags",
          "label": "Product Tags (Comma Separated)",
          "info": "Enter tags (e.g., 'SDCP, SDCSP'). Finds products with highest inventory per tag.",
          "default": "SDCP, SDCSP"
        },
        {
          "type": "checkbox",
          "id": "show_all",
          "label": "Show multiple products per tag",
          "info": "Uncheck to show only the single best-selling item per tag.",
          "default": false
        },
        {
          "type": "text",
          "id": "badge_text",
          "label": "Offer Badge Text",
          "default": "BUY 3 GET 1 FREE"
        },
        {
          "type": "header",
          "content": "Title Display Options"
        },
        {
          "type": "checkbox",
          "id": "show_gender",
          "label": "Show Gender in Title (e.g., 'Women')",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "show_color",
          "label": "Show Color in Title",
          "default": false
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Category Carousels",
      "blocks": [
        { "type": "category", "settings": { "label_line_1": "Women", "label_line_2": "Topwear" } },
        { "type": "category", "settings": { "label_line_1": "Men", "label_line_2": "Topwear" } }
      ]
    }
  ]
}
{% endschema %}

{% style %}
  /* ——— Scoped Variables ——— */
  #shopify-section-{{ section.id }} {
    --bg-color: {{ section.settings.bg_color }};
    --active-color: {{ section.settings.active_color }};
    --sticky-offset: 120px;
  }

  .pc-wrapper {
    background-color: var(--bg-color);
    padding-bottom: 2rem;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  /* ——— Sticky Roundels ——— */
  #sticky-roundels {
    position: sticky; top: 75px; z-index: 10;
    background: var(--bg-color);
    padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,.06);
    transition: top 0.3s ease;
  }
  .roundel-row {
    display:flex; gap:10px; align-items:center; justify-content:center;
    overflow-x:auto; -webkit-overflow-scrolling:touch; padding: 2px 10px;
    scroll-snap-type:x mandatory;
  }
  .roundel-row::-webkit-scrollbar{ display:none; }

  .category-item {
    display:flex; flex-direction:column; align-items:center; cursor:pointer;
    flex:0 0 auto; scroll-snap-align:center; text-decoration:none; color:inherit;
  }
  .category-image-wrapper {
    position:relative; display:inline-block; padding:2px;
    border:2px solid transparent; border-radius:50%; transition:border .2s;
  }
  .category-image {
    width: 88px; height: 88px; object-fit:cover; border-radius:50%; display:block;
  }

  /* Checkmark */
  .category-check {
    display:none; position:absolute; bottom:4px; right: 1px; width: 16px; height: 16px;
    background: var(--active-color); border-radius:50%; padding:2px; border:1px solid #fff;
  }

  .category-label {
    margin-top:.45rem; font-size:.8rem; color:#444; font-weight:600;
    text-align:center; line-height:1.15;
    display:flex; flex-direction:column; align-items:center;
    min-height:2.4em; white-space:normal;
  }
  .category-label .label-line{ display:block; }

  /* Active State */
  .roundel-row input[type="radio"]{ display:none; }
  .roundel-row input[type="radio"]:checked + .category-image-wrapper { border-color: var(--active-color); }
  .roundel-row input[type="radio"]:checked + .category-image-wrapper .category-check { display:block; }
  .roundel-row input[type="radio"]:checked ~ .category-label { color: var(--active-color); }

  /* ——— MOBILE STYLES (UPDATED FOR CENTERING) ——— */
  @media (max-width:700px){
.roundel-row { 
      /* Logic: If 4 or fewer blocks, Center. If more, Start (to allow scrolling) */
      justify-content: {% if section.blocks.size <= 4 %}center{% else %}flex-start{% endif %}; 
    }
    .category-image { 
      /* Logic: If 4 or fewer blocks, Bigger (18vw). Else, Standard (16vw) */
      width: {% if section.blocks.size <= 4 %}18vw{% else %}16vw{% endif %}; 
      height: {% if section.blocks.size <= 4 %}18vw{% else %}16vw{% endif %}; 
    }
    .category-label{ font-size:.58rem; }
  }

  /* ——— Banner Titles (CENTERED) ——— */
  .banner-row { scroll-margin-top: calc(var(--sticky-offset) + 8px); }
  .banner-text {
    display:block; width:100%; background: var(--bg-color); color:#222;
    padding: 6px 14px; font-size:20px; font-weight:600; letter-spacing:.2px;
    text-align: center !important; /* Force Center */
  }
  @media (min-width:701px){ .banner-text{ font-size:22px; padding:14px 16px; } }

  /* ——— Carousel & Cards ——— */
  .pc-grid-section { padding:0 0 1rem 0; background: var(--bg-color); }
  .pc-grid-outer { position:relative; top:7px; }

  .pc-carousel { position:relative; }
  .pc-carousel-track {
    display:flex; gap:8px; padding:0 10px; margin:0; overflow-x:auto; -webkit-overflow-scrolling:touch;
    scroll-snap-type:x mandatory; scroll-behavior:smooth; margin-left:14px;
  }
  .pc-carousel-track::-webkit-scrollbar { height:6px; }
  .pc-carousel-track::-webkit-scrollbar-thumb { background: rgba(0,0,0,.15); border-radius:4px; }

  .pc-carousel-track.is-centered { justify-content: center; }

  .pc-carousel-item {
    flex:0 0 39%; scroll-snap-align:start; min-width: 145px;
    display: flex !important; flex-direction: column !important; height: auto !important;
  }
  @media (min-width:701px){
    .pc-carousel-track{ gap:12px; padding:0 16px; padding-bottom: 40px; }
    .pc-carousel-item{ flex:0 0 15.5%; min-width: 220px; }
  }

  a.pc-grid-link {
    text-decoration:none; color:inherit; display:block;
    display: flex !important; flex-direction: column !important; flex: 1 !important; height: 100% !important;
  }

  .pc-grid-item {
    overflow: hidden; display: flex; flex-direction: column; cursor: pointer;
   transition: box-shadow .2s;
    height: 100% !important;
    border-radius: 8px;
  }

  .pc-product-image-wrapper {
    position: relative; width: 100%; aspect-ratio: 3 / 4; flex-shrink: 0;
  }
  .pc-product-image-wrapper img { display: block; width: 100%; height: 100%; object-fit: cover; }

  /* ——— Offer strip (Yellow/Gold Theme) ——— */
  .pc-offer-strip {
    display:block; width:100%; position:relative;
    padding:4px 8px; text-align:center; font-size:8px; font-weight:600;
    letter-spacing:.4px; text-transform:uppercase; color:#111;
    background: linear-gradient(to bottom, #fff36b 0%, #ffdb00 100%);
    border: 1px solid rgba(0,0,0,.18); border-bottom: none;
    box-shadow: 0 4px 14px rgba(0,0,0,.12);
    overflow:hidden; isolation:isolate;
  }
  .pc-offer-strip::after {
    content:""; position:absolute; top:0; bottom:0; left:-130%; width:120%;
    background: linear-gradient(115deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0) 32%, rgba(255,255,255,.65) 48%, rgba(255,255,255,0) 64%, rgba(255,255,255,0) 100%);
    transform:skewX(-20deg); animation:badgeShine 2.2s linear infinite; pointer-events:none;
  }
  @keyframes badgeShine{ 0% { left:-130%; } 100% { left:130%; } }
  @media (min-width:701px){ .pc-offer-strip{ font-size:12px; padding:8px 12px; } }


  .pc-product-title {
    /* Padding to separate from image and CENTERED */
    padding: 10px 8px 10px;
    font-size: 11px; line-height: 1.3; color: #000;
    text-align: center !important; /* Force Center */
    -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    flex-grow: 1 !important; margin-bottom: 0 !important;
  }
  @media (min-width:701px){ .pc-product-title{ font-size:14px; letter-spacing:.3px; } }

  .pc-price-row {
    display:flex; align-items:baseline; padding:0 8px 10px; gap:8px;
    justify-content: center; /* Center Prices */
    margin-top: auto !important;
    padding-bottom: 15px !important;
  }
  .pc-product-price { padding:0; font-size:14px; line-height:1.2; color:#111; font-weight:700; }
  .pc-product-compare { font-size:12px; line-height:1.2; color:#e01e37; text-decoration:line-through; font-weight:700; opacity:.95; }
  @media (min-width:701px){ .pc-product-price, .pc-product-compare{ font-size:14px; } }

  /* Arrows (Neutral Style) */
  .pc-nav-btn {
    position:absolute; top:40%; transform:translateY(-50%); background:#fff; border:1px solid rgba(0,0,0,.12);
    border-radius:50%; width:40px; height:40px; display:grid; place-items:center; cursor:pointer;
    box-shadow:0 3px 12px rgba(0,0,0,.10); z-index:2; transition:opacity .18s;
    color: #333;
  }
  .pc-nav-prev { left: 10px; }
  .pc-nav-next { right: 10px; }
  .pc-nav-btn.is-hidden { opacity:0; pointer-events:none; }
  .pc-nav-btn:hover { background-color: #f9f9f9; }

  @media (max-width:700px){
    .pc-nav-btn{ display:none !important; }
    .pc-carousel-track.is-centered { justify-content: flex-start; }
  }

  .pc-loading { text-align:center; padding:20px; font-size:12px; color:#666; }
{% endstyle %}

<div class="pc-wrapper">
  <div id="sticky-roundels" aria-label="Category roundels">
    <div class="roundel-row" role="tablist">
      {% for block in section.blocks %}
        {% assign cat_id = 'cc-' | append: block.id %}
        <label
          class="category-item"
          data-cat="{{ cat_id }}"
          role="tab"
          aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
        >
          <input
            type="radio"
            name="cc_cat"
            {% if forloop.first %}
              checked
            {% endif %}
          >
          <span class="category-image-wrapper">
            {% if block.settings.image != blank %}
              <img class="category-image" src="{{ block.settings.image | image_url: width: 200 }}" loading="lazy">
            {% else %}
              <img class="category-image" src="https://via.placeholder.com/100x100?text=IMG">
            {% endif %}
            <svg
              class="category-check"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#fff"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="20 6 9 17 4 12" />
            </svg>
          </span>
          <span class="category-label">
            <span class="label-line">{{ block.settings.label_line_1 }}</span>
            <span class="label-line">{{ block.settings.label_line_2 }}</span>
          </span>
        </label>
      {% endfor %}
    </div>
  </div>

  {% for block in section.blocks %}
    {% assign cat_id = 'cc-' | append: block.id %}

    <div class="banner-row" id="{{ cat_id }}-banner">
      <span class="banner-text">{{ block.settings.banner_title }}</span>
    </div>

    <div class="pc-grid-section">
      <div class="pc-grid-outer">
        <div class="pc-carousel" id="carousel-{{ cat_id }}">
          <button class="pc-nav-btn pc-nav-prev" id="prev-btn-{{ cat_id }}" aria-label="Previous">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>

          <div class="pc-carousel-track" id="track-{{ cat_id }}">
            <div class="pc-loading">Loading {{ block.settings.label_line_1 }}...</div>
          </div>

          <button class="pc-nav-btn pc-nav-next" id="next-btn-{{ cat_id }}" aria-label="Next">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<script>
  (function(){
    const inr = new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 });

    const categories = [
      {% for block in section.blocks %}
        {
          id: "cc-{{ block.id }}",
          tagsRaw: "{{ block.settings.tags | escape }}",
          badge: "{{ block.settings.badge_text | escape }}",
          // Force boolean using json filter to ensure false passes correctly
          showGender: {{ block.settings.show_gender | json }},
          showColor: {{ block.settings.show_color | json }},
          showAll: {{ block.settings.show_all | json }}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    async function fetchProductsForCategory(catData) {
      // 1. Parse tags to separate the Tag Name from the Price Overrides
      const rawTags = catData.tagsRaw.split(',').map(t => t.trim()).filter(t => t !== '');
      if (rawTags.length === 0) return [];

      // Create a map of parsed tags: { cleanTag: "SDCP", price: 799, compare: 999 }
      const parsedTags = rawTags.map(raw => {
        const parts = raw.split(':');
        return {
          cleanTag: parts[0].trim(),
          overridePrice: parts.length > 1 ? parseFloat(parts[1]) : null,
          overrideCompare: parts.length > 2 ? parseFloat(parts[2]) : null
        };
      });

      let queryParts = [];
      
      // 2. Build Query using the Clean Tag
      parsedTags.forEach((pt, index) => {
        queryParts.push(`
          t${index}: products(first: 10, query: "tag:'${pt.cleanTag}'") {
            edges {
              node {
                title
                handle
                onlineStoreUrl
                totalInventory
                variantName: metafield(namespace: "custom", key: "product_variant_name") { value }
                images(first: 1) { edges { node { url } } }
                variants(first: 25) {
                  edges {
                    node {
                      price { amount }
                      compareAtPrice { amount }
                      quantityAvailable
                    }
                  }
                }
              }
            }
          }
        `);
      });

      const fullQuery = `{ ${queryParts.join('\n')} }`;

      try {
        const response = await fetch("https://saadaa-design.myshopify.com/api/2024-07/graphql.json", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json", 
            "X-Shopify-Storefront-Access-Token": "388bd37219d8ab7daee1c58a23c03cc8" 
          },
          body: JSON.stringify({ query: fullQuery })
        });
        
        const json = await response.json();
        if (json.errors || !json.data) return [];

        let finalProducts = [];
        let usedHandles = new Set();
        let usedColors = new Set(); 

        parsedTags.forEach((pt, index) => {
          const aliasKey = `t${index}`;
          const edges = json.data[aliasKey]?.edges || [];
          
          if(edges.length > 0) {
            // Helper: Sum variant quantities
            const getVariantStock = (p) => {
              return p.variants.edges.reduce((sum, v) => sum + (v.node.quantityAvailable || 0), 0);
            };

            // Sort: Highest Variant Stock first
            const candidates = edges.map(e => e.node).sort((a, b) => {
               return getVariantStock(b) - getVariantStock(a);
            });

            // Pass the overrides for this specific tag to the normalization function
            const overrides = { price: pt.overridePrice, compare: pt.overrideCompare };

            if (catData.showAll) {
              // ——— SHOW ALL LOGIC ———
              candidates.forEach(c => {
                 if (!usedHandles.has(c.handle)) {
                    usedHandles.add(c.handle);
                    finalProducts.push(normalizeProduct(c, catData, overrides));
                 }
              });

            } else {
              // ——— ONE WINNER (Unique Color) LOGIC ———
              let winner = null;
              for (let c of candidates) {
                 const h = c.handle;
                 const col = c.variantName?.value || "Unknown";
                 
                 if (usedHandles.has(h)) continue; 
                 if (usedColors.has(col)) continue; // Try to pick unique color
                 
                 winner = c; 
                 break;
              }

              if (!winner) {
                 // Fallback if all colors taken
                 winner = candidates.find(c => !usedHandles.has(c.handle));
              }

              if (winner) {
                 usedHandles.add(winner.handle);
                 if (winner.variantName?.value) {
                   usedColors.add(winner.variantName.value);
                 }
                 finalProducts.push(normalizeProduct(winner, catData, overrides));
              }
            }
          }
        });

        return finalProducts;

      } catch (err) {
        console.error("Fetch error", err);
        return [];
      }
    }

    // Updated to accept overrides
    function normalizeProduct(p, catData, overrides) {
      const firstVariant = p.variants.edges[0]?.node;
      let displayTitle = p.title;
      
      // ——— DYNAMIC TITLE CLEANING ———
      if (!catData.showGender) {
        displayTitle = displayTitle.replace(/\b(Women['’]?s?|Men['’]?s?)\b/gi, "").trim();
      }
      
      // Remove Color from Metafield
      if (!catData.showColor && p.variantName?.value) {
         const re = new RegExp(`\\b${p.variantName.value}\\b`, 'gi');
         displayTitle = displayTitle.replace(re, "");
      }
      displayTitle = displayTitle.replace(/\s+/g, ' ').trim();

      // ——— PRICE LOGIC UPDATE ———
      let finalPrice, finalCompare;

      if (overrides && overrides.price !== null) {
        // Use the Override from tag (e.g., 799)
        finalPrice = overrides.price;
        // If compare provided (e.g., 999), use it. Otherwise calc x2
        finalCompare = overrides.compare !== null ? overrides.compare : (finalPrice * 2);
      } else {
        // Use Real Shopify Price
        finalPrice = parseFloat(firstVariant?.price?.amount || 0);
        finalCompare = finalPrice * 2; // Default Logic
      }
      
      return {
        title: displayTitle,
        link: p.onlineStoreUrl || `https://saadaa.in/products/${p.handle}`,
        image: p.images.edges[0]?.node?.url || "",
        price: finalPrice,
        compare: finalCompare,
        badge: catData.badge
      };
    }

    function buildCardHTML(item) {
      return `
        <a class="pc-grid-link" href="${item.link}">
          <div class="pc-grid-item">
            <div class="pc-product-image-wrapper">
              <div class="pc-offer-strip">${item.badge}</div>
              <img src="${item.image}" alt="${item.title}" loading="lazy" />
            </div>
            <div class="pc-product-title">${item.title}</div>
            <div class="pc-price-row">
              <div class="pc-product-price">₹${inr.format(item.price)}</div>
              <div class="pc-product-compare">₹${inr.format(item.compare)}</div>
            </div>
          </div>
        </a>
      `;
    }

    async function initSection() {
      for (const cat of categories) {
        const track = document.getElementById(`track-${cat.id}`);
        if(track) {
          const products = await fetchProductsForCategory(cat);
          if (products.length > 0) {
            // Add centering class if fewer than 5 items
            if(products.length < 5) track.classList.add('is-centered');
            else track.classList.remove('is-centered');

            track.innerHTML = products.map(item => `<div class="pc-carousel-item">${buildCardHTML(item)}</div>`).join('');
          } else {
            track.innerHTML = '<div class="pc-loading">No products found.</div>';
          }
          initArrows(cat.id);
          updateArrows(cat.id);
        }
      }
      setupStickyNav();
    }

    // ——— ARROW LOGIC (PER CATEGORY) ———
    function updateArrows(catId) {
      const track = document.getElementById(`track-${catId}`);
      const prevBtn = document.getElementById(`prev-btn-${catId}`);
      const nextBtn = document.getElementById(`next-btn-${catId}`);
      
      if(!track || !prevBtn || !nextBtn) return;

      const max = Math.max(0, track.scrollWidth - track.clientWidth);
      
      // Smart Hide Logic
      if (max <= 0) {
         prevBtn.classList.add('is-hidden');
         nextBtn.classList.add('is-hidden');
         return;
      }

      const x = Math.round(track.scrollLeft);
      
      if (x > 10) prevBtn.classList.add('is-visible'); 
      else prevBtn.classList.remove('is-visible');
      
      if (x < max - 10) nextBtn.classList.add('is-visible');
      else nextBtn.classList.remove('is-visible');
    }

    function initArrows(catId) {
      const track = document.getElementById(`track-${catId}`);
      const prevBtn = document.getElementById(`prev-btn-${catId}`);
      const nextBtn = document.getElementById(`next-btn-${catId}`);

      if(prevBtn && nextBtn && track) {
        const scrollAmount = () => Math.max(track.clientWidth * 0.9, 320);

        prevBtn.onclick = () => { 
          track.scrollBy({ left: -scrollAmount(), behavior: 'smooth' }); 
          setTimeout(() => updateArrows(catId), 350); 
        };
        nextBtn.onclick = () => { 
          track.scrollBy({ left: scrollAmount(), behavior: 'smooth' }); 
          setTimeout(() => updateArrows(catId), 350); 
        };
        
        track.onscroll = () => updateArrows(catId);
        window.addEventListener('resize', () => updateArrows(catId));
      }
    }

    function setupStickyNav() {
      const roundelItems = document.querySelectorAll('#sticky-roundels .category-item');
      const roundelRow = document.querySelector('.roundel-row');
      let lastActiveCat = null;
      
      function getStickyOffset() {
        const sticky = document.getElementById('sticky-roundels');
        let offset = sticky ? sticky.offsetHeight : 80;
        const header = document.querySelector('.site-header'); 
        
        // Robust check for sticky or fixed headers (common in Shopify)
        if(header) {
           const style = getComputedStyle(header);
           if(style.position === 'sticky' || style.position === 'fixed') {
              offset += header.offsetHeight;
           }
        }
        return offset;
      }

      // Click Handler (Manual Selection)
      roundelItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const catId = item.getAttribute('data-cat');
          const target = document.getElementById(`${catId}-banner`);
          
          if(target) {
            // Click destination: Exact top
            const offset = getStickyOffset() + 75; 
            const elementPosition = target.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - offset;
            
            window.scrollTo({ top: offsetPosition, behavior: "smooth" });
          }
        });
      });

      // Scroll Spy (Automatic Selection & Horizontal Scroll)
      window.addEventListener('scroll', () => {
        let current = categories[0].id; // Default to first
        
        const offset = getStickyOffset() + 150; 

        // Loop to find which section is active
        categories.forEach(cat => {
          const section = document.getElementById(`${cat.id}-banner`);
          if(section) {
            const sectionTop = section.offsetTop;
            if(window.pageYOffset >= sectionTop - offset) { 
              current = cat.id; 
            }
          }
        });

        // Only update if changed
        if(current && current !== lastActiveCat) {
          lastActiveCat = current;

          // 1. Update Radio Buttons
          roundelItems.forEach(r => {
            const isActive = r.getAttribute('data-cat') === current;
            r.setAttribute('aria-selected', isActive);
            r.querySelector('input').checked = isActive;
          });

          // 2. Auto-Scroll Roundel Bar (Center Active Item)
          const activeItem = document.querySelector(`.category-item[data-cat="${current}"]`);
          if(activeItem && roundelRow) {
            const itemLeft = activeItem.offsetLeft;
            const itemWidth = activeItem.offsetWidth;
            const containerWidth = roundelRow.offsetWidth;
            
            const scrollPos = itemLeft - (containerWidth / 2) + (itemWidth / 2);
            
            roundelRow.scrollTo({
              left: scrollPos,
              behavior: 'smooth'
            });
          }
        }
      }, { passive: true });
    }

    initSection();
  })();
</script>
{% schema %}
{
  "name": "Pill Toggle Menu",
  "settings": [
    {
      "type": "color",
      "id": "bg_color",
      "label": "Section Background",
      "default": "#ffffff"
    }
  ],
  "blocks": [
    {
      "type": "pill",
      "name": "Category Pill",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Pill Title",
          "default": "Best Sellers"
        },
        {
          "type": "checkbox",
          "id": "show_red_dot",
          "label": "Show Red Notification Dot",
          "default": false
        },
        {
          "type": "header",
          "content": "Product Settings"
        },
        {
          "type": "textarea",
          "id": "tags",
          "label": "Product Tags configuration",
          "info": "Format: Tag:BadgeText:BgColor:TextColor. Example: 'SDCP:NEW:#008001:#fff'. Separate multiple entries with commas.",
          "default": "bestsellers:HOT:#ff0000:#fff, new:NEW"
        },
        {
          "type": "checkbox",
          "id": "show_all",
          "label": "Show multiple products per tag",
          "info": "If checked, shows ALL products found (up to 10). If unchecked, shows only the single best-selling item.",
          "default": false
        },
        {
          "type": "url",
          "id": "link",
          "label": "View All Link"
        },
        {
          "type": "header",
          "content": "Title Cleaning"
        },
        {
          "type": "checkbox",
          "id": "show_gender",
          "label": "Show Gender (Women/Men/Unisex)",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "show_color",
          "label": "Show Color in Title",
          "default": false
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Pill Toggle Menu",
      "blocks": [
        { "type": "pill", "settings": { "title": "Best Sellers", "tags": "women_home_toggle_best_sellers:HOT" } },
        { "type": "pill", "settings": { "title": "Bottom Wear", "tags": "women_bottoms:NEW:#000000:#fff", "show_red_dot": true } },
        { "type": "pill", "settings": { "title": "New Arrival", "tags": "new_arrival:NEW", "show_red_dot": true } },
        { "type": "pill", "settings": { "title": "Top Wear", "tags": "women_tops" } }
      ]
    }
  ]
}
{% endschema %}

{% style %}
  #shopify-section-{{ section.id }} {
    background-color: {{ section.settings.bg_color }};
    padding: 20px 0;
  }

  .toggle-menu-container {
    max-width: 1200px;
    margin: 0 auto;
   
 
  }

  /* ——— PILL NAVIGATION ——— */
  .toggle-buttons-wrapper {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    margin-bottom: 25px;
    justify-content: center;
  }
  
  .toggle-button {
    background-color: #f6f3f1;
    color: #000;
    border-radius: 12px;
    padding: 3px 15px; 
    font-size: 14px;
    cursor: pointer;
    outline: none;
    transition: background-color 0.5s ease, color 0.5s ease;
    white-space: nowrap;
    border: none;
    text-decoration: none;
    position: relative; 
  }

  .toggle-button.active {
    background-color: #fff;
    color: #000;
    /* subtle shadow if needed */
  }

  /* RED BADGE DOT (On Pill) */
  .toggle-button.badged { position: relative; }
  .toggle-badge-dot {
    position: absolute;
    top: 5px;
    right: -2px;
    width: 10px;
    height: 10px;
    background: #ff3b30;
    border-radius: 999px;
    box-shadow: 0 0 0 2px #f6f3f1, 0 0 8px rgba(255,59,48,.55);
    animation: badge-bob 0.5s ease-in-out infinite;
    pointer-events: none;
  }
  .toggle-button.active .toggle-badge-dot {
    box-shadow: 0 0 0 2px #ffffff, 0 0 8px rgba(255,59,48,.55);
  }

  @keyframes badge-bob {
    0%, 100% { transform: translateY(0); }
    50%      { transform: translateY(-3px); }
  }

  /* ——— PRODUCT GRID ——— */
  .menu-items-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    min-height: 300px;
  }

  .menu-item {
    flex: 0 0 calc(20% - 20px);
    text-align: center;
    cursor: pointer;
    background: transparent;
    position: relative; /* For NEW badge */
    opacity: 0;
    animation: fadeUp 0.5s ease forwards;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .menu-item a {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .menu-item img {
    width: 100%;
    max-width: 220px;
    display: block;
    margin: 0 auto 10px;
    border-radius: 7px;
    aspect-ratio: 2/3; /* Enforce Ratio */
    object-fit: cover;
    background: #f4f4f4;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  /* Hover Effects matching reference */
  @media (hover: hover) and (pointer: fine) {
    .menu-item:hover img {
      transform: scale(1.045) rotateZ(-0.7deg);
      box-shadow: 0 10px 28px 0 rgba(195,106,78,0.21), 0 2px 8px rgba(195,106,78,0.13);
    }
    .toggle-button:hover:not(.active) {
      background: #fff8f3;
      color: #c36a4e;
      transform: scale(1.07) translateY(-3px);
      box-shadow: 0 4px 14px 0 rgba(195,106,78,0.21);
    }
  }

  .menu-item p {
    font-size: 15px;
    color: #333;
    margin: 0;
  }

  /* GREEN "NEW" PILL (On Product) */
  .product-badge-pill {
    display: flex;
    position: absolute;
    top: 6px;
    left: 5px;
    padding: 2px 6px;
    background: #008001; /* Green */
    border-radius: 3px;
    font-size: 9px;
    color: #fff;
    line-height: 1;
    text-transform: uppercase;
    pointer-events: none;
    z-index: 2;
  }

  /* ——— VIEW ALL BAR ——— */
  .view-all-bar {
    margin-top: 25px;
    text-align: center;
  }
  .view-all-btn {
    display: inline-block;
    padding: 10px 100px;
    color: #000;
    border: 1px solid #1F1F1D;
    border-radius: 0px;
    cursor: pointer;
    text-decoration: none;
    transition: background-color 0.3s, color 0.3s;
    min-width: 57px;
  }
  .view-all-btn:hover {
    background: #fff8f3;
    color: #c36a4e;
    box-shadow: 0 4px 18px 0 rgba(195,106,78,0.21);
    border: 1.5px solid #c36a4e;
    transform: scale(1.04) translateY(-3px);
  }

  /* ——— LOADING STATE ——— */
  .pill-loading {
    width: 100%;
    text-align: center;
    padding: 50px;
    color: #888;
    font-size: 14px;
  }

  /* ——— RESPONSIVE ——— */
  @media (max-width: 768px) {
    .toggle-buttons-wrapper {
      flex-wrap: nowrap;
      overflow-x: auto;
      justify-content: flex-start;
      padding: 0 10px;
      margin-bottom: 15px;
      scrollbar-width: none; 
    }
    .toggle-buttons-wrapper::-webkit-scrollbar { display: none; }
    
    .toggle-button { flex: 0 0 auto; }
    .toggle-buttons-wrapper .toggle-button:first-of-type { margin-left: 10px; }
    
    .menu-item { flex: 0 0 calc(34% - 12px); padding-bottom: 5px;
    } /* Smaller on mobile per ref */
    .menu-items-container { gap: 6px; justify-content: center; padding: 0 4px;}
    .menu-item p { font-size: 10px;    line-height: 0.9rem; }
    
    .view-all-btn { width: 39%;
    box-sizing: border-box;
    padding: 8px 0; }
  }
{% endstyle %}

<div class="toggle-menu-container">
  
  <div class="toggle-buttons-wrapper">
    {% for block in section.blocks %}
      <button class="toggle-button {% if forloop.first %}active{% endif %} {% if block.settings.show_red_dot %}badged{% endif %}" 
              data-index="{{ forloop.index0 }}"
              onclick="handlePillSwitch({{ forloop.index0 }})">
        {{ block.settings.title }}
        {% if block.settings.show_red_dot %}
          <span class="toggle-badge-dot"></span>
        {% endif %}
      </button>
    {% endfor %}
  </div>

  <div id="pill-grid-{{ section.id }}" class="menu-items-container">
    </div>

  <div class="view-all-bar">
    <a id="pill-view-all-{{ section.id }}" class="view-all-btn" href="#">VIEW ALL &rarr;</a>
  </div>

</div>

<script>
  (function(){
    const sectionId = "{{ section.id }}";

    // 1. Gather Configuration from Liquid
    const pills = [
      {% for block in section.blocks %}
        {
          index: {{ forloop.index0 }},
          tagsRaw: "{{ block.settings.tags | escape }}",
          link: "{{ block.settings.link }}",
          showAll: {{ block.settings.show_all | json }},
          showGender: {{ block.settings.show_gender | json }}, 
          showColor: {{ block.settings.show_color | json }}   
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    let itemsCache = {}; // Simple cache to prevent re-fetching

    // 2. Fetch Logic
    async function fetchPillProducts(pillData) {
      const cacheKey = pillData.tagsRaw;
      if (itemsCache[cacheKey]) return itemsCache[cacheKey]; 

      // ——— PARSE TAGS: Format "Tag:Badge:Bg:Color" ———
      const tagEntries = pillData.tagsRaw.split(',').map(entry => {
          const parts = entry.split(':');
          return {
              tag: parts[0].trim(),
              badgeText: parts[1] ? parts[1].trim() : null,
              badgeBg: parts[2] ? parts[2].trim() : '#008001', // Default Green
              badgeColor: parts[3] ? parts[3].trim() : '#ffffff' // Default White
          };
      }).filter(item => item.tag !== '');

      if (tagEntries.length === 0) return [];

      // Build Multi-Query
      let queryParts = [];
      tagEntries.forEach((entry, index) => {
        queryParts.push(`
          t${index}: products(first: 30, query: "tag:'${entry.tag}'") {
            edges {
              node {
                title
                handle
                onlineStoreUrl
                tags
                variantName: metafield(namespace: "custom", key: "product_variant_name") { value }
                images(first: 1) { edges { node { url, altText } } }
                variants(first: 25) {
                  edges {
                    node {
                      quantityAvailable
                    }
                  }
                }
              }
            }
          }
        `);
      });

      const fullQuery = `{ ${queryParts.join('\n')} }`;

      try {
        const response = await fetch("https://saadaa-design.myshopify.com/api/2024-07/graphql.json", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json", 
            "X-Shopify-Storefront-Access-Token": "388bd37219d8ab7daee1c58a23c03cc8" 
          },
          body: JSON.stringify({ query: fullQuery })
        });

        const json = await response.json();
        if (json.errors || !json.data) return [];

        let finalProducts = [];
        let usedHandles = new Set();
        let usedColors = new Set();

        // Iterate through each tag group
        tagEntries.forEach((entry, index) => {
          const aliasKey = `t${index}`;
          const edges = json.data[aliasKey]?.edges || [];
          
          if(edges.length > 0) {
            // Sort by Total Inventory
            const candidates = edges.map(e => e.node).sort((a, b) => {
               const stockA = a.variants.edges.reduce((sum, v) => sum + (v.node.quantityAvailable || 0), 0);
               const stockB = b.variants.edges.reduce((sum, v) => sum + (v.node.quantityAvailable || 0), 0);
               return stockB - stockA; 
            });

            if (pillData.showAll) {
              // Show All Unique Products
              for (let p of candidates) {
                 if (usedHandles.has(p.handle)) continue;
                 usedHandles.add(p.handle);
                 // Pass full entry config (contains text & colors)
                 finalProducts.push(normalize(p, pillData, entry));
              }
            } else {
              // Single Best Product
              let winner = null;
              for (let p of candidates) {
                 const color = p.variantName?.value || "Unknown";
                 if (usedHandles.has(p.handle)) continue;
                 
                 if (!usedColors.has(color)) {
                    winner = p; 
                    break;
                 }
              }
              if (!winner) {
                 winner = candidates.find(c => !usedHandles.has(c.handle));
              }

              if (winner) {
                 usedHandles.add(winner.handle);
                 if (winner.variantName?.value) usedColors.add(winner.variantName.value);
                 // Pass full entry config (contains text & colors)
                 finalProducts.push(normalize(winner, pillData, entry));
              }
            }
          }
        });

        itemsCache[cacheKey] = finalProducts.slice(0, 15); 
        return itemsCache[cacheKey];

      } catch (err) {
        console.error("Fetch error:", err);
        return [];
      }
    }

    // 3. Normalize & Clean Data
    function normalize(p, pillData, badgeConfig) {
      let displayTitle = p.title;

      // Clean Gender (Women, Men, Unisex)
      if (!pillData.showGender) {
        displayTitle = displayTitle.replace(/\b(Women['’]?s?|Men['’]?s?|Unisex['’]?s?|Women|Men|Unisex)\b/gi, "").trim();
      }
      
      // Clean Color
      if (!pillData.showColor && p.variantName?.value) {
         const re = new RegExp(`\\b${p.variantName.value}\\b`, 'gi');
         displayTitle = displayTitle.replace(re, "");
      }
      displayTitle = displayTitle.replace(/\s+/g, ' ').trim();

      return {
        title: displayTitle,
        link: p.onlineStoreUrl || `https://saadaa.in/products/${p.handle}`,
        image: p.images.edges[0]?.node?.url || "",
        alt: p.images.edges[0]?.node?.altText || displayTitle,
        badgeText: badgeConfig.badgeText,
        badgeBg: badgeConfig.badgeBg,       // Custom BG
        badgeColor: badgeConfig.badgeColor  // Custom Text Color
      };
    }

    // 4. Render HTML
    function render(products) {
      const container = document.getElementById(`pill-grid-${sectionId}`);
      
      if(products.length === 0) {
        container.innerHTML = '<div class="pill-loading">No products found.</div>';
        return;
      }

      container.innerHTML = products.map(item => `
        <div class="menu-item">
          <a href="${item.link}">
            ${item.badgeText ? `<span class="product-badge-pill" style="background-color: ${item.badgeBg}; color: ${item.badgeColor};">${item.badgeText}</span>` : ''}
            <img src="${item.image}" alt="${item.alt}" loading="lazy" />
            <p>${item.title}</p>
          </a>
        </div>
      `).join('');
    }

    // 5. Interaction Handler
    window.handlePillSwitch = async function(index) {
      const pillData = pills[index];
      const container = document.getElementById(`pill-grid-${sectionId}`);
      const viewAllBtn = document.getElementById(`pill-view-all-${sectionId}`);
      const btns = document.querySelectorAll(`#shopify-section-${sectionId} .toggle-button`);

      btns.forEach(b => b.classList.remove('active'));
      btns[index].classList.add('active');
      viewAllBtn.href = pillData.link || '#';

      container.innerHTML = '<div class="pill-loading">Loading...</div>';

      const products = await fetchPillProducts(pillData);
      render(products);
    };

    // 6. Init
    if(pills.length > 0) {
      handlePillSwitch(0);
    }

  })();
</script>
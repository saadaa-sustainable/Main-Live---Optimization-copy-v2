{% schema %}
{
  "name": "Happening Now",
  "settings": [
    { "type": "text", "id": "heading", "label": "Section Heading", "default": "Happening NOW!" },
    { "type": "color", "id": "section_bg", "label": "Section Background Color", "default": "#ffffff" },
    { "type": "text", "id": "badge_text", "label": "Badge Text", "default": "NEW LAUNCH!" },
    { "type": "color", "id": "badge_bg", "label": "Badge Background Color", "default": "#a18262" },
    { "type": "color", "id": "badge_text_color", "label": "Badge Text Color", "default": "#ffffff" }
  ],
  "blocks": [
    {
      "type": "banner",
      "name": "Banner Block",
      "settings": [
        {
          "type": "select",
          "id": "gender",
          "label": "Gender Category",
          "options": [
            { "value": "women", "label": "Women" },
            { "value": "men", "label": "Men" }
          ],
          "default": "women"
        },
        { "type": "image_picker", "id": "banner_image", "label": "Banner Image" },
        {
          "type": "textarea",
          "id": "tags",
          "label": "Product Tags (Comma Separated)",
          "info": "Enter tags for THIS banner. One product will be shown per tag (highest inventory, unique color). E.g: 'SDCP, SDCSP, SDELPT'",
          "default": "SDCP, SDCSP"
        },
        { "type": "url", "id": "link", "label": "Banner Link (optional)" }
      ]
    }
  ],
  "presets": [
    { "name": "Happening Now", "blocks": [ { "type": "banner" }, { "type": "banner" } ] }
  ]
}
{% endschema %}

{% style %}
  #shopify-section-{{ section.id }} {
    --hn-badge-bg: {{ section.settings.badge_bg }};
    --hn-badge-text: {{ section.settings.badge_text_color }};
    background-color: {{ section.settings.section_bg }};
  }

  /* Added a wrapper for full-width background styling & padding */
  .hn-main-wrapper {
    padding: 20px 0;
  }

  .hn-container {
    max-width: 1200px;
    margin: 0px auto;
    padding: 0 20px;
  }

  /* ——— HEADER ——— */
  .hn-header { text-align: center; margin-bottom: 20px; }
  .hn-heading { font-size: 26px; font-weight: 500; color: #111; margin: 0; }
  @media(max-width: 768px) { .hn-heading { font-size: 22px; } }

  /* ——— BANNER CAROUSEL ——— */
  .hn-banner-shell { position: relative; margin-bottom: 18px; }

  .hn-banner-track {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    scroll-behavior: smooth;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;
    padding-bottom: 12px;
  }
  .hn-banner-track::-webkit-scrollbar { display: none; }

  .hn-banner-slide {
    flex: 0 0 100%;
    scroll-snap-align: start;
    border-radius: 4px;
    overflow: hidden;
    background: #f4f4f4;
    position: relative;
  }
  .hn-banner-slide img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: cover;
  }

  /* Banner arrows (desktop only) */
  .hn-nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.10);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 5;
    transition: all 0.2s ease;
    opacity: 0;
    pointer-events: none;
  }
  .hn-nav-btn.is-visible { opacity: 1; pointer-events: auto; }
  .hn-nav-btn:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); background: #f9f9f9; }
  .hn-nav-prev { left: -15px; }
  .hn-nav-next { right: -15px; }

  @media(max-width: 768px) {
    .hn-nav-btn { display: none !important; }
  }

  /* Banner progress (real fill) */
  .hn-progress-wrap {
    display: flex;
    justify-content: center;
    margin-top: 6px;
  }
  .hn-progress-container {
    width: 220px;
    height: 4px;
    background: rgba(0,0,0,0.10);
    border-radius: 999px;
    overflow: hidden;
  }
  .hn-progress-bar {
    height: 100%;
    width: 12%;
    background: #000;
    border-radius: 999px;
    transition: width 0.12s ease-out;
  }

  /* ——— PRODUCT CAROUSEL ——— */
  .hn-carousel-shell { position: relative; }

  .hn-carousel {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding-bottom: 10px;
    scroll-behavior: smooth;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
  }
  .hn-carousel::-webkit-scrollbar { display: none; }

  .hn-prod-prev { left: -15px; top: 40%; }
  .hn-prod-next { right: -15px; top: 40%; }

  /* Product progress */
  .hn-prod-progress-wrap {
    display: none;
    justify-content: center;
    margin-top: 8px;
  }
  .hn-prod-progress-wrap.is-visible { display: flex; }
  .hn-prod-progress-container {
    width: 220px;
    height: 4px;
    background: rgba(0,0,0,0.10);
    border-radius: 999px;
    overflow: hidden;
  }
  .hn-prod-progress-bar {
    height: 100%;
    width: 12%;
    background: #000;
    border-radius: 999px;
    transition: width 0.12s ease-out;
  }

  /* ——— PRODUCT CARD ——— */
  .hn-card {
    flex: 0 0 260px;
    display: flex;
    flex-direction: column;
    text-decoration: none;
    color: inherit;
    position: relative;
  }
  @media(max-width: 768px) { .hn-card { flex: 0 0 180px; } }

  .hn-image-wrap {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 12px;
    background-color: #f4f4f4;
  }
  .hn-image-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; }

  .hn-badge {
    position: absolute;
    top: 7px;
    left: 6px;
    background-color: var(--hn-badge-bg);
    color: var(--hn-badge-text);
    font-size: 7.5px;
    font-weight: 600;
    text-transform: uppercase;
    padding: 2px 4px;
    border-radius: 5px;
    z-index: 2;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  .hn-info { padding: 0 4px; }
  .hn-title {
    font-size: 13px;
    color: #222;
    margin-bottom: 6px;
    line-height: 1.2;
  }
  .hn-price-row { display: flex; align-items: baseline; gap: 8px; font-size: 15px; display:none;}
  .hn-compare-at { color: #ff5a5a; text-decoration: line-through; font-size: 13px; }
  .hn-price { font-weight: 700; color: #000; }

  .hn-loading { width: 100%; text-align: center; padding: 30px; color: #666; font-size: 14px; }
 @media(min-width: 768px){

  .hn-carousel {
  justify-content: center !important;
  }
}
{% endstyle %}

<div class="hn-main-wrapper">
  <div class="hn-container" id="hn-section-{{ section.id }}">
    <div class="hn-header">
      <h2 class="hn-heading">{{ section.settings.heading }}</h2>
    </div>

    {% assign has_banners = section.blocks | size %}
    {% if has_banners > 0 %}
      <div class="hn-banner-shell">
        <button class="hn-nav-btn hn-nav-prev" id="hn-banner-prev-{{ section.id }}" aria-label="Previous banner">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>

        <div class="hn-banner-track" id="hn-banner-track-{{ section.id }}">
          {% for block in section.blocks %}
            {% if block.type == 'banner' and block.settings.banner_image != blank %}
              <a class="hn-banner-slide"
                 href="{% if block.settings.link != blank %}{{ block.settings.link }}{% else %}#{% endif %}"
                 data-block-id="{{ block.id }}"
                 data-gender="{{ block.settings.gender | downcase }}"
                 data-tags="{{ block.settings.tags | escape }}"
                 aria-label="Banner {{ forloop.index }}">
                <img src="{{ block.settings.banner_image | image_url: width: 1400 }}" alt="{{ section.settings.heading }}" loading="lazy">
              </a>
            {% endif %}
          {% endfor %}
        </div>

        <button class="hn-nav-btn hn-nav-next" id="hn-banner-next-{{ section.id }}" aria-label="Next banner">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>

        <div class="hn-progress-wrap">
          <div class="hn-progress-container" aria-hidden="true">
            <div class="hn-progress-bar" id="hn-banner-bar-{{ section.id }}"></div>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="hn-carousel-shell">
      <button class="hn-nav-btn hn-nav-prev hn-prod-prev" id="hn-prod-prev-{{ section.id }}" aria-label="Previous products">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>

      <div class="hn-carousel" id="hn-track-{{ section.id }}"></div>

      <button class="hn-nav-btn hn-nav-next hn-prod-next" id="hn-prod-next-{{ section.id }}" aria-label="Next products">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
      </button>

      <div class="hn-prod-progress-wrap" id="hn-prod-progress-wrap-{{ section.id }}">
        <div class="hn-prod-progress-container" aria-hidden="true">
          <div class="hn-prod-progress-bar" id="hn-prod-bar-{{ section.id }}"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const sectionId = "{{ section.id }}";
    const inr = new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 });
    const badgeText = "{{ section.settings.badge_text | escape }}";

    const bannerTrack = document.getElementById(`hn-banner-track-${sectionId}`);
    const bannerBar = document.getElementById(`hn-banner-bar-${sectionId}`);
    const bannerPrev = document.getElementById(`hn-banner-prev-${sectionId}`);
    const bannerNext = document.getElementById(`hn-banner-next-${sectionId}`);

    const prodTrack = document.getElementById(`hn-track-${sectionId}`);
    const prodPrev = document.getElementById(`hn-prod-prev-${sectionId}`);
    const prodNext = document.getElementById(`hn-prod-next-${sectionId}`);
    const prodBar = document.getElementById(`hn-prod-bar-${sectionId}`);
    const prodBarWrap = document.getElementById(`hn-prod-progress-wrap-${sectionId}`);

    let cacheByBlock = {}; // { blockId: products[] }
    let currentBlockId = null;
    let bannerSnapTimer = null;

    // ✅ Gender state (connected to global toggle)
    let currentGender = (window.currentGlobalGender || 'women').toLowerCase();

    // ---------------------------
    // Helpers
    // ---------------------------
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function updateFillBar(track, bar) {
      if (!track || !bar) return;
      const maxScroll = track.scrollWidth - track.clientWidth;
      if (maxScroll <= 0) { bar.style.width = '12%'; return; }
      const pct = (track.scrollLeft / maxScroll) * 100;
      bar.style.width = `${clamp(pct, 12, 100)}%`;
    }

    function updateArrowVisibility(track, prevBtn, nextBtn) {
      if (!track || !prevBtn || !nextBtn) return;

      const isScrollable = track.scrollWidth > track.clientWidth + 5;
      if (!isScrollable) {
        prevBtn.classList.remove('is-visible');
        nextBtn.classList.remove('is-visible');
        return;
      }

      const atStart = track.scrollLeft <= 10;
      const atEnd = track.scrollLeft >= (track.scrollWidth - track.clientWidth - 10);

      prevBtn.classList.toggle('is-visible', !atStart);
      nextBtn.classList.toggle('is-visible', !atEnd);
    }

    // ✅ Only for desktop: show arrows only if more than 6 products
    function setProductArrowGate(productsCount) {
      const isDesktop = window.matchMedia('(min-width: 769px)').matches;
      const shouldShowArrows = isDesktop && productsCount > 6;

      if (prodPrev) prodPrev.style.display = shouldShowArrows ? '' : 'none';
      if (prodNext) prodNext.style.display = shouldShowArrows ? '' : 'none';

      // Also reset visibility classes when gated off
      if (!shouldShowArrows) {
        if (prodPrev) prodPrev.classList.remove('is-visible');
        if (prodNext) prodNext.classList.remove('is-visible');
      }
      return shouldShowArrows;
    }

    function getVisibleSlides() {
      if (!bannerTrack) return [];
      return Array.from(bannerTrack.querySelectorAll('.hn-banner-slide'))
        .filter(el => (el.getAttribute('data-gender') || 'women') === currentGender);
    }

    function rebuildBannerForGender() {
      if (!bannerTrack) return;

      const allSlides = Array.from(bannerTrack.querySelectorAll('.hn-banner-slide'));

      allSlides.forEach(el => {
        const g = (el.getAttribute('data-gender') || 'women');
        el.style.display = (g === currentGender) ? '' : 'none';
      });

      const visibleSlides = getVisibleSlides();
      if (visibleSlides.length) {
        // Reset scroll position horizontally only
        bannerTrack.scrollLeft = 0;
        
        // REMOVED: visibleSlides[0].scrollIntoView(...) to prevent page jumping

        const first = visibleSlides[0];
        const meta = {
          id: first.getAttribute('data-block-id'),
          tagsRaw: (first.getAttribute('data-tags') || '').trim()
        };
        if (meta.id) loadProductsForBlock(meta.id, meta.tagsRaw);
      } else {
        if (prodTrack) prodTrack.innerHTML = '<div class="hn-loading">No banners configured for this gender.</div>';
      }

      setTimeout(() => {
        updateFillBar(bannerTrack, bannerBar);
        updateArrowVisibility(bannerTrack, bannerPrev, bannerNext);
      }, 50);
    }

    function nearestSlideIndex() {
      const slides = getVisibleSlides();
      if (!slides.length) return 0;

      const trackLeft = bannerTrack.getBoundingClientRect().left;
      let bestIdx = 0;
      let bestDist = Infinity;

      slides.forEach((el, idx) => {
        const r = el.getBoundingClientRect();
        const dist = Math.abs(r.left - trackLeft);
        if (dist < bestDist) { bestDist = dist; bestIdx = idx; }
      });

      return bestIdx;
    }

    function scrollBannerToIndex(idx) {
      const slides = getVisibleSlides();
      const el = slides[idx];
      if (!el) return;
      el.scrollIntoView({ behavior: 'smooth', inline: 'start', block: 'nearest' });
    }

    function getActiveBannerMeta() {
      const slides = getVisibleSlides();
      if (!slides.length) return null;
      const idx = nearestSlideIndex();
      const el = slides[idx];
      return {
        id: el.getAttribute('data-block-id'),
        tagsRaw: (el.getAttribute('data-tags') || '').trim()
      };
    }

    // ---------------------------
    // Products
    // ---------------------------
    async function loadProductsForBlock(blockId, tagsRaw) {
      if (!prodTrack) return;

      currentBlockId = blockId;

      prodTrack.scrollLeft = 0;
      if (prodBar) prodBar.style.width = '12%';
      if (prodBarWrap) prodBarWrap.classList.remove('is-visible');

      if (!tagsRaw) {
        prodTrack.innerHTML = '<div class="hn-loading">No tags configured.</div>';
        if (prodPrev) prodPrev.classList.remove('is-visible');
        if (prodNext) prodNext.classList.remove('is-visible');
        return;
      }

      if (cacheByBlock[blockId]) {
        renderProducts(prodTrack, cacheByBlock[blockId]);
        postRenderProducts();
        return;
      }

      prodTrack.innerHTML = '<div class="hn-loading">Loading new launches...</div>';

      const tagsList = tagsRaw.split(',').map(t => t.trim()).filter(Boolean);
      const products = await fetchProductsMulti(tagsList);
      cacheByBlock[blockId] = products;

      if (!products.length) {
        prodTrack.innerHTML = '<div class="hn-loading">No products found.</div>';
        if (prodPrev) prodPrev.classList.remove('is-visible');
        if (prodNext) prodNext.classList.remove('is-visible');
        if (prodBarWrap) prodBarWrap.classList.remove('is-visible');
        return;
      }

      renderProducts(prodTrack, products);
      postRenderProducts();
    }

    function postRenderProducts() {
      const cards = prodTrack.querySelectorAll('.hn-card');
      const count = cards.length;

      // ✅ Progress bar visible only if > 5
      const showProgress = count > 5;
      if (prodBarWrap) prodBarWrap.classList.toggle('is-visible', showProgress);
      if (showProgress) updateFillBar(prodTrack, prodBar);

      // ✅ Desktop arrows visible only if > 6
      const arrowsAllowed = setProductArrowGate(count);
      if (arrowsAllowed) {
        updateArrowVisibility(prodTrack, prodPrev, prodNext);
      }

      // If arrows are gated off, ensure they don't interfere
      if (!arrowsAllowed) {
        if (prodPrev) prodPrev.classList.remove('is-visible');
        if (prodNext) prodNext.classList.remove('is-visible');
      }
    }

    function renderProducts(track, products) {
      track.innerHTML = products.map(p => `
        <a class="hn-card" href="${p.link}">
          <div class="hn-image-wrap">
            ${badgeText ? `<div class="hn-badge">${badgeText}</div>` : ``}
            <img src="${p.image}" alt="${p.title}" loading="lazy">
          </div>
          <div class="hn-info">
            <div class="hn-title">${p.title}</div>
            <div class="hn-price-row">
              <span class="hn-price">Rs ${inr.format(p.price)}</span>
              <span class="hn-compare-at">Rs ${inr.format(p.compare)}</span>
            </div>
          </div>
        </a>
      `).join('');
    }

    async function fetchProductsMulti(tags) {
      let queryParts = [];
      tags.forEach((tag, index) => {
        queryParts.push(`
          t${index}: products(first: 10, query: "tag:'${tag}'") {
            edges {
              node {
                title
                handle
                onlineStoreUrl
                totalInventory
                variantName: metafield(namespace: "custom", key: "product_variant_name") { value }
                images(first: 1) { edges { node { url } } }
                variants(first: 25) {
                  edges {
                    node {
                      price { amount }
                      compareAtPrice { amount }
                      selectedOptions { name value }
                      quantityAvailable
                    }
                  }
                }
              }
            }
          }
        `);
      });

      const fullQuery = `{ ${queryParts.join('\n')} }`;

      try {
        const response = await fetch("https://saadaa-design.myshopify.com/api/2024-07/graphql.json", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Shopify-Storefront-Access-Token": "388bd37219d8ab7daee1c58a23c03cc8"
          },
          body: JSON.stringify({ query: fullQuery })
        });

        const json = await response.json();
        if (json.errors || !json.data) return [];

        let finalProducts = [];
        let usedHandles = new Set();
        let usedColors = new Set();

        tags.forEach((tag, index) => {
          const aliasKey = `t${index}`;
          const edges = json.data[aliasKey]?.edges || [];

          if (edges.length > 0) {
            const getVariantStock = (p) =>
              p.variants.edges.reduce((sum, v) => sum + (v.node.quantityAvailable || 0), 0);

            const candidates = edges.map(e => e.node).sort((a, b) => getVariantStock(b) - getVariantStock(a));

            let winner = null;
            for (let c of candidates) {
              const h = c.handle;
              const col = c.variantName?.value || "Unknown";
              if (usedHandles.has(h)) continue;
              if (usedColors.has(col)) continue;
              winner = c;
              break;
            }

            if (!winner) {
              winner = candidates.find(c => !usedHandles.has(c.handle));
            }

            if (winner) {
              usedHandles.add(winner.handle);
              if (winner.variantName?.value) usedColors.add(winner.variantName.value);
              finalProducts.push(normalizeProduct(winner));
            }
          }
        });

        return finalProducts;
      } catch (err) {
        console.error("Fetch error", err);
        return [];
      }
    }

    function normalizeProduct(p) {
      const variants = p.variants.edges.map(e => e.node);
      const firstVariant = variants[0];

      let displayTitle = p.title;
      if (p.variantName?.value) {
        const re = new RegExp(`\\b${p.variantName.value}\\b`, 'gi');
        displayTitle = displayTitle.replace(re, "");
      }
      displayTitle = displayTitle.replace(/\s+/g, ' ').trim();

      const backendPrice = parseFloat(firstVariant?.price?.amount || 0);

      return {
        title: displayTitle,
        link: p.onlineStoreUrl || `https://saadaa.in/products/${p.handle}`,
        image: p.images.edges[0]?.node?.url || "",
        price: backendPrice,
        compare: backendPrice * 2
      };
    }

    // ---------------------------
    // Banner interactions
    // ---------------------------
    function bindBanner() {
      if (!bannerTrack) return;

      if (bannerPrev && bannerNext) {
        bannerPrev.onclick = () => {
          const idx = nearestSlideIndex();
          scrollBannerToIndex(Math.max(0, idx - 1));
        };
        bannerNext.onclick = () => {
          const slides = getVisibleSlides();
          const idx = nearestSlideIndex();
          scrollBannerToIndex(Math.min(slides.length - 1, idx + 1));
        };
      }

      bannerTrack.addEventListener('scroll', () => {
        updateFillBar(bannerTrack, bannerBar);
        updateArrowVisibility(bannerTrack, bannerPrev, bannerNext);

        clearTimeout(bannerSnapTimer);
        bannerSnapTimer = setTimeout(() => {
          const meta = getActiveBannerMeta();
          if (!meta) return;
          if (meta.id !== currentBlockId) {
            loadProductsForBlock(meta.id, meta.tagsRaw);
          }
        }, 120);
      }, { passive: true });

      window.addEventListener('resize', () => {
        updateFillBar(bannerTrack, bannerBar);
        updateArrowVisibility(bannerTrack, bannerPrev, bannerNext);

        // re-gate arrows on resize for products
        if (prodTrack) {
          const count = prodTrack.querySelectorAll('.hn-card').length;
          const arrowsAllowed = setProductArrowGate(count);
          if (arrowsAllowed) updateArrowVisibility(prodTrack, prodPrev, prodNext);
        }
      });

      setTimeout(() => {
        rebuildBannerForGender();
      }, 60);
    }

    // ---------------------------
    // Product interactions
    // ---------------------------
    function bindProducts() {
      if (!prodTrack) return;

      if (prodPrev && prodNext) {
        prodPrev.onclick = () => {
          prodTrack.scrollBy({ left: -320, behavior: 'smooth' });
          setTimeout(() => updateArrowVisibility(prodTrack, prodPrev, prodNext), 250);
        };
        prodNext.onclick = () => {
          prodTrack.scrollBy({ left: 320, behavior: 'smooth' });
          setTimeout(() => updateArrowVisibility(prodTrack, prodPrev, prodNext), 250);
        };
      }

      prodTrack.addEventListener('scroll', () => {
        // only update arrows if they are allowed+visible in layout
        if (prodPrev && prodPrev.style.display !== 'none') {
          updateArrowVisibility(prodTrack, prodPrev, prodNext);
        }
        if (prodBarWrap && prodBarWrap.classList.contains('is-visible')) {
          updateFillBar(prodTrack, prodBar);
        }
      }, { passive: true });
    }

    // ✅ Listen to global gender toggle event
    window.addEventListener('moodGenderChanged', (e) => {
      currentGender = (e.detail.gender || 'women').toLowerCase();
      rebuildBannerForGender();
    });

    function init() {
      if (!bannerTrack) {
        if (prodTrack) prodTrack.innerHTML = '<div class="hn-loading">No banners configured.</div>';
        return;
      }
      bindBanner();
      bindProducts();
    }

    init();
  })();
</script>